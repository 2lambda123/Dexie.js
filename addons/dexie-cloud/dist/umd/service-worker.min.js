!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(require("dexie"),require("rxjs")):"function"==typeof define&&define.amd?define(["dexie","rxjs"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).Dexie,e.rxjs)}(this,(function(e,t){"use strict";function n(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var r=n(e);const o={userId:"unauthorized",name:"Unauthorized",claims:{sub:"unauthorized"},lastLogin:new Date(0)};try{Object.freeze(o),Object.freeze(o.claims)}catch(e){}const i={},s=self.document&&navigator.serviceWorker;s&&s.ready.then((e=>i.registration=e)),"undefined"!=typeof self&&"clients"in self&&!self.document&&addEventListener("message",(e=>{var t,n;(null===(n=null===(t=e.data)||void 0===t?void 0:t.type)||void 0===n?void 0:n.startsWith("sw-broadcast-"))&&[...self.clients.matchAll({includeUncontrolled:!0})].forEach((t=>{var n;return t.id!==(null===(n=e.source)||void 0===n?void 0:n.id)&&t.postMessage(e.data)}))}));class a{constructor(e){this.name=e}subscribe(e){if(!s)return()=>{};const t=t=>{var n;(null===(n=t.data)||void 0===n?void 0:n.type)===`sw-broadcast-${this.name}`&&e(t.data.message)};return s.addEventListener("message",t),()=>s.removeEventListener("message",t)}postMessage(e){var t;"object"==typeof self.clients?[...self.clients.matchAll({includeUncontrolled:!0})].forEach((t=>t.postMessage({type:`sw-broadcast-${this.name}`,message:e}))):i.registration&&(null===(t=i.registration.active)||void 0===t||t.postMessage({type:`sw-broadcast-${this.name}`,message:e}))}}class c extends t.Observable{constructor(e){const t="undefined"==typeof BroadcastChannel?new a(e):new BroadcastChannel(e);super((n=>{function r(e){n.next(e.detail)}function o(e){console.debug("BroadcastedAndLocalEvent: onMessageEvent",e),n.next(e.data)}let i;return self.addEventListener(`lbc-${e}`,r),t instanceof a?i=t.subscribe((e=>n.next(e))):(console.debug("BroadcastedAndLocalEvent: bc.addEventListener()",e,"bc is a",t),t.addEventListener("message",o)),()=>{self.removeEventListener(`lbc-${e}`,r),t instanceof a?i():t.removeEventListener("message",o)}})),this.name=e,this.bc=t}next(e){console.debug("BroadcastedAndLocalEvent: bc.postMessage()",{...e},"bc is a",this.bc),this.bc.postMessage(e);const t=new CustomEvent(`lbc-${this.name}`,{detail:e});self.dispatchEvent(t)}}const u=new WeakMap,l={realms:"@realmId",members:"@id",roles:"[realmId+name]",$jobs:"",$syncState:"",$baseRevs:"[tableName+clientRev]",$logins:"claims.sub, lastLogin"};let d=0;function f(e){"vip"in e&&(e=e.vip);let n=u.get(e.cloud);if(!n){const r=new t.BehaviorSubject({});let i=new c(`syncstatechanged-${e.name}`);r.id=++d;let s=!1;n={get name(){return e.name},close:()=>e.close(),transaction:e.transaction.bind(e),table:e.table.bind(e),get tables(){return e.tables},cloud:e.cloud,get $jobs(){return e.table("$jobs")},get $syncState(){return e.table("$syncState")},get $baseRevs(){return e.table("$baseRevs")},get $logins(){return e.table("$logins")},get realms(){return e.realms},get members(){return e.members},get roles(){return e.roles},get initiallySynced(){return s},localSyncEvent:r,get syncStateChangedEvent(){return i},dx:e};const a={getCurrentUser:()=>n.$logins.toArray().then((e=>e.find((e=>e.isLoggedIn))||o)),getPersistedSyncState:()=>n.$syncState.get("syncState"),getSchema:()=>n.$syncState.get("schema"),getOptions:()=>n.$syncState.get("options"),setInitiallySynced(e){s=e},reconfigure(){i=new c(`syncstatechanged-${e.name}`)}};Object.assign(n,a),u.set(e.cloud,n)}return n}const h=crypto.getRandomValues;function p(e,t,n){if(e&&void 0!==t&&(!("isFrozen"in Object)||!Object.isFrozen(e)))if("string"!=typeof t&&"length"in t){!function(e){if(!e)throw new Error("Assertion Failed")}("string"!=typeof n&&"length"in n);for(var r=0,o=t.length;r<o;++r)p(e,t[r],n[r])}else{var i=t.indexOf(".");if(-1!==i){var s=t.substr(0,i),a=t.substr(i+1);if(""===a)void 0===n?Array.isArray(e)?isNaN(parseInt(s))||e.splice(parseInt(s),1):delete e[s]:e[s]=n;else{var c=e[s];c||(c=e[s]={}),p(c,a,n)}}else void 0===n?Array.isArray(e)&&!isNaN(parseInt(t))?e.splice(t,1):delete e[t]:e[t]=n}}const y="undefined"==typeof self?e=>{const t=Buffer.alloc(e);return h(t),t.toString("base64")}:e=>{const t=new Uint8Array(e);return crypto.getRandomValues(t),btoa(String.fromCharCode.apply(null,t))};function b(e){return"string"==typeof e||!!(Array.isArray(e)&&e.some((e=>b(e)))&&e.every(v))}function v(e){return"string"==typeof e||"number"==typeof e||Array.isArray(e)&&e.every(v)}function m(e,t,n){const r=e[t]||(e[t]={});switch(n.type){case"insert":case"upsert":n.keys.forEach(((e,t)=>{r[e]={type:"ups",val:n.values[t]}}));break;case"update":case"modify":n.keys.forEach(((e,t)=>{const o="update"===n.type?n.changeSpecs[t]:n.changeSpec,i=r[e];if(i)switch(i.type){case"ups":for(const[e,t]of Object.entries(o))p(i.val,e,t);break;case"del":break;case"upd":Object.assign(i.mod,o)}else r[e]={type:"upd",mod:o}}));break;case"delete":n.keys.forEach((e=>{r[e]={type:"del"}}))}return e}function _(e,t){for(const{table:n,muts:r}of t)for(const t of r)m(e,n,t)}var g=function(e,t){return(g=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(e,t)};function w(e,t){function n(){this.constructor=e}g(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}function S(e){return"function"==typeof e}var k=!1,E={Promise:void 0,set useDeprecatedSynchronousErrorHandling(e){e&&(new Error).stack;k=e},get useDeprecatedSynchronousErrorHandling(){return k}};function x(e){setTimeout((function(){throw e}),0)}var I={closed:!0,next:function(e){},error:function(e){if(E.useDeprecatedSynchronousErrorHandling)throw e;x(e)},complete:function(){}},T=function(){return Array.isArray||function(e){return e&&"number"==typeof e.length}}();function C(e){return null!==e&&"object"==typeof e}var A=function(){function e(e){return Error.call(this),this.message=e?e.length+" errors occurred during unsubscription:\n"+e.map((function(e,t){return t+1+") "+e.toString()})).join("\n  "):"",this.name="UnsubscriptionError",this.errors=e,this}return e.prototype=Object.create(Error.prototype),e}(),O=function(){function e(e){this.closed=!1,this._parentOrParents=null,this._subscriptions=null,e&&(this._ctorUnsubscribe=!0,this._unsubscribe=e)}return e.prototype.unsubscribe=function(){var t;if(!this.closed){var n=this,r=n._parentOrParents,o=n._ctorUnsubscribe,i=n._unsubscribe,s=n._subscriptions;if(this.closed=!0,this._parentOrParents=null,this._subscriptions=null,r instanceof e)r.remove(this);else if(null!==r)for(var a=0;a<r.length;++a){r[a].remove(this)}if(S(i)){o&&(this._unsubscribe=void 0);try{i.call(this)}catch(e){t=e instanceof A?U(e.errors):[e]}}if(T(s)){a=-1;for(var c=s.length;++a<c;){var u=s[a];if(C(u))try{u.unsubscribe()}catch(e){t=t||[],e instanceof A?t=t.concat(U(e.errors)):t.push(e)}}}if(t)throw new A(t)}},e.prototype.add=function(t){var n=t;if(!t)return e.EMPTY;switch(typeof t){case"function":n=new e(t);case"object":if(n===this||n.closed||"function"!=typeof n.unsubscribe)return n;if(this.closed)return n.unsubscribe(),n;if(!(n instanceof e)){var r=n;(n=new e)._subscriptions=[r]}break;default:throw new Error("unrecognized teardown "+t+" added to Subscription.")}var o=n._parentOrParents;if(null===o)n._parentOrParents=this;else if(o instanceof e){if(o===this)return n;n._parentOrParents=[o,this]}else{if(-1!==o.indexOf(this))return n;o.push(this)}var i=this._subscriptions;return null===i?this._subscriptions=[n]:i.push(n),n},e.prototype.remove=function(e){var t=this._subscriptions;if(t){var n=t.indexOf(e);-1!==n&&t.splice(n,1)}},e.EMPTY=function(e){return e.closed=!0,e}(new e),e}();function U(e){return e.reduce((function(e,t){return e.concat(t instanceof A?t.errors:t)}),[])}var P=function(){return"function"==typeof Symbol?Symbol("rxSubscriber"):"@@rxSubscriber_"+Math.random()}(),D=function(e){function t(n,r,o){var i=e.call(this)||this;switch(i.syncErrorValue=null,i.syncErrorThrown=!1,i.syncErrorThrowable=!1,i.isStopped=!1,arguments.length){case 0:i.destination=I;break;case 1:if(!n){i.destination=I;break}if("object"==typeof n){n instanceof t?(i.syncErrorThrowable=n.syncErrorThrowable,i.destination=n,n.add(i)):(i.syncErrorThrowable=!0,i.destination=new $(i,n));break}default:i.syncErrorThrowable=!0,i.destination=new $(i,n,r,o)}return i}return w(t,e),t.prototype[P]=function(){return this},t.create=function(e,n,r){var o=new t(e,n,r);return o.syncErrorThrowable=!1,o},t.prototype.next=function(e){this.isStopped||this._next(e)},t.prototype.error=function(e){this.isStopped||(this.isStopped=!0,this._error(e))},t.prototype.complete=function(){this.isStopped||(this.isStopped=!0,this._complete())},t.prototype.unsubscribe=function(){this.closed||(this.isStopped=!0,e.prototype.unsubscribe.call(this))},t.prototype._next=function(e){this.destination.next(e)},t.prototype._error=function(e){this.destination.error(e),this.unsubscribe()},t.prototype._complete=function(){this.destination.complete(),this.unsubscribe()},t.prototype._unsubscribeAndRecycle=function(){var e=this._parentOrParents;return this._parentOrParents=null,this.unsubscribe(),this.closed=!1,this.isStopped=!1,this._parentOrParents=e,this},t}(O),$=function(e){function t(t,n,r,o){var i,s=e.call(this)||this;s._parentSubscriber=t;var a=s;return S(n)?i=n:n&&(i=n.next,r=n.error,o=n.complete,n!==I&&(S((a=Object.create(n)).unsubscribe)&&s.add(a.unsubscribe.bind(a)),a.unsubscribe=s.unsubscribe.bind(s))),s._context=a,s._next=i,s._error=r,s._complete=o,s}return w(t,e),t.prototype.next=function(e){if(!this.isStopped&&this._next){var t=this._parentSubscriber;E.useDeprecatedSynchronousErrorHandling&&t.syncErrorThrowable?this.__tryOrSetError(t,this._next,e)&&this.unsubscribe():this.__tryOrUnsub(this._next,e)}},t.prototype.error=function(e){if(!this.isStopped){var t=this._parentSubscriber,n=E.useDeprecatedSynchronousErrorHandling;if(this._error)n&&t.syncErrorThrowable?(this.__tryOrSetError(t,this._error,e),this.unsubscribe()):(this.__tryOrUnsub(this._error,e),this.unsubscribe());else if(t.syncErrorThrowable)n?(t.syncErrorValue=e,t.syncErrorThrown=!0):x(e),this.unsubscribe();else{if(this.unsubscribe(),n)throw e;x(e)}}},t.prototype.complete=function(){var e=this;if(!this.isStopped){var t=this._parentSubscriber;if(this._complete){var n=function(){return e._complete.call(e._context)};E.useDeprecatedSynchronousErrorHandling&&t.syncErrorThrowable?(this.__tryOrSetError(t,n),this.unsubscribe()):(this.__tryOrUnsub(n),this.unsubscribe())}else this.unsubscribe()}},t.prototype.__tryOrUnsub=function(e,t){try{e.call(this._context,t)}catch(e){if(this.unsubscribe(),E.useDeprecatedSynchronousErrorHandling)throw e;x(e)}},t.prototype.__tryOrSetError=function(e,t,n){if(!E.useDeprecatedSynchronousErrorHandling)throw new Error("bad call");try{t.call(this._context,n)}catch(t){return E.useDeprecatedSynchronousErrorHandling?(e.syncErrorValue=t,e.syncErrorThrown=!0,!0):(x(t),!0)}return!1},t.prototype._unsubscribe=function(){var e=this._parentSubscriber;this._context=null,this._parentSubscriber=null,e.unsubscribe()},t}(D);var N=function(){return"function"==typeof Symbol&&Symbol.observable||"@@observable"}();function j(e){return e}function L(e){return 0===e.length?j:1===e.length?e[0]:function(t){return e.reduce((function(e,t){return t(e)}),t)}}var R=function(){function e(e){this._isScalar=!1,e&&(this._subscribe=e)}return e.prototype.lift=function(t){var n=new e;return n.source=this,n.operator=t,n},e.prototype.subscribe=function(e,t,n){var r=this.operator,o=function(e,t,n){if(e){if(e instanceof D)return e;if(e[P])return e[P]()}return e||t||n?new D(e,t,n):new D(I)}(e,t,n);if(r?o.add(r.call(o,this.source)):o.add(this.source||E.useDeprecatedSynchronousErrorHandling&&!o.syncErrorThrowable?this._subscribe(o):this._trySubscribe(o)),E.useDeprecatedSynchronousErrorHandling&&o.syncErrorThrowable&&(o.syncErrorThrowable=!1,o.syncErrorThrown))throw o.syncErrorValue;return o},e.prototype._trySubscribe=function(e){try{return this._subscribe(e)}catch(t){E.useDeprecatedSynchronousErrorHandling&&(e.syncErrorThrown=!0,e.syncErrorValue=t),!function(e){for(;e;){var t=e,n=t.closed,r=t.destination,o=t.isStopped;if(n||o)return!1;e=r&&r instanceof D?r:null}return!0}(e)?console.warn(t):e.error(t)}},e.prototype.forEach=function(e,t){var n=this;return new(t=B(t))((function(t,r){var o;o=n.subscribe((function(t){try{e(t)}catch(e){r(e),o&&o.unsubscribe()}}),r,t)}))},e.prototype._subscribe=function(e){var t=this.source;return t&&t.subscribe(e)},e.prototype[N]=function(){return this},e.prototype.pipe=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return 0===e.length?this:L(e)(this)},e.prototype.toPromise=function(e){var t=this;return new(e=B(e))((function(e,n){var r;t.subscribe((function(e){return r=e}),(function(e){return n(e)}),(function(){return e(r)}))}))},e.create=function(t){return new e(t)},e}();function B(e){if(e||(e=Promise),!e)throw new Error("no Promise impl found");return e}var W=function(e){return function(t){for(var n=0,r=e.length;n<r&&!t.closed;n++)t.next(e[n]);t.complete()}};function F(){return"function"==typeof Symbol&&Symbol.iterator?Symbol.iterator:"@@iterator"}var M=F(),H=function(e){return e&&"number"==typeof e.length&&"function"!=typeof e};function K(e){return!!e&&"function"!=typeof e.subscribe&&"function"==typeof e.then}var V=function(e){if(e&&"function"==typeof e[N])return r=e,function(e){var t=r[N]();if("function"!=typeof t.subscribe)throw new TypeError("Provided object does not correctly implement Symbol.observable");return t.subscribe(e)};if(H(e))return W(e);if(K(e))return n=e,function(e){return n.then((function(t){e.closed||(e.next(t),e.complete())}),(function(t){return e.error(t)})).then(null,x),e};if(e&&"function"==typeof e[M])return t=e,function(e){for(var n=t[M]();;){var r=void 0;try{r=n.next()}catch(t){return e.error(t),e}if(r.done){e.complete();break}if(e.next(r.value),e.closed)break}return"function"==typeof n.return&&e.add((function(){n.return&&n.return()})),e};var t,n,r,o=C(e)?"an invalid object":"'"+e+"'";throw new TypeError("You provided "+o+" where a stream was expected. You can provide an Observable, Promise, Array, or Iterable.")},q=function(e){function t(t){var n=e.call(this)||this;return n.parent=t,n}return w(t,e),t.prototype._next=function(e){this.parent.notifyNext(e)},t.prototype._error=function(e){this.parent.notifyError(e),this.unsubscribe()},t.prototype._complete=function(){this.parent.notifyComplete(),this.unsubscribe()},t}(D),z=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return w(t,e),t.prototype.notifyNext=function(e){this.destination.next(e)},t.prototype.notifyError=function(e){this.destination.error(e)},t.prototype.notifyComplete=function(){this.destination.complete()},t}(D);function G(e,t){if(!t.closed){if(e instanceof R)return e.subscribe(t);var n;try{n=V(e)(t)}catch(e){t.error(e)}return n}}var J=function(e){function t(t,n){var r=e.call(this,t,n)||this;return r.scheduler=t,r.work=n,r.pending=!1,r}return w(t,e),t.prototype.schedule=function(e,t){if(void 0===t&&(t=0),this.closed)return this;this.state=e;var n=this.id,r=this.scheduler;return null!=n&&(this.id=this.recycleAsyncId(r,n,t)),this.pending=!0,this.delay=t,this.id=this.id||this.requestAsyncId(r,this.id,t),this},t.prototype.requestAsyncId=function(e,t,n){return void 0===n&&(n=0),setInterval(e.flush.bind(e,this),n)},t.prototype.recycleAsyncId=function(e,t,n){if(void 0===n&&(n=0),null!==n&&this.delay===n&&!1===this.pending)return t;clearInterval(t)},t.prototype.execute=function(e,t){if(this.closed)return new Error("executing a cancelled action");this.pending=!1;var n=this._execute(e,t);if(n)return n;!1===this.pending&&null!=this.id&&(this.id=this.recycleAsyncId(this.scheduler,this.id,null))},t.prototype._execute=function(e,t){var n=!1,r=void 0;try{this.work(e)}catch(e){n=!0,r=!!e&&e||new Error(e)}if(n)return this.unsubscribe(),r},t.prototype._unsubscribe=function(){var e=this.id,t=this.scheduler,n=t.actions,r=n.indexOf(this);this.work=null,this.state=null,this.pending=!1,this.scheduler=null,-1!==r&&n.splice(r,1),null!=e&&(this.id=this.recycleAsyncId(t,e,null)),this.delay=null},t}(function(e){function t(t,n){return e.call(this)||this}return w(t,e),t.prototype.schedule=function(e,t){return this},t}(O)),Y=function(){function e(t,n){void 0===n&&(n=e.now),this.SchedulerAction=t,this.now=n}return e.prototype.schedule=function(e,t,n){return void 0===t&&(t=0),new this.SchedulerAction(this,e).schedule(n,t)},e.now=function(){return Date.now()},e}(),Q=new(function(e){function t(n,r){void 0===r&&(r=Y.now);var o=e.call(this,n,(function(){return t.delegate&&t.delegate!==o?t.delegate.now():r()}))||this;return o.actions=[],o.active=!1,o.scheduled=void 0,o}return w(t,e),t.prototype.schedule=function(n,r,o){return void 0===r&&(r=0),t.delegate&&t.delegate!==this?t.delegate.schedule(n,r,o):e.prototype.schedule.call(this,n,r,o)},t.prototype.flush=function(e){var t=this.actions;if(this.active)t.push(e);else{var n;this.active=!0;do{if(n=e.execute(e.state,e.delay))break}while(e=t.shift());if(this.active=!1,n){for(;e=t.shift();)e.unsubscribe();throw n}}},t}(Y))(J);function X(e){return e&&"function"==typeof e.schedule}function Z(e){return function(t){var n=new ee(e),r=t.lift(n);return n.caught=r}}var ee=function(){function e(e){this.selector=e}return e.prototype.call=function(e,t){return t.subscribe(new te(e,this.selector,this.caught))},e}(),te=function(e){function t(t,n,r){var o=e.call(this,t)||this;return o.selector=n,o.caught=r,o}return w(t,e),t.prototype.error=function(t){if(!this.isStopped){var n=void 0;try{n=this.selector(t,this.caught)}catch(t){return void e.prototype.error.call(this,t)}this._unsubscribeAndRecycle();var r=new q(this);this.add(r);var o=G(n,r);o!==r&&this.add(o)}},t}(z);function ne(e,t){return new R((function(n){var r=new O,o=0;return r.add(t.schedule((function(){o!==e.length?(n.next(e[o++]),n.closed||r.add(this.schedule())):n.complete()}))),r}))}function re(e,t){return t?ne(e,t):new R(W(e))}function oe(e,t){if(null!=e){if(function(e){return e&&"function"==typeof e[N]}(e))return function(e,t){return new R((function(n){var r=new O;return r.add(t.schedule((function(){var o=e[N]();r.add(o.subscribe({next:function(e){r.add(t.schedule((function(){return n.next(e)})))},error:function(e){r.add(t.schedule((function(){return n.error(e)})))},complete:function(){r.add(t.schedule((function(){return n.complete()})))}}))}))),r}))}(e,t);if(K(e))return function(e,t){return new R((function(n){var r=new O;return r.add(t.schedule((function(){return e.then((function(e){r.add(t.schedule((function(){n.next(e),r.add(t.schedule((function(){return n.complete()})))})))}),(function(e){r.add(t.schedule((function(){return n.error(e)})))}))}))),r}))}(e,t);if(H(e))return ne(e,t);if(function(e){return e&&"function"==typeof e[M]}(e)||"string"==typeof e)return function(e,t){if(!e)throw new Error("Iterable cannot be null");return new R((function(n){var r,o=new O;return o.add((function(){r&&"function"==typeof r.return&&r.return()})),o.add(t.schedule((function(){r=e[M](),o.add(t.schedule((function(){if(!n.closed){var e,t;try{var o=r.next();e=o.value,t=o.done}catch(e){return void n.error(e)}t?n.complete():(n.next(e),this.schedule())}})))}))),o}))}(e,t)}throw new TypeError((null!==e&&typeof e||e)+" is not observable")}function ie(e,t){return function(n){if("function"!=typeof e)throw new TypeError("argument is not a function. Are you looking for `mapTo()`?");return n.lift(new se(e,t))}}var se=function(){function e(e,t){this.project=e,this.thisArg=t}return e.prototype.call=function(e,t){return t.subscribe(new ae(e,this.project,this.thisArg))},e}(),ae=function(e){function t(t,n,r){var o=e.call(this,t)||this;return o.project=n,o.count=0,o.thisArg=r||o,o}return w(t,e),t.prototype._next=function(e){var t;try{t=this.project.call(this.thisArg,e,this.count++)}catch(e){return void this.destination.error(e)}this.destination.next(t)},t}(D);function ce(e){return e instanceof Date&&!isNaN(+e)}var ue=new R((function(e){return e.complete()}));function le(e){return e?function(e){return new R((function(t){return e.schedule((function(){return t.complete()}))}))}(e):ue}function de(e,t){return new R(t?function(n){return t.schedule(fe,0,{error:e,subscriber:n})}:function(t){return t.error(e)})}function fe(e){var t=e.error;e.subscriber.error(t)}var he=function(){function e(e,t,n){this.kind=e,this.value=t,this.error=n,this.hasValue="N"===e}return e.prototype.observe=function(e){switch(this.kind){case"N":return e.next&&e.next(this.value);case"E":return e.error&&e.error(this.error);case"C":return e.complete&&e.complete()}},e.prototype.do=function(e,t,n){switch(this.kind){case"N":return e&&e(this.value);case"E":return t&&t(this.error);case"C":return n&&n()}},e.prototype.accept=function(e,t,n){return e&&"function"==typeof e.next?this.observe(e):this.do(e,t,n)},e.prototype.toObservable=function(){switch(this.kind){case"N":return function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var n=e[e.length-1];return X(n)?(e.pop(),ne(e,n)):re(e)}(this.value);case"E":return de(this.error);case"C":return le()}throw new Error("unexpected notification kind value")},e.createNext=function(t){return void 0!==t?new e("N",t):e.undefinedValueNotification},e.createError=function(t){return new e("E",void 0,t)},e.createComplete=function(){return e.completeNotification},e.completeNotification=new e("C"),e.undefinedValueNotification=new e("N",void 0),e}();function pe(e,t){void 0===t&&(t=Q);var n=ce(e)?+e-t.now():Math.abs(e);return function(e){return e.lift(new ye(n,t))}}var ye=function(){function e(e,t){this.delay=e,this.scheduler=t}return e.prototype.call=function(e,t){return t.subscribe(new be(e,this.delay,this.scheduler))},e}(),be=function(e){function t(t,n,r){var o=e.call(this,t)||this;return o.delay=n,o.scheduler=r,o.queue=[],o.active=!1,o.errored=!1,o}return w(t,e),t.dispatch=function(e){for(var t=e.source,n=t.queue,r=e.scheduler,o=e.destination;n.length>0&&n[0].time-r.now()<=0;)n.shift().notification.observe(o);if(n.length>0){var i=Math.max(0,n[0].time-r.now());this.schedule(e,i)}else this.unsubscribe(),t.active=!1},t.prototype._schedule=function(e){this.active=!0,this.destination.add(e.schedule(t.dispatch,this.delay,{source:this,destination:this.destination,scheduler:e}))},t.prototype.scheduleNotification=function(e){if(!0!==this.errored){var t=this.scheduler,n=new ve(t.now()+this.delay,e);this.queue.push(n),!1===this.active&&this._schedule(t)}},t.prototype._next=function(e){this.scheduleNotification(he.createNext(e))},t.prototype._error=function(e){this.errored=!0,this.queue=[],this.destination.error(e),this.unsubscribe()},t.prototype._complete=function(){this.scheduleNotification(he.createComplete()),this.unsubscribe()},t}(D),ve=function(){return function(e,t){this.time=e,this.notification=t}}(),me=function(){function e(){return Error.call(this),this.message="argument out of range",this.name="ArgumentOutOfRangeError",this}return e.prototype=Object.create(Error.prototype),e}();function _e(e,t){return function(n){return n.lift(new ge(e,t))}}var ge=function(){function e(e,t){this.predicate=e,this.thisArg=t}return e.prototype.call=function(e,t){return t.subscribe(new we(e,this.predicate,this.thisArg))},e}(),we=function(e){function t(t,n,r){var o=e.call(this,t)||this;return o.predicate=n,o.thisArg=r,o.count=0,o}return w(t,e),t.prototype._next=function(e){var t;try{t=this.predicate.call(this.thisArg,e,this.count++)}catch(e){return void this.destination.error(e)}t&&this.destination.next(e)},t}(D);function Se(e){return function(t){return 0===e?le():t.lift(new ke(e))}}var ke=function(){function e(e){if(this.total=e,this.total<0)throw new me}return e.prototype.call=function(e,t){return t.subscribe(new Ee(e,this.total))},e}(),Ee=function(e){function t(t,n){var r=e.call(this,t)||this;return r.total=n,r.count=0,r}return w(t,e),t.prototype._next=function(e){var t=this.total,n=++this.count;n<=t&&(this.destination.next(e),n===t&&(this.destination.complete(),this.unsubscribe()))},t}(D);function xe(e,t){return"function"==typeof t?function(n){return n.pipe(xe((function(n,r){return(o=e(n,r),i?oe(o,i):o instanceof R?o:new R(V(o))).pipe(ie((function(e,o){return t(n,e,r,o)})));var o,i})))}:function(t){return t.lift(new Ie(e))}}var Ie=function(){function e(e){this.project=e}return e.prototype.call=function(e,t){return t.subscribe(new Te(e,this.project))},e}(),Te=function(e){function t(t,n){var r=e.call(this,t)||this;return r.project=n,r.index=0,r}return w(t,e),t.prototype._next=function(e){var t,n=this.index++;try{t=this.project(e,n)}catch(e){return void this.destination.error(e)}this._innerSub(t)},t.prototype._innerSub=function(e){var t=this.innerSubscription;t&&t.unsubscribe();var n=new q(this),r=this.destination;r.add(n),this.innerSubscription=G(e,n),this.innerSubscription!==n&&r.add(this.innerSubscription)},t.prototype._complete=function(){var t=this.innerSubscription;t&&!t.closed||e.prototype._complete.call(this),this.unsubscribe()},t.prototype._unsubscribe=function(){this.innerSubscription=void 0},t.prototype.notifyComplete=function(){this.innerSubscription=void 0,this.isStopped&&e.prototype._complete.call(this)},t.prototype.notifyNext=function(e){this.destination.next(e)},t}(z);function Ce(){}function Ae(e,t,n){return function(r){return r.lift(new Oe(e,t,n))}}var Oe=function(){function e(e,t,n){this.nextOrObserver=e,this.error=t,this.complete=n}return e.prototype.call=function(e,t){return t.subscribe(new Ue(e,this.nextOrObserver,this.error,this.complete))},e}(),Ue=function(e){function t(t,n,r,o){var i=e.call(this,t)||this;return i._tapNext=Ce,i._tapError=Ce,i._tapComplete=Ce,i._tapError=r||Ce,i._tapComplete=o||Ce,S(n)?(i._context=i,i._tapNext=n):n&&(i._context=n,i._tapNext=n.next||Ce,i._tapError=n.error||Ce,i._tapComplete=n.complete||Ce),i}return w(t,e),t.prototype._next=function(e){try{this._tapNext.call(this._context,e)}catch(e){return void this.destination.error(e)}this.destination.next(e)},t.prototype._error=function(e){try{this._tapError.call(this._context,e)}catch(e){return void this.destination.error(e)}this.destination.error(e)},t.prototype._complete=function(){try{this._tapComplete.call(this._context)}catch(e){return void this.destination.error(e)}return this.destination.complete()},t}(D),Pe=function(){function e(){return Error.call(this),this.message="Timeout has occurred",this.name="TimeoutError",this}return e.prototype=Object.create(Error.prototype),e}();var De=function(){function e(e,t,n,r){this.waitFor=e,this.absoluteTimeout=t,this.withObservable=n,this.scheduler=r}return e.prototype.call=function(e,t){return t.subscribe(new $e(e,this.absoluteTimeout,this.waitFor,this.withObservable,this.scheduler))},e}(),$e=function(e){function t(t,n,r,o,i){var s=e.call(this,t)||this;return s.absoluteTimeout=n,s.waitFor=r,s.withObservable=o,s.scheduler=i,s.scheduleTimeout(),s}return w(t,e),t.dispatchTimeout=function(e){var t=e.withObservable;e._unsubscribeAndRecycle(),e.add(G(t,new q(e)))},t.prototype.scheduleTimeout=function(){var e=this.action;e?this.action=e.schedule(this,this.waitFor):this.add(this.action=this.scheduler.schedule(t.dispatchTimeout,this.waitFor,this))},t.prototype._next=function(t){this.absoluteTimeout||this.scheduleTimeout(),e.prototype._next.call(this,t)},t.prototype._unsubscribe=function(){this.action=void 0,this.scheduler=null,this.withObservable=null},t}(z);function Ne(e,t){return void 0===t&&(t=Q),function(e,t,n){return void 0===n&&(n=Q),function(r){var o=ce(e),i=o?+e-n.now():Math.abs(e);return r.lift(new De(i,o,t,n))}}(e,de(new Pe),t)}const je="undefined"!=typeof Buffer?e=>Buffer.from(e,"base64"):e=>{const t=atob(e),n=t.length,r=new Uint8Array(n);for(var o=0;o<n;o++)r[o]=t.charCodeAt(o);return r},Le="undefined"!=typeof Buffer?e=>ArrayBuffer.isView(e)?Buffer.from(e.buffer,e.byteOffset,e.byteLength).toString("base64"):Buffer.from(e).toString("base64"):e=>btoa(String.fromCharCode.apply(null,e));function Re(e,t){return new Promise(((n,o)=>{const i={...t,onSubmit:t=>{e.next(void 0),n(t)},onCancel:()=>{e.next(void 0),o(new r.default.AbortError("User cancelled"))}};e.next(i)}))}function Be(e,t,...n){return Re(e,{type:"message-alert",title:t,alerts:n,fields:{}})}async function We(e,t,n){let r=n||"";for(;!r||!/^[\w-\.]+@([\w-]+\.)+[\w-]{2,10}$/.test(r);)r=(await Re(e,{type:"email",title:t,alerts:r?[{type:"error",messageCode:"INVALID_EMAIL",message:"Please enter a valid email address",messageParams:{}}]:[],fields:{email:{type:"email",placeholder:"you@somedomain.com"}}})).email;return r}async function Fe(e,t,n){const r=[{type:"info",messageCode:"OTP_SENT",message:"A One-Time password has been sent to {email}",messageParams:{email:t}}];n&&r.push(n);const{otp:o}=await Re(e,{type:"otp",title:"Enter OTP",alerts:r,fields:{otp:{type:"otp",label:"OTP",placeholder:"Paste OTP here"}}});return o}async function Me(e,t,n,r,o){return t.accessToken&&t.accessTokenExpiration.getTime()>Date.now()?t:t.refreshToken&&(!t.refreshTokenExpiration||t.refreshTokenExpiration.getTime()>Date.now())?await He(e,t):await async function(e,t,n,r){const{privateKey:o,publicKey:i}=await crypto.subtle.generateKey({name:"RSASSA-PKCS1-v1_5",modulusLength:2048,publicExponent:new Uint8Array([1,0,1]),hash:{name:"SHA-256"}},!1,["sign","verify"]);e.nonExportablePrivateKey=o;const s=function(e){const t=Le(e);return function(e){let t="-----BEGIN PUBLIC KEY-----\n";for(;e.length>0;)t+=e.substring(0,64)+"\n",e=e.substring(64);return t+="-----END PUBLIC KEY-----",t}(t)}(await crypto.subtle.exportKey("spki",i));e.publicKey=i;try{const o=await t({public_key:s,hints:r});if("tokens"!==o.type)throw new Error(`Unexpected response type from token endpoint: ${o.type}`);return e.accessToken=o.accessToken,e.accessTokenExpiration=new Date(o.accessTokenExpiration),e.refreshToken=o.refreshToken,o.refreshTokenExpiration&&(e.refreshTokenExpiration=new Date(o.refreshTokenExpiration)),e.userId=o.claims.sub,e.email=o.claims.email,e.name=o.claims.name,e.claims=o.claims,o.alerts&&o.alerts.length>0&&await Re(n,{type:"message-alert",title:"Authentication Alert",fields:{},alerts:o.alerts}),e}catch(e){throw await Be(n,"Authentication Failed",{type:"error",messageCode:"GENERIC_ERROR",message:"We're having a problem to authenticate rigth now.",messageParams:{}}).catch((()=>{})),e}}(t,n,r,o)}async function He(e,t){if(!t.refreshToken)throw new Error("Cannot refresh token - refresh token is missing.");if(!t.nonExportablePrivateKey)throw new Error("login.nonExportablePrivateKey is missing - cannot sign refresh token without a private key.");const n=Date.now(),r="RSASSA-PKCS1-v1_5",o=(new TextEncoder).encode(t.refreshToken+n),i=await crypto.subtle.sign(r,t.nonExportablePrivateKey,o),s=Le(i),a={grant_type:"refresh_token",refresh_token:t.refreshToken,scopes:["ACCESS_DB"],signature:s,signing_algorithm:r,time_stamp:n},c=await fetch(`${e}/token`,{body:JSON.stringify(a),method:"post",headers:{"Content-Type":"application/json"},mode:"cors"});if(200!==c.status)throw new Error(`RefreshToken: Status ${c.status} from ${e}/token`);const u=await c.json();return t.accessToken=u.accessToken,t.accessTokenExpiration=u.accessTokenExpiration?new Date(u.accessTokenExpiration):void 0,t}const Ke=new WeakMap;class Ve{constructor(e,t){Ke.set(this,e),Object.assign(this,t)}static load(e,t){return e.table("$logins").get(t).then((n=>new Ve(e,n||{userId:t,claims:{sub:t},lastLogin:new Date(0)})))}async save(){Ke.get(this).table("$logins").put(this)}}class qe extends Error{constructor(e,t){super(t||`${e.status} ${e.statusText}`),this.httpStatus=e.status}get name(){return"HttpError"}}async function ze(e,t){if((await e.getCurrentUser()).isLoggedIn){if(t){if(t.email&&e.cloud.currentUser.value.email!==t.email)throw new Error("Must logout before changing user");if(t.userId&&e.cloud.currentUserId!==t.userId)throw new Error("Must logout before changing user")}return}const n=new Ve(e,{claims:{},lastLogin:new Date(0)});await Me(e.cloud.options.databaseUrl,n,e.cloud.options.fetchTokens||function(e){const{userInteraction:t}=e.cloud;return async function({public_key:n,hints:r}){var o;let i;const s=null===(o=e.cloud.options)||void 0===o?void 0:o.databaseUrl;if(!s)throw new Error("No database URL given.");i="demo"===(null==r?void 0:r.grant_type)?{demo_user:await We(t,"Enter a demo user email",(null==r?void 0:r.email)||(null==r?void 0:r.userId)),grant_type:"demo",scopes:["ACCESS_DB"],public_key:n}:{email:await We(t,"Enter email address",null==r?void 0:r.email),grant_type:"otp",scopes:["ACCESS_DB"],public_key:n};const a=await fetch(`${s}/token`,{body:JSON.stringify(i),method:"post",headers:{"Content-Type":"application/json",mode:"cors"}});if(200!==a.status){const e=await a.text();throw await Be(t,"Token request failed",{type:"error",messageCode:"GENERIC_ERROR",message:e,messageParams:{}}).catch((()=>{})),new qe(a,e)}const c=await a.json();if("tokens"===c.type)return c;if("otp"===i.grant_type){if("otp-sent"!==c.type)throw new Error(`Unexpected response from ${s}/token`);const e=await Fe(t,i.email);i.otp=e||"",i.otp_id=c.otp_id;let n=await fetch(`${s}/token`,{body:JSON.stringify(i),method:"post",headers:{"Content-Type":"application/json"},mode:"cors"});for(;401===n.status;){const e=await n.text();i.otp=await Fe(t,i.email,{type:"error",messageCode:"INVALID_OTP",message:e,messageParams:{}}),n=await fetch(`${s}/token`,{body:JSON.stringify(i),method:"post",headers:{"Content-Type":"application/json"},mode:"cors"})}if(200!==n.status){const e=await n.text();throw await Be(t,"OTP Authentication Failed",{type:"error",messageCode:"GENERIC_ERROR",message:e,messageParams:{}}).catch((()=>{})),new qe(n,e)}return await n.json()}throw new Error(`Unexpected response from ${s}/token`)}}(e),e.cloud.userInteraction,t),await n.save(),await async function(e,t){if(t.userId===e.cloud.currentUserId)return;const n=e.table("$logins");await e.transaction("rw",n,(async e=>{const r=await n.toArray();await Promise.all(r.filter((e=>e.userId!==t.userId&&e.isLoggedIn)).map((e=>(e.isLoggedIn=!1,n.put(e))))),t.isLoggedIn=!0,t.lastLogin=new Date,await t.save(),console.debug("Saved new user",t.email)})),await new Promise((n=>{if(e.cloud.currentUserId===t.userId)n(null);else{const r=e.cloud.currentUser.subscribe((e=>{e.userId===t.userId&&(r.unsubscribe(),n(null))}))}}))}(e,n)}const Ge="undefined"!=typeof InstallTrigger,Je="undefined"!=typeof navigator&&/Safari\//.test(navigator.userAgent)&&!/Chrom(e|ium)\/|Edge\//.test(navigator.userAgent),Ye=Je?[].concat(navigator.userAgent.match(/Safari\/(\d*)/))[1]:NaN,Qe=Je&&Ye<=605||Ge;const Xe="undefined"!=typeof self&&"clients"in self&&!self.document;function Ze(){throw new r.default.SchemaError("Version increment needed to allow dexie-cloud change tracking")}function et(e){return function(e){for(var t="",n=0,r=e.length;n<r;n++)t+=rt[e[n]];return t}(Le(e))}function tt(e){return je(function(e){if("string"!=typeof e)throw new Error("invalid decoder input: "+e);for(var t="",n=0,r=e.length;n<r;n++)t+=nt[e[n]];return t}(e))}const nt={"-":"=",0:"A",1:"B",2:"C",3:"D",4:"E",5:"F",6:"G",7:"H",8:"I",9:"J",A:"K",B:"L",C:"M",D:"N",E:"O",F:"P",G:"Q",H:"R",I:"S",J:"T",K:"U",L:"V",M:"W",N:"X",O:"Y",P:"Z",Q:"a",R:"b",S:"c",T:"d",U:"e",V:"f",W:"g",X:"h",Y:"i",Z:"j",_:"k",a:"l",b:"m",c:"n",d:"o",e:"p",f:"q",g:"r",h:"s",i:"t",j:"u",k:"v",l:"w",m:"x",n:"y",o:"z",p:"0",q:"1",r:"2",s:"3",t:"4",u:"5",v:"6",w:"7",x:"8",y:"9",z:"+","|":"/"},rt={};for(const e of Object.keys(nt))rt[nt[e]]=e;const{toString:ot}={};function it(e){return ot.call(e).slice(8,-1)}function st(e,t){var n;return"delete"===t.type?t.keys:(null===(n=t.keys)||void 0===n?void 0:n.slice())||t.values.map(e.extractKey)}const at=/b|c|d|f|g|h|j|k|l|m|n|p|q|r|s|t|v|x|y|z/i;let ct=0;function ut(e){return{stack:"dbcore",name:"idGenerationMiddleware",level:1,create:t=>({...t,table:n=>{const o=t.table(n);function i(t,i){let s=null;const a=st(o.schema.primaryKey,t);return a.forEach(((c,u)=>{if(void 0===c){const n=t.values[u].realmId||e.cloud.currentUserId,c=n.substr(n.length-3);a[u]=function(e,t){const n=new Uint8Array(18),r=new Uint8Array(n.buffer,0,6),o=Date.now();ct>=o?++ct:ct=o,r[0]=ct/1099511627776,r[1]=ct/4294967296,r[2]=ct/16777216,r[3]=ct/65536,r[4]=ct/256,r[5]=ct;const i=new Uint8Array(n.buffer,6);return crypto.getRandomValues(i),e+et(new Uint8Array(n.buffer))+(t||"")}(i,c),o.schema.primaryKey.outbound||(s||(s=t.values.slice()),s[u]=r.default.deepClone(s[u]),r.default.setByKeyPath(s[u],o.schema.primaryKey.keyPath,a[u]))}else if("string"!=typeof c||!c.startsWith(i))throw new r.default.ConstraintError(`The ID "${c}" is not valid for table "${n}". Primary '@' keys requires the key to be prefixed with "${i}.\n"If you want to generate IDs programmatically, remove '@' from the schema to get rid of this constraint. Dexie Cloud supports custom IDs as long as they are random and globally unique.`)})),o.mutate({...t,keys:a,values:s||t.values})}return{...o,mutate:t=>{var s,a;if(t.trans.disableChangeTracking)return o.mutate(t);if("add"===t.type||"put"===t.type){const c=null===(s=e.cloud.schema)||void 0===s?void 0:s[n];if(null==c?void 0:c.generatedGlobalId){if((null===(a=e.cloud.options)||void 0===a?void 0:a.databaseUrl)&&!e.initiallySynced){const e=st(o.schema.primaryKey,t);return o.getMany({keys:e,trans:t.trans,cache:"immutable"}).then((n=>{if(n.length<e.length)throw new Error("Unable to create new objects without an initial sync having been performed.");return o.mutate(t)}))}return i(t,c.idPrefix)}if(null==c?void 0:c.markedForSync){st(o.schema.primaryKey,t).forEach(((e,t)=>{if(!b(e)){const t=Array.isArray(e)?e.map(it).join(","):it(e);throw new r.default.ConstraintError(`Invalid primary key type ${t} for table ${n}. Tables marked for sync has primary keys of type string or Array of string (and optional numbers)`)}}))}}return o.mutate(t)}}}})}}function lt(e){return`$${e}_mutations`}function dt(e){const t=new Uint8Array(e);return crypto.getRandomValues(t),btoa(String.fromCharCode.apply(null,t))}let ft=0;function ht(e,t){return function(n){const{readers:r,writers:o}=n.trans[t]||(n.trans[t]={writers:[],readers:[]}),i=o.length,s=(i>0?o[i-1].then((()=>e(n)),(()=>e(n))):e(n)).finally((()=>r.splice(r.indexOf(s))));return r.push(s),s}}function pt(e,t){return function(n){const{readers:r,writers:o}=n.trans[t]||(n.trans[t]={writers:[],readers:[]});let i=(o.length>0?o[o.length-1].then((()=>e(n)),(()=>e(n))):r.length>0?(s=r,new Promise((e=>{0===s.length&&e([]);let t=s.length;const n=new Array(t);s.forEach(((r,o)=>Promise.resolve(r).then((e=>n[o]={status:"fulfilled",value:e}),(e=>n[o]={status:"rejected",reason:e})).then((()=>--t||e(n)))))}))).then((()=>e(n))):e(n)).finally((()=>o.shift()));var s;return o.push(i),i}}let yt=!1;async function bt(e){try{const t=await navigator.serviceWorker.ready;return void(t.sync?await t.sync.register(`dexie-cloud:${e.name}`):t.active?t.active.postMessage({type:"dexie-cloud-sync",dbName:e.name}):console.error("Dexie Cloud: There's no active service worker. Can this ever happen??"))}catch(e){yt||(console.debug("Dexie Cloud: Could not register sync event",e),yt=!0)}}const vt=new t.BehaviorSubject(new Set);function mt({currentUserObservable:e,db:t}){return{stack:"dbcore",name:"MutationTrackingMiddleware",level:1,create:n=>{const r=n.schema.tables.filter((e=>!/^\$/.test(e.name)));let o;try{o=new Map(r.map((e=>[e.name,n.table(`$${e.name}_mutations`)])))}catch(e){Ze()}return{...n,transaction:(r,o)=>{let i;if("readwrite"===o){const e=r.filter((e=>{var n,r;return null===(r=null===(n=t.cloud.schema)||void 0===n?void 0:n[e])||void 0===r?void 0:r.markedForSync})).map((e=>lt(e)));i=n.transaction([...r,...e],o)}else i=n.transaction(r,o);if("readwrite"===o){i.txid=dt(16),i.currentUser=e.value,vt.value.add(i),vt.next(vt.value);const n=()=>{i.removeEventListener("complete",r),i.removeEventListener("error",n),i.removeEventListener("abort",n),vt.value.delete(i),vt.next(vt.value)},r=()=>{var e;i.mutationsAdded&&(null===(e=t.cloud.options)||void 0===e?void 0:e.databaseUrl)&&(t.cloud.usingServiceWorker?(console.debug("registering sync event"),bt(t)):t.localSyncEvent.next({})),n()};i.addEventListener("complete",r),i.addEventListener("error",n),i.addEventListener("abort",n)}return i},table:e=>{const t=n.table(e);if(/^\$/.test(e))return e.endsWith("_mutations")?{...t,mutate:e=>("add"!==e.type&&"put"!==e.type||(e.trans.mutationsAdded=!0),t.mutate(e))}:"$logins"===e?{...t,mutate:e=>(console.debug("Mutating $logins table",e),t.mutate(e).then((t=>(console.debug("Mutating $logins"),e.trans.mutationsAdded=!0,console.debug("$logins mutated"),t))).catch((e=>(console.debug("Failed mutation $logins",e),Promise.reject(e)))))}:t;const{schema:r}=t,i=o.get(e);return function(e){const t="$lock"+ ++ft;return{...e,count:ht(e.count,t),get:ht(e.get,t),getMany:ht(e.getMany,t),openCursor:ht(e.openCursor,t),query:ht(e.query,t),mutate:pt(e.mutate,t)}}({...t,mutate:e=>{var n;const o=e.trans;return o.txid?o.disableChangeTracking?t.mutate(e):(null===(n=o.currentUser)||void 0===n?void 0:n.isLoggedIn)?"deleteRange"===e.type?t.query({query:{range:e.range,index:r.primaryKey},trans:e.trans,values:!1}).then((t=>s({type:"delete",keys:t.result,trans:e.trans,criteria:{index:null,range:e.range}}))):s(e):t.mutate(e):t.mutate(e)}});function s(e){const n=e.trans;n.mutationsAdded=!0;const{txid:r,currentUser:{userId:o}}=n,{type:s}=e;return t.mutate(e).then((t=>{const{numFailures:a,failures:c}=t;let u="delete"===s?e.keys:t.results,l="values"in e?e.values:[],d="changeSpecs"in e?e.changeSpecs:[];a&&(u=u.filter(((e,t)=>!c[t])),l=l.filter(((e,t)=>!c[t])),d=d.filter(((e,t)=>!c[t])));const f=Date.now(),h="delete"===e.type?{type:"delete",ts:f,keys:u,criteria:e.criteria,txid:r,userId:o}:"add"===e.type?{type:"insert",ts:f,keys:u,txid:r,userId:o,values:l}:e.criteria&&e.changeSpec?{type:"modify",ts:f,keys:u,criteria:e.criteria,changeSpec:e.changeSpec,txid:r,userId:o}:e.changeSpecs?{type:"update",ts:f,keys:u,changeSpecs:d,txid:r,userId:o}:{type:"upsert",ts:f,keys:u,values:l,txid:r,userId:o};return u.length>0||"criteria"in e&&e.criteria?i.mutate({type:"add",trans:n,values:[h]}).then((()=>t)):t}))}}}}}}function _t(e,t){return function(n,r){const o={...l,...n},i=t.cloud.schema||(t.cloud.schema={}),s=new Set;Object.keys(o).forEach((e=>{const t=o[e],n=i[e]||(i[e]={});null!=t?(/^\@/.test(t)&&(o[e]=o[e].substr(1),n.generatedGlobalId=!0,n.idPrefix=function(e,t){let n=e[0].toLocaleLowerCase();for(let t=1,o=e.length;t<o&&n.length<3;++t)(at.test(e[t])||(r=e[t])>="A"&&r<="Z")&&(n+=e[t].toLowerCase());for(var r,o,i;t.has(n);){if(/\d/g.test(n)){if(n=n.substr(0,n.length-1)+(n[n.length-1]+1),!(n.length>3))continue;n=n.substr(0,3)}else if(n.length<3){n+="2";continue}let e=1,r=n;for(;t.has(r)&&e<8;)o=n,r=(1&(i=e)?o[0].toUpperCase():o[0].toLowerCase())+(2&i?o[1].toUpperCase():o[1].toLowerCase())+(4&i?o[2].toUpperCase():o[2].toLowerCase()),++e;if(e<8)n=r;else{let e=n.charCodeAt(2)+1&127;n=n.substr(0,2)+String.fromCharCode(e)}}return n}(e,s),s.add(n.idPrefix)),/^\$/.test(e)||(o[`$${e}_mutations`]="++rev",n.markedForSync=!0),n.deleted&&(n.deleted=!1)):(n.deleted=!0,n.markedForSync=!1,o[`$${e}_mutations`]=null)}));return e.call(this,o,r)}}const gt=dt(16);async function wt(n,r,o,i,{awaitRemoteJob:s}={}){const a=n.table(o);if(await async function i(){if(await n.transaction("rw!",o,(async()=>{const e=await a.get(r);return e?e.heartbeat.getTime()<Date.now()-6e4&&(console.warn(`Latest ${r} worker seem to have died.\n`,"The dead job started:",e.started,"\n","Last heart beat was:",e.heartbeat,"\n","We're now taking over!"),await a.put({nodeId:gt,started:new Date,heartbeat:new Date},r),!0):(await a.add({nodeId:gt,started:new Date,heartbeat:new Date},r),!0)})))return!0;if(s)try{const n=t.from(e.liveQuery((()=>a.get(r)))).pipe(Ne(6e4),_e((e=>!e)));return await n.toPromise(),!1}catch(e){if("TimeoutError"!==e.name)throw e;return await i()}return!1}()){const e=setInterval((()=>{a.update(r,(e=>e.nodeId===gt&&(e.heartbeat=new Date)))}),1e3);try{return await i()}finally{clearInterval(e),await n.transaction("rw!",o,(async()=>{const e=await a.get(r);e&&e.nodeId===gt&&a.delete(r)}))}}}function St(e){return Object.entries(e.cloud.schema||{}).filter((([,{markedForSync:e}])=>e)).map((([t])=>e.table(t)))}function kt(e){var t;const n=null===(t=/^\$(.*)_mutations$/.exec(e))||void 0===t?void 0:t[1];if(!n)throw new Error(`Given mutationTable ${e} is not correct`);return n}async function Et(e,t,{since:n={},limit:r=1/0}={}){return(await Promise.all(e.map((async e=>{const t=kt(e.name),o=n[t];let i=o?e.where("rev").above(o):e;r<1/0&&(i=i.limit(r));return{table:t,muts:await i.toArray()}})))).filter((({muts:e})=>e.length>0))}const{toString:xt}={};const It={replace:function(e){const t=Object.keys(e);let n=null;for(let e=0,r=t.length;e<r;++e)"$"===t[e][0]&&(n=n||[],n.push(t[e]));if(!n)return e;const r={...e};for(const t of n)delete r[t],r["$"+t]=e[t];return r}};function Tt(...e){const t=e.reduce(((e,t)=>({...e,...t})),e.reduce(((e,t)=>({...t,...e})),{})),n=new WeakMap;return{stringify:(e,r,o)=>JSON.stringify(e,(function(e){const o=this[e],i=function(e){const r=typeof e;switch(typeof e){case"object":case"function":{if(null===e)return null;const r=Object.getPrototypeOf(e);if(!r)return It;let i=n.get(r);if(void 0!==i)return i;const s=(o=e,xt.call(o).slice(8,-1)),a=Object.entries(t).find((([t,n])=>{var r,o;return null!==(o=null===(r=null==n?void 0:n.test)||void 0===r?void 0:r.call(n,e,s))&&void 0!==o?o:t===s}));return i=null==a?void 0:a[1],i||(i=Array.isArray(e)?null:"function"==typeof e?t.function||null:It),n.set(r,i),i}default:return t[r]}var o}(o);return i?i.replace(o,r,t):o}),o),parse(e,n){let r=null,o=[];return JSON.parse(e,(function(e,i){const s=null==i?void 0:i.$t;if(s){const e=t[s];i=e?e.revive(i,n,t):i}if(i===r){if(o.length>0){i={...i};for(const e of o)i[e.substr(1)]=i[e],delete i[e]}return o=[],i}return"$"===e[0]&&"$t"!==e&&(r=this,o.push(e)),i}))}}}const Ct={Blob:{test:(e,t)=>"Blob"===t,replace:(e,t)=>{const n=t.length;return t.push(e),{$t:"Blob",mimeType:e.type,i:n}},revive:({i:e,mimeType:t},n)=>new Blob([n[e]],{type:t})}};var At={number:{replace:e=>{switch(!0){case isNaN(e):return{$t:"number",v:"NaN"};case e===1/0:return{$t:"number",v:"Infinity"};case e===-1/0:return{$t:"number",v:"-Infinity"};default:return e}},revive:({v:e})=>Number(e)}};const Ot={bigint:{replace:e=>({$t:"bigint",v:""+e}),revive:e=>BigInt(e.v)}};var Ut={Date:{replace:e=>({$t:"Date",v:isNaN(e.getTime())?"NaN":e.toISOString()}),revive:({v:e})=>new Date("NaN"===e?NaN:Date.parse(e))}},Pt={Set:{replace:e=>({$t:"Set",v:Array.from(e.entries())}),revive:({v:e})=>new Set(e)}},Dt={Map:{replace:e=>({$t:"Map",v:Array.from(e.entries())}),revive:({v:e})=>new Map(e)}};const $t="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self?self:"undefined"==typeof global?global:void 0;var Nt=["Int8Array","Uint8Array","Uint8ClampedArray","Int16Array","Uint16Array","Int32Array","Uint32Array","Float32Array","Float64Array","DataView","BigInt64Array","BigUint64Array"].reduce(((e,t)=>({...e,[t]:{replace:(e,n,r)=>({$t:t,v:r.ArrayBuffer.replace(0===e.byteOffset&&e.byteLength===e.buffer.byteLength?e.buffer:e.buffer.slice(e.byteOffset,e.byteOffset+e.byteLength),n,r).v}),revive:({v:e},n,r)=>{const o=$t[t];return o&&new o(r.ArrayBuffer.revive({v:e},n,r))}}})),{}),jt={ArrayBuffer:{replace:e=>({$t:"ArrayBuffer",v:et(e)}),revive:({v:e})=>{const t=tt(e);return t.buffer.byteLength===t.byteLength?t.buffer:t.buffer.slice(t.byteOffset,t.byteOffset+t.byteLength)}}};class Lt{constructor(e,t){this.buf=e,this.type=t}}function Rt(e){const t=new XMLHttpRequest;if(t.overrideMimeType("text/plain; charset=x-user-defined"),t.open("GET",URL.createObjectURL(e),!1),t.send(),200!==t.status&&0!==t.status)throw new Error("Bad Blob access: "+t.status);return t.responseText}function Bt(e){const t=new Uint8Array(e.length);for(let n=0;n<e.length;++n)t[n]=e.charCodeAt(n);return t.buffer}const Wt={...At,...Ot,...Ut,...Pt,...Dt,...Nt,...jt,...{Blob:{test:(e,t)=>"Blob"===t||e instanceof Lt,replace:e=>({$t:"Blob",v:Le(e instanceof Lt?e.buf:Bt(Rt(e))),type:e.type}),revive:({type:e,v:t})=>{const n=je(t);return void 0!==typeof Blob?new Blob([n]):new Lt(n.buffer,e)}}}};function Ft(e){return new Promise(((t,n)=>{const r=new FileReader;r.onabort=e=>n(new Error("file read aborted")),r.onerror=e=>n(e.target.error),r.onload=e=>t(e.target.result),r.readAsArrayBuffer(e)}))}var Mt={undefined:{replace:()=>{},revive:()=>{}}};const Ht="undefined"!=typeof BigInt;class Kt{constructor(e){this.v=e}static compare(e,t){if("bigint"==typeof e)return e<t?-1:e>t?1:0;if("bigint"==typeof t)throw new TypeError("Can't compare real bigint with FakeBigInt");return Number(e)<Number(t)?-1:Number(e)>Number(t)?1:0}toString(){return this.v}}const Vt={...Mt,...Ht?{}:{bigint:{test:e=>e instanceof Kt,replace:e=>({$t:"bigint",...e}),revive:({v:e})=>new Kt(e)}}},qt=Tt(Wt,Vt),zt=function(...e){const t=Tt(Wt,Ct,...e);return{toBinary(e){const[t,n]=this.stringify(e),r=new ArrayBuffer(4);return new DataView(r).setUint32(0,t.size),new Blob([r,t,n])},stringify(e){const n=[],r=t.stringify(e,n);return[new Blob(n.map((e=>{const t=new ArrayBuffer(4);return new DataView(t).setUint32(0,"byteLength"in e?e.byteLength:e.size),new Blob([t,e])}))),r]},async parse(e,n){let r=0;const o=[],i=await Ft(n),s=new DataView(i);for(;r<i.byteLength;){const e=s.getUint32(r);r+=4;const t=i.slice(r,r+e);r+=e,o.push(t)}return t.parse(e,o)},async fromBinary(e){const t=new DataView(await Ft(e.slice(0,4))).getUint32(0),n=e.slice(4,t+4),r=await function(e){return new Promise(((t,n)=>{const r=new FileReader;r.onabort=e=>n(new Error("file read aborted")),r.onerror=e=>n(e.target.error),r.onload=e=>t(e.target.result),r.readAsText(e)}))}(e.slice(t+4));return await this.parse(r,n)}}}(Vt);async function Gt(e,t,n,r,o,i){const s={Accept:"application/json, application/x-bison, application/x-bison-stream","Content-Type":"application/tson"},a=await async function(e){var t,n;const r=await e.getCurrentUser(),{accessToken:o,accessTokenExpiration:i,refreshToken:s,refreshTokenExpiration:a,claims:c}=r;if(!o)return;if((null!==(t=null==i?void 0:i.getTime())&&void 0!==t?t:1/0)>Date.now())return o;if(!s)throw new Error("Refresh token missing");if((null!==(n=null==a?void 0:a.getTime())&&void 0!==n?n:1/0)<=Date.now())throw new Error("Refresh token has expired");const u=await He(e.cloud.options.databaseUrl,r);return await e.table("$logins").update(c.sub,{accessToken:u.accessToken,accessTokenExpiration:u.accessTokenExpiration}),u.accessToken}(r);a&&(s.Authorization=`Bearer ${a}`);const c={dbID:null==t?void 0:t.remoteDbId,schema:i||{},lastPull:t?{serverRevision:t.serverRevision,realms:t.realms,inviteRealms:t.inviteRealms}:void 0,baseRevs:n,changes:e};console.debug("Sync request",c),r.syncStateChangedEvent.next({phase:"pushing"});const u=await fetch(`${o}/sync`,{method:"post",headers:s,body:qt.stringify(c)});if(r.syncStateChangedEvent.next({phase:"pulling"}),!u.ok)throw new qe(u);switch(u.headers.get("content-type")){case"application/x-bison":return zt.fromBinary(await u.blob());case"application/x-bison-stream":default:case"application/json":{const e=await u.text();return qt.parse(e)}}}async function Jt(e,t,n){const o=await e.bulkGet(t),i=[],s=[];t.forEach(((t,a)=>{const c=o[a];if(c){for(const[t,o]of Object.entries(n[a])){if(t===e.schema.primKey.keyPath)throw new Error("Cannot change primary key");r.default.setByKeyPath(c,t,o)}i.push(t),s.push(c)}})),await(null==e.schema.primKey.keyPath?e.bulkPut(s,i):e.bulkPut(s))}function Yt(e){if(null==e?void 0:e.cancelled)throw new r.default.AbortError("Operation was cancelled")}let Qt=navigator.onLine;self.addEventListener("online",(()=>Qt=!0)),self.addEventListener("offline",(()=>Qt=!1));const Xt=new WeakSet;function Zt(e,t,n,r){return en.apply(this,arguments).then((()=>{e.syncStateChangedEvent.next({phase:"in-sync"})})).catch((async o=>(console.debug("Error from _sync",{isOnline:Qt,syncOptions:r,error:o}),Qt&&(null==r?void 0:r.retryImmediatelyOnFetchError)&&"TypeError"===(null==o?void 0:o.name)&&/fetch/.test(null==o?void 0:o.message)?(e.syncStateChangedEvent.next({phase:"error",error:o}),await new Promise((e=>setTimeout(e,500))),await Zt(e,t,n,{...r,retryImmediatelyOnFetchError:!1})):(await e.$syncState.update("syncState",{timestamp:new Date,error:""+o}),e.syncStateChangedEvent.next({phase:Qt?"error":"offline",error:o}),Promise.reject(o)))))}async function en(e,t,n,{isInitialSync:i,cancelToken:s,justCheckIfNeeded:a}={isInitialSync:!1}){var c;if(a||console.debug("SYNC STARTED",{isInitialSync:i}),!(null===(c=e.cloud.options)||void 0===c?void 0:c.databaseUrl))throw new Error("Internal error: sync must not be called when no databaseUrl is configured");const{databaseUrl:u}=t,l=await e.getCurrentUser(),d=l.isLoggedIn?St(e):[],f=d.map((t=>e.table(lt(t.name)))),h=await e.getPersistedSyncState(),v=!i&&l.isLoggedIn?function(e,t){const n=(null==t?void 0:t.syncedTables)||[];return St(e).filter((e=>!n.includes(e.name)))}(e,h):[];Yt(s);const m=v.length>0;if(m){if(a)return!0;console.debug("sync doSyncify is true"),await e.transaction("rw",v,(async e=>{e.idbtrans.disableChangeTracking=!0,e.idbtrans.disableAccessControl=!0,await async function(e,t,n){const r=new Set(n||[]);for(const n of e)"members"===n.name?await n.toCollection().modify((e=>{r.has(e.realmId)||e.userId!==o.userId||(e.userId=t.userId)})):"roles"===n.name||("realms"===n.name?await n.toCollection().modify((e=>{(r.has(e.realmId)||e.owner)&&e.owner!==o.userId||(e.owner=t.userId)})):await n.toCollection().modify((e=>{e.realmId&&r.has(e.realmId)||(e.owner&&e.owner!==o.userId||(e.owner=t.userId),e.realmId&&e.realmId!==o.userId||(e.realmId=t.userId))})))}(v,l,null==h?void 0:h.realms)})),Yt(s)}const[g,w,S]=await e.transaction("r",e.tables,(async()=>{const t=await e.getPersistedSyncState(),r=await e.$baseRevs.toArray();let o=await Et(f);if(Yt(s),m){const e=await async function(e,t,n,r){if(t.isLoggedIn&&e.length>0){const o=new Set(r||[]);return(await Promise.all(e.map((async e=>{const{extractKey:r}=e.core.schema.primaryKey;if(!r)return{table:e.name,muts:[]};const i=n[e.name],s=(null==i?void 0:i.generatedGlobalId)?e.filter((e=>!o.has(e.realmId||"")&&b(r(e)))):e.filter((e=>{return!o.has(e.realmId||"")&&(t=r(e),!(n=null==i?void 0:i.idPrefix)||"string"==typeof t&&t.startsWith(n));var t,n})),a=await s.toArray();if(a.length>0){const n={type:"insert",values:a,keys:a.map(r),userId:t.userId};return{table:e.name,muts:[n]}}return{table:e.name,muts:[]}})))).filter((e=>e.muts.length>0))}return[]}(v,l,n,null==h?void 0:h.realms);return Yt(s),o=o.concat(e),[o,t,r]}return[o,t,r]}));if(a){const e=g.some((e=>e.muts.some((e=>e.keys.length>0))));return console.debug("Sync is needed:",e),e}const k=tn(g,null==w?void 0:w.latestRevisions);Yt(s);const E=await Gt(g,w,S,e,u,n);console.debug("Sync response",E);return await e.transaction("rw",e.tables,(async t=>{t.idbtrans.disableChangeTracking=!0,t.idbtrans.disableAccessControl=!0;for(const e of Object.keys(n))E.schema[e]&&(n[e]=E.schema[e]);await e.$syncState.put(n,"schema");const o=await Et(f,0,{since:k});for(const t of f){const n=kt(t.name);if(o.some((e=>e.table===n&&e.muts.length>0))){if(k[t.name]){const r=k[t.name]||0;await Promise.all([t.where("rev").belowOrEqual(r).delete(),e.$baseRevs.where(":id").between([n,-1/0],[n,r+1],!0,!0).reverse().offset(1).delete()])}}else await Promise.all([t.clear(),e.$baseRevs.where({tableName:n}).delete()])}tn(o,k),await e.$baseRevs.bulkPut(Object.keys(n).filter((e=>n[e].markedForSync)).map((e=>({tableName:e,clientRev:(k[e]||0)+1,serverRev:E.serverRevision}))));const i=await e.getPersistedSyncState();await async function(e,t,n){const r=[],o=n?n.realms.concat(n.inviteRealms):[],i=new Set([...t.realms,...t.inviteRealms]);for(const e of o)i.has(e)||r.push(e);if(r.length>0){const t=new Set(r),n=St(e);for(const e of n)e.schema.indexes.some((e=>"realmId"===e.keyPath||Array.isArray(e.keyPath)&&"realmId"===e.keyPath[0]))?await e.where("realmId").anyOf(r).delete():await e.filter((e=>!!(null==e?void 0:e.realmId)&&t.has(e.realmId))).delete()}}(e,E,i);const s=i||{syncedTables:[],latestRevisions:{},realms:[],inviteRealms:[]};s.syncedTables=d.map((e=>e.name)).concat(v.map((e=>e.name))),s.latestRevisions=k,s.remoteDbId=E.dbId,s.initiallySynced=!0,s.realms=E.realms,s.inviteRealms=E.inviteRealms,s.serverRevision=E.serverRevision,s.timestamp=new Date,delete s.error;const a=function(e,t){const n={};_(n,e);const r={};return _(r,t),function(e,t){var n,r,o;for(const[i,s]of Object.entries(t))for(const[t,a]of Object.entries(s))switch(a.type){case"ups":{const r=null===(n=e[i])||void 0===n?void 0:n[t];if(r)switch(r.type){case"ups":delete e[i][t];break;case"del":break;case"upd":delete e[i][t]}}break;case"del":null===(r=e[i])||void 0===r||delete r[t];break;case"upd":{const n=null===(o=e[i])||void 0===o?void 0:o[t];if(n)switch(n.type){case"ups":for(const[e,t]of Object.entries(a.mod))p(n.val,e,t);break;case"del":break;case"upd":for(const e of Object.keys(a.mod))delete n.mod[e]}break}}}(n,r),function(e){const t=y(16),n={};for(const[t,r]of Object.entries(e))for(const[e,o]of Object.entries(r)){const r=n[t]||(n[t]={});(r[o.type]||(r[o.type]=[])).push(Object.assign({key:e},o))}const r=[];for(const[e,o]of Object.entries(n)){const n={table:e,muts:[]};for(const[e,r]of Object.entries(o))switch(e){case"ups":{const e={type:"upsert",keys:r.map((e=>e.key)),values:r.map((e=>e.val)),txid:t};n.muts.push(e);break}case"upd":{const e={type:"update",keys:r.map((e=>e.key)),changeSpecs:r.map((e=>e.mod)),txid:t};n.muts.push(e);break}case"del":{const e={type:"delete",keys:r.map((e=>e.key)),txid:t};n.muts.push(e);break}}r.push(n)}return r}(n)}(E.changes,o);return await async function(e,t){console.debug("Applying server changes",e,r.default.currentTransaction);for(const{table:n,muts:o}of e){const e=t.table(n),{primaryKey:i}=e.core.schema;for(const t of o)switch(t.type){case"insert":i.outbound?await e.bulkAdd(t.values,t.keys):(t.keys.forEach(((e,n)=>{r.default.setByKeyPath(t.values[n],i.keyPath,e)})),await e.bulkAdd(t.values));break;case"upsert":i.outbound?await e.bulkPut(t.values,t.keys):(t.keys.forEach(((e,n)=>{r.default.setByKeyPath(t.values[n],i.keyPath,e)})),await e.bulkPut(t.values));break;case"modify":1===t.keys.length?await e.update(t.keys[0],t.changeSpec):await e.where(":id").anyOf(t.keys).modify(t.changeSpec);break;case"update":await Jt(e,t.keys,t.changeSpecs);break;case"delete":await e.bulkDelete(t.keys)}}}(a,e),e.$syncState.put(s,"syncState"),0===o.length}))?(console.debug("SYNC DONE",{isInitialSync:i}),!1):(console.debug("MORE SYNC NEEDED. Go for it again!"),await en(e,t,n,{isInitialSync:i,cancelToken:s}))}function tn(e,t={}){for(const{table:n,muts:r}of e){const e=r.length>0&&r[r.length-1].rev||0;t[n]=e}return t}const nn=new t.BehaviorSubject(!0),rn="undefined"!=typeof document?t.fromEvent(document,"visibilitychange"):t.of({}),on=rn.pipe(_e((()=>"hidden"===document.visibilityState))),sn=rn.pipe(_e((()=>"hidden"===document.visibilityState))),an="undefined"!=typeof window?t.merge(sn,t.fromEvent(window,"mousemove"),t.fromEvent(window,"keydown"),t.fromEvent(window,"wheel"),t.fromEvent(window,"touchmove")):t.of({});"undefined"!=typeof document&&t.merge(t.of(!0),on,an).pipe(ie((()=>"visible"===document.visibilityState)),Ae((e=>{nn.value!==e&&nn.next(e)})),xe((e=>e?t.of(!0).pipe(pe(3e5),Ae((()=>nn.next(!1)))):t.of(!1)))).subscribe((()=>{}));class cn extends Error{constructor(){super(...arguments),this.name="TokenExpiredError"}}class un extends t.Observable{constructor(e,t,n,r){super((o=>new dn(e,t,n,r,o)))}}let ln=0;class dn extends t.Subscription{constructor(e,t,n,r,o){super((()=>this.teardown())),this.id=++ln,console.debug("New WebSocket Connection",this.id,n?"authorized":"unauthorized"),this.databaseUrl=e,this.rev=t,this.token=n,this.tokenExpiration=r,this.subscriber=o,this.lastUserActivity=new Date,this.connect()}teardown(){this.disconnect(),console.debug("Teardown WebSocket Connection",this.id)}disconnect(){if(this.pinger&&(clearInterval(this.pinger),this.pinger=null),this.ws)try{this.ws.close()}catch(e){}this.ws=null}reconnect(){this.disconnect(),this.connect()}async connect(){if(this.lastServerActivity=new Date,this.pauseUntil&&this.pauseUntil>new Date)return;if(this.ws)throw new Error("Called connect() when a connection is already open");if(!this.databaseUrl)throw new Error("Cannot connect without a database URL");if(this.closed)return;if(this.tokenExpiration&&this.tokenExpiration<new Date)return void this.subscriber.error(new cn);this.pinger=setInterval((async()=>{if(this.closed)return console.debug("pinger check",this.id,"CLOSED."),void this.teardown();if(console.debug("pinger check",this.id,"user is active"),this.ws)try{this.ws.send(JSON.stringify({type:"ping"})),setTimeout((()=>{if(console.debug("pinger setTimeout",this.id,this.pinger?"alive":"dead"),this.pinger)return this.closed?(console.debug("pinger setTimeout",this.id,"subscription is closed"),void this.teardown()):void(this.lastServerActivity<new Date(Date.now()-2e4)?(console.debug("pinger: server is inactive"),console.debug("pinger reconnecting"),this.reconnect()):console.debug("pinger: server still active"))}),2e4)}catch(e){console.debug("pinger catch error",this.id,"reconnecting"),this.reconnect()}else console.debug("pinger",this.id,"reconnecting"),this.reconnect()}),3e4);const e=new URL(this.databaseUrl);e.protocol="http:"===e.protocol?"ws":"wss";const t=new URLSearchParams;if(this.subscriber.closed)return;t.set("rev",this.rev),this.token&&t.set("token",this.token),console.debug("dexie-cloud WebSocket create");const n=this.ws=new WebSocket(`${e}/revision?${t}`);n.onclose=e=>{this.pinger&&(console.debug("dexie-cloud WebSocket onclosed"),this.reconnect())},n.onmessage=e=>{if(this.pinger){console.debug("dexie-cloud WebSocket onmessage",e.data),this.lastServerActivity=new Date;try{const t=JSON.parse(e.data);if("error"===t.type)throw new Error(`dexie-cloud WebSocket Error ${t.error}`);"rev"===t.type&&(this.rev=t.rev),"pong"!==t.type&&this.subscriber.next(t)}catch(e){this.disconnect(),this.pauseUntil=new Date(Date.now()+6e4)}}};try{await new Promise(((e,t)=>{n.onopen=t=>{console.debug("dexie-cloud WebSocket onopen"),e(null)},n.onerror=e=>{const n=e.error||new Error("WebSocket Error");console.debug("dexie-cloud WebSocket error",n),this.disconnect(),t(n)}}))}catch(e){this.pauseUntil=new Date(Date.now()+6e4)}}}function fn(e){e.cloud.usingServiceWorker?bt(e):e.localSyncEvent.next({})}async function hn(e){var t;return!(!(null===(t=e.cloud.options)||void 0===t?void 0:t.databaseUrl)||!e.cloud.schema)&&await Zt(e,e.cloud.options,e.cloud.schema,{justCheckIfNeeded:!0})}async function pn(e,t,n,r){if(!Xt.has(e)){Xt.add(e);try{e.cloud.usingServiceWorker?Xe&&await Zt(e,t,n,r):await wt(e,"currentSyncWorker","$jobs",(()=>Zt(e,t,n,r))),Xt.delete(e),console.debug("Done sync")}catch(t){throw Xt.delete(e),console.error("Failed to sync client changes",t),t}}}function yn(e,t,n){let r=null,o={cancelled:!1};function i(r=1){pn(e,t,n,{cancelToken:o,retryImmediatelyOnFetchError:!0}).catch((e=>{console.error("error in syncIfPossible()",e),o.cancelled?s():r<3&&setTimeout((()=>i(r+1)),6e4*[0,5,15][r])}))}const s=()=>{console.debug("Stopping LocalSyncWorker"),o.cancelled=!0,r&&r.unsubscribe()};return{start:()=>{console.debug("Starting LocalSyncWorker",e.localSyncEvent.id),r=e.localSyncEvent.subscribe((()=>{try{i()}catch(e){console.error("What-the....",e)}}))},stop:s}}function bn(e,t){if(e&&t&&t.unsyncedTables)for(const n of t.unsyncedTables)e[n]&&(e[n].markedForSync=!1)}var vn,mn,_n,gn,wn={},Sn=[],kn=/acit|ex(?:s|g|n|p|$)|rph|grid|ows|mnc|ntw|ine[ch]|zoo|^ord|itera/i;function En(e,t){for(var n in t)e[n]=t[n];return e}function xn(e){var t=e.parentNode;t&&t.removeChild(e)}function In(e,t,n){var r,o,i,s=arguments,a={};for(i in t)"key"==i?r=t[i]:"ref"==i?o=t[i]:a[i]=t[i];if(arguments.length>3)for(n=[n],i=3;i<arguments.length;i++)n.push(s[i]);if(null!=n&&(a.children=n),"function"==typeof e&&null!=e.defaultProps)for(i in e.defaultProps)void 0===a[i]&&(a[i]=e.defaultProps[i]);return Tn(e,a,r,o,null)}function Tn(e,t,n,r,o){var i={type:e,props:t,key:n,ref:r,__k:null,__:null,__b:0,__e:null,__d:void 0,__c:null,__h:null,constructor:void 0,__v:null==o?++vn.__v:o};return null!=vn.vnode&&vn.vnode(i),i}function Cn(e){return e.children}function An(e,t){this.props=e,this.context=t}function On(e,t){if(null==t)return e.__?On(e.__,e.__.__k.indexOf(e)+1):null;for(var n;t<e.__k.length;t++)if(null!=(n=e.__k[t])&&null!=n.__e)return n.__e;return"function"==typeof e.type?On(e):null}function Un(e){var t,n;if(null!=(e=e.__)&&null!=e.__c){for(e.__e=e.__c.base=null,t=0;t<e.__k.length;t++)if(null!=(n=e.__k[t])&&null!=n.__e){e.__e=e.__c.base=n.__e;break}return Un(e)}}function Pn(e){(!e.__d&&(e.__d=!0)&&mn.push(e)&&!Dn.__r++||gn!==vn.debounceRendering)&&((gn=vn.debounceRendering)||_n)(Dn)}function Dn(){for(var e;Dn.__r=mn.length;)e=mn.sort((function(e,t){return e.__v.__b-t.__v.__b})),mn=[],e.some((function(e){var t,n,r,o,i,s;e.__d&&(i=(o=(t=e).__v).__e,(s=t.__P)&&(n=[],(r=En({},o)).__v=o.__v+1,Fn(s,o,r,t.__n,void 0!==s.ownerSVGElement,null!=o.__h?[i]:null,n,null==i?On(o):i,o.__h),Mn(n,o),o.__e!=i&&Un(o)))}))}function $n(e,t,n,r,o,i,s,a,c,u){var l,d,f,h,p,y,b,v=r&&r.__k||Sn,m=v.length;for(n.__k=[],l=0;l<t.length;l++)if(null!=(h=n.__k[l]=null==(h=t[l])||"boolean"==typeof h?null:"string"==typeof h||"number"==typeof h||"bigint"==typeof h?Tn(null,h,null,null,h):Array.isArray(h)?Tn(Cn,{children:h},null,null,null):h.__b>0?Tn(h.type,h.props,h.key,null,h.__v):h)){if(h.__=n,h.__b=n.__b+1,null===(f=v[l])||f&&h.key==f.key&&h.type===f.type)v[l]=void 0;else for(d=0;d<m;d++){if((f=v[d])&&h.key==f.key&&h.type===f.type){v[d]=void 0;break}f=null}Fn(e,h,f=f||wn,o,i,s,a,c,u),p=h.__e,(d=h.ref)&&f.ref!=d&&(b||(b=[]),f.ref&&b.push(f.ref,null,h),b.push(d,h.__c||p,h)),null!=p?(null==y&&(y=p),"function"==typeof h.type&&null!=h.__k&&h.__k===f.__k?h.__d=c=Nn(h,c,e):c=jn(e,h,f,v,p,c),u||"option"!==n.type?"function"==typeof n.type&&(n.__d=c):e.value=""):c&&f.__e==c&&c.parentNode!=e&&(c=On(f))}for(n.__e=y,l=m;l--;)null!=v[l]&&("function"==typeof n.type&&null!=v[l].__e&&v[l].__e==n.__d&&(n.__d=On(r,l+1)),Vn(v[l],v[l]));if(b)for(l=0;l<b.length;l++)Kn(b[l],b[++l],b[++l])}function Nn(e,t,n){var r,o;for(r=0;r<e.__k.length;r++)(o=e.__k[r])&&(o.__=e,t="function"==typeof o.type?Nn(o,t,n):jn(n,o,o,e.__k,o.__e,t));return t}function jn(e,t,n,r,o,i){var s,a,c;if(void 0!==t.__d)s=t.__d,t.__d=void 0;else if(null==n||o!=i||null==o.parentNode)e:if(null==i||i.parentNode!==e)e.appendChild(o),s=null;else{for(a=i,c=0;(a=a.nextSibling)&&c<r.length;c+=2)if(a==o)break e;e.insertBefore(o,i),s=i}return void 0!==s?s:o.nextSibling}function Ln(e,t,n){"-"===t[0]?e.setProperty(t,n):e[t]=null==n?"":"number"!=typeof n||kn.test(t)?n:n+"px"}function Rn(e,t,n,r,o){var i;e:if("style"===t)if("string"==typeof n)e.style.cssText=n;else{if("string"==typeof r&&(e.style.cssText=r=""),r)for(t in r)n&&t in n||Ln(e.style,t,"");if(n)for(t in n)r&&n[t]===r[t]||Ln(e.style,t,n[t])}else if("o"===t[0]&&"n"===t[1])i=t!==(t=t.replace(/Capture$/,"")),t=t.toLowerCase()in e?t.toLowerCase().slice(2):t.slice(2),e.l||(e.l={}),e.l[t+i]=n,n?r||e.addEventListener(t,i?Wn:Bn,i):e.removeEventListener(t,i?Wn:Bn,i);else if("dangerouslySetInnerHTML"!==t){if(o)t=t.replace(/xlink[H:h]/,"h").replace(/sName$/,"s");else if("href"!==t&&"list"!==t&&"form"!==t&&"tabIndex"!==t&&"download"!==t&&t in e)try{e[t]=null==n?"":n;break e}catch(e){}"function"==typeof n||(null!=n&&(!1!==n||"a"===t[0]&&"r"===t[1])?e.setAttribute(t,n):e.removeAttribute(t))}}function Bn(e){this.l[e.type+!1](vn.event?vn.event(e):e)}function Wn(e){this.l[e.type+!0](vn.event?vn.event(e):e)}function Fn(e,t,n,r,o,i,s,a,c){var u,l,d,f,h,p,y,b,v,m,_,g=t.type;if(void 0!==t.constructor)return null;null!=n.__h&&(c=n.__h,a=t.__e=n.__e,t.__h=null,i=[a]),(u=vn.__b)&&u(t);try{e:if("function"==typeof g){if(b=t.props,v=(u=g.contextType)&&r[u.__c],m=u?v?v.props.value:u.__:r,n.__c?y=(l=t.__c=n.__c).__=l.__E:("prototype"in g&&g.prototype.render?t.__c=l=new g(b,m):(t.__c=l=new An(b,m),l.constructor=g,l.render=qn),v&&v.sub(l),l.props=b,l.state||(l.state={}),l.context=m,l.__n=r,d=l.__d=!0,l.__h=[]),null==l.__s&&(l.__s=l.state),null!=g.getDerivedStateFromProps&&(l.__s==l.state&&(l.__s=En({},l.__s)),En(l.__s,g.getDerivedStateFromProps(b,l.__s))),f=l.props,h=l.state,d)null==g.getDerivedStateFromProps&&null!=l.componentWillMount&&l.componentWillMount(),null!=l.componentDidMount&&l.__h.push(l.componentDidMount);else{if(null==g.getDerivedStateFromProps&&b!==f&&null!=l.componentWillReceiveProps&&l.componentWillReceiveProps(b,m),!l.__e&&null!=l.shouldComponentUpdate&&!1===l.shouldComponentUpdate(b,l.__s,m)||t.__v===n.__v){l.props=b,l.state=l.__s,t.__v!==n.__v&&(l.__d=!1),l.__v=t,t.__e=n.__e,t.__k=n.__k,t.__k.forEach((function(e){e&&(e.__=t)})),l.__h.length&&s.push(l);break e}null!=l.componentWillUpdate&&l.componentWillUpdate(b,l.__s,m),null!=l.componentDidUpdate&&l.__h.push((function(){l.componentDidUpdate(f,h,p)}))}l.context=m,l.props=b,l.state=l.__s,(u=vn.__r)&&u(t),l.__d=!1,l.__v=t,l.__P=e,u=l.render(l.props,l.state,l.context),l.state=l.__s,null!=l.getChildContext&&(r=En(En({},r),l.getChildContext())),d||null==l.getSnapshotBeforeUpdate||(p=l.getSnapshotBeforeUpdate(f,h)),_=null!=u&&u.type===Cn&&null==u.key?u.props.children:u,$n(e,Array.isArray(_)?_:[_],t,n,r,o,i,s,a,c),l.base=t.__e,t.__h=null,l.__h.length&&s.push(l),y&&(l.__E=l.__=null),l.__e=!1}else null==i&&t.__v===n.__v?(t.__k=n.__k,t.__e=n.__e):t.__e=Hn(n.__e,t,n,r,o,i,s,c);(u=vn.diffed)&&u(t)}catch(e){t.__v=null,(c||null!=i)&&(t.__e=a,t.__h=!!c,i[i.indexOf(a)]=null),vn.__e(e,t,n)}}function Mn(e,t){vn.__c&&vn.__c(t,e),e.some((function(t){try{e=t.__h,t.__h=[],e.some((function(e){e.call(t)}))}catch(e){vn.__e(e,t.__v)}}))}function Hn(e,t,n,r,o,i,s,a){var c,u,l,d,f=n.props,h=t.props,p=t.type,y=0;if("svg"===p&&(o=!0),null!=i)for(;y<i.length;y++)if((c=i[y])&&(c===e||(p?c.localName==p:3==c.nodeType))){e=c,i[y]=null;break}if(null==e){if(null===p)return document.createTextNode(h);e=o?document.createElementNS("http://www.w3.org/2000/svg",p):document.createElement(p,h.is&&h),i=null,a=!1}if(null===p)f===h||a&&e.data===h||(e.data=h);else{if(i=i&&Sn.slice.call(e.childNodes),u=(f=n.props||wn).dangerouslySetInnerHTML,l=h.dangerouslySetInnerHTML,!a){if(null!=i)for(f={},d=0;d<e.attributes.length;d++)f[e.attributes[d].name]=e.attributes[d].value;(l||u)&&(l&&(u&&l.__html==u.__html||l.__html===e.innerHTML)||(e.innerHTML=l&&l.__html||""))}if(function(e,t,n,r,o){var i;for(i in n)"children"===i||"key"===i||i in t||Rn(e,i,null,n[i],r);for(i in t)o&&"function"!=typeof t[i]||"children"===i||"key"===i||"value"===i||"checked"===i||n[i]===t[i]||Rn(e,i,t[i],n[i],r)}(e,h,f,o,a),l)t.__k=[];else if(y=t.props.children,$n(e,Array.isArray(y)?y:[y],t,n,r,o&&"foreignObject"!==p,i,s,e.firstChild,a),null!=i)for(y=i.length;y--;)null!=i[y]&&xn(i[y]);a||("value"in h&&void 0!==(y=h.value)&&(y!==e.value||"progress"===p&&!y)&&Rn(e,"value",y,f.value,!1),"checked"in h&&void 0!==(y=h.checked)&&y!==e.checked&&Rn(e,"checked",y,f.checked,!1))}return e}function Kn(e,t,n){try{"function"==typeof e?e(t):e.current=t}catch(e){vn.__e(e,n)}}function Vn(e,t,n){var r,o,i;if(vn.unmount&&vn.unmount(e),(r=e.ref)&&(r.current&&r.current!==e.__e||Kn(r,null,t)),n||"function"==typeof e.type||(n=null!=(o=e.__e)),e.__e=e.__d=void 0,null!=(r=e.__c)){if(r.componentWillUnmount)try{r.componentWillUnmount()}catch(e){vn.__e(e,t)}r.base=r.__P=null}if(r=e.__k)for(i=0;i<r.length;i++)r[i]&&Vn(r[i],t,n);null!=o&&xn(o)}function qn(e,t,n){return this.constructor(e,n)}vn={__e:function(e,t){for(var n,r,o;t=t.__;)if((n=t.__c)&&!n.__)try{if((r=n.constructor)&&null!=r.getDerivedStateFromError&&(n.setState(r.getDerivedStateFromError(e)),o=n.__d),null!=n.componentDidCatch&&(n.componentDidCatch(e),o=n.__d),o)return n.__E=n}catch(t){e=t}throw e},__v:0},An.prototype.setState=function(e,t){var n;n=null!=this.__s&&this.__s!==this.state?this.__s:this.__s=En({},this.state),"function"==typeof e&&(e=e(En({},n),this.props)),e&&En(n,e),null!=e&&this.__v&&(t&&this.__h.push(t),Pn(this))},An.prototype.forceUpdate=function(e){this.__v&&(this.__e=!0,e&&this.__h.push(e),Pn(this))},An.prototype.render=Cn,mn=[],_n="function"==typeof Promise?Promise.prototype.then.bind(Promise.resolve()):setTimeout,Dn.__r=0;const zn={Error:{color:"red"},Alert:{error:{color:"red"},warning:{color:"yellow"},info:{color:"black"}},Darken:{position:"fixed",top:0,left:0,opacity:.5,backgroundColor:"#000",width:"100vw",height:"100vh",zIndex:150,webkitBackdropFilter:"blur(2px)",backdropFilter:"blur(2px)"},DialogOuter:{position:"fixed",top:0,left:0,width:"100vw",height:"100vh",zIndex:150,alignItems:"center",display:"flex",justifyContent:"center"},DialogInner:{position:"relative",color:"#222",backgroundColor:"#fff",padding:"30px",marginBottom:"2em",maxWidth:"90%",maxHeight:"90%",overflowY:"auto",border:"3px solid #3d3d5d",borderRadius:"8px",boxShadow:"0 0 80px 10px #666",width:"auto"},Input:{height:"35px",width:"17em",borderColor:"#ccf4",outline:"none",fontSize:"17pt",padding:"8px"}};function Gn({children:e}){return In("div",null,In("div",{style:zn.Darken}),In("div",{style:zn.DialogOuter},In("div",{style:zn.DialogInner},e)))}var Jn,Yn,Qn,Xn=0,Zn=[],er=vn.__b,tr=vn.__r,nr=vn.diffed,rr=vn.__c,or=vn.unmount;function ir(e,t){vn.__h&&vn.__h(Yn,e,Xn||t),Xn=0;var n=Yn.__H||(Yn.__H={__:[],__h:[]});return e>=n.__.length&&n.__.push({}),n.__[e]}function sr(e){return Xn=1,function(e,t,n){var r=ir(Jn++,2);return r.t=e,r.__c||(r.__=[n?n(t):hr(void 0,t),function(e){var t=r.t(r.__[0],e);r.__[0]!==t&&(r.__=[t,r.__[1]],r.__c.setState({}))}],r.__c=Yn),r.__}(hr,e)}function ar(e){return Xn=5,function(e,t){var n=ir(Jn++,7);return fr(n.__H,t)&&(n.__=e(),n.__H=t,n.__h=e),n.__}((function(){return{current:e}}),[])}function cr(){Zn.forEach((function(e){if(e.__P)try{e.__H.__h.forEach(lr),e.__H.__h.forEach(dr),e.__H.__h=[]}catch(t){e.__H.__h=[],vn.__e(t,e.__v)}})),Zn=[]}vn.__b=function(e){Yn=null,er&&er(e)},vn.__r=function(e){tr&&tr(e),Jn=0;var t=(Yn=e.__c).__H;t&&(t.__h.forEach(lr),t.__h.forEach(dr),t.__h=[])},vn.diffed=function(e){nr&&nr(e);var t=e.__c;t&&t.__H&&t.__H.__h.length&&(1!==Zn.push(t)&&Qn===vn.requestAnimationFrame||((Qn=vn.requestAnimationFrame)||function(e){var t,n=function(){clearTimeout(r),ur&&cancelAnimationFrame(t),setTimeout(e)},r=setTimeout(n,100);ur&&(t=requestAnimationFrame(n))})(cr)),Yn=void 0},vn.__c=function(e,t){t.some((function(e){try{e.__h.forEach(lr),e.__h=e.__h.filter((function(e){return!e.__||dr(e)}))}catch(n){t.some((function(e){e.__h&&(e.__h=[])})),t=[],vn.__e(n,e.__v)}})),rr&&rr(e,t)},vn.unmount=function(e){or&&or(e);var t=e.__c;if(t&&t.__H)try{t.__H.__.forEach(lr)}catch(e){vn.__e(e,t.__v)}};var ur="function"==typeof requestAnimationFrame;function lr(e){var t=Yn;"function"==typeof e.__c&&e.__c(),Yn=t}function dr(e){var t=Yn;e.__c=e.__(),Yn=t}function fr(e,t){return!e||e.length!==t.length||t.some((function(t,n){return t!==e[n]}))}function hr(e,t){return"function"==typeof t?t(e):t}function pr({title:e,alerts:t,fields:n,onCancel:r,onSubmit:o}){const[i,s]=sr({}),a=ar();return function(e,t){var n=ir(Jn++,4);!vn.__s&&fr(n.__H,t)&&(n.__=e,n.__H=t,Yn.__h.push(n))}((()=>{var e;return null===(e=a.current)||void 0===e?void 0:e.focus()}),[]),In(Gn,null,In(Cn,null,In("h3",{style:zn.WindowHeader},e),t.map((e=>In("p",{style:zn.Alert[e.type]},function({message:e,messageCode:t,messageParams:n}){return e.replace(/\{\w+\}/gi,(e=>n[e.substr(1,e.length-2)]))}(e)))),In("form",{onSubmit:e=>{e.preventDefault(),o(i)}},Object.entries(n).map((([e,{type:t,label:n,placeholder:r}],o)=>In("label",{style:zn.Label},n?`${n}: `:"",In("input",{ref:0===o?a:void 0,type:t,name:e,autoComplete:"on",style:zn.Input,autoFocus:!0,placeholder:r,value:i[e]||"",onInput:n=>{var r;return s({...i,[e]:yr(t,null===(r=n.target)||void 0===r?void 0:r.value)})}})))))),In("div",{style:zn.ButtonsDiv},In("button",{type:"submit",style:zn.Button,onClick:()=>o(i)},"Submit"),In("button",{style:zn.Button,onClick:r},"Cancel")))}function yr(e,t){switch(e){case"email":return t.toLowerCase();case"otp":return t.toUpperCase();default:return t}}class br extends An{constructor(e){super(e),this.observer=e=>this.setState({userInteraction:e}),this.state={userInteraction:void 0}}componentDidMount(){this.subscription=t.from(this.props.db.cloud.userInteraction).subscribe(this.observer)}componentWillUnmount(){this.subscription&&(this.subscription.unsubscribe(),delete this.subscription)}render(e,{userInteraction:t}){return t?In(pr,Object.assign({},t)):null}}function vr(e){const t=document.createElement("div");document.body.appendChild(t),function(e,t,n){var r,o,i;vn.__&&vn.__(e,t),o=(r="function"==typeof n)?null:n&&n.__k||t.__k,i=[],Fn(t,e=(!r&&n||t).__k=In(Cn,null,[e]),o||wn,wn,void 0!==t.ownerSVGElement,!r&&n?[n]:o?null:t.firstChild?Sn.slice.call(t.childNodes):null,i,!r&&n?n:o?o.__e:t.firstChild,r),Mn(i,e)}(In(br,{db:e.vip}),t);let n=!1;return{unsubscribe(){t.remove(),n=!0},get closed(){return n}}}function mr(n){const i=n.name,s=new t.BehaviorSubject(o),a=[];let c=null;n.on("ready",(async n=>{try{await async function(n){var o,i,d,h,p,y;u=!1;const b=f(n);Xe||((null===(o=b.cloud.options)||void 0===o?void 0:o.customLoginGui)||a.push(vr(n)),a.push(b.syncStateChangedEvent.subscribe(n.cloud.syncState)));b.tables.every((e=>e.core))||Ze();const v="serviceWorker"in navigator?await navigator.serviceWorker.getRegistrations():[],m=await b.transaction("rw",b.$syncState,(async()=>{var e,t;const{options:n,schema:r}=b.cloud,[o,i,s]=await Promise.all([b.getOptions(),b.getSchema(),b.getPersistedSyncState()]);if(n?o&&JSON.stringify(o)===JSON.stringify(n)||await b.$syncState.put(n,"options"):b.cloud.options=o||null,(null===(e=b.cloud.options)||void 0===e?void 0:e.tryUseServiceWorker)&&"serviceWorker"in navigator&&v.length>0&&!Qe?(console.debug("Dexie Cloud Addon: Using service worker"),b.cloud.usingServiceWorker=!0):((null===(t=b.cloud.options)||void 0===t?void 0:t.tryUseServiceWorker)&&!Xe&&console.debug("dexie-cloud-addon: Not using service worker.",0===v.length?"No SW registrations found.":"serviceWorker"in navigator&&Qe?"Avoiding SW background sync and SW periodic bg sync for this browser due to browser bugs.":"navigator.serviceWorker not present"),b.cloud.usingServiceWorker=!1),bn(r,b.cloud.options),bn(i,b.cloud.options),r){if(!i||JSON.stringify(i)!==JSON.stringify(r)){const e=i||{};for(const[t,n]of Object.entries(r)){const r=e[t];r?(r.markedForSync=n.markedForSync,n.deleted=r.deleted,r.generatedGlobalId=n.generatedGlobalId):e[t]={...n}}await b.$syncState.put(e,"schema"),Object.assign(r,e)}}else b.cloud.schema=i||null;return null==s?void 0:s.initiallySynced}));m&&b.setInitiallySynced(!0);(function(e){var t,n;for(const o of e.tables)if(null===(n=null===(t=e.cloud.schema)||void 0===t?void 0:t[o.name])||void 0===n?void 0:n.markedForSync){if(o.schema.primKey.auto)throw new r.default.SchemaError(`Table ${o.name} is both autoIncremented and synced. Use db.cloud.configure({unsyncedTables: [${JSON.stringify(o.name)}]}) to blacklist it from sync`);if(!o.schema.primKey.keyPath)throw new r.default.SchemaError(`Table ${o.name} cannot be both synced and outbound. Use db.cloud.configure({unsyncedTables: [${JSON.stringify(o.name)}]}) to blacklist it from sync`)}})(b),(null===(i=b.cloud.options)||void 0===i?void 0:i.databaseUrl)&&!m&&(await async function(e,t,n){console.debug("Performing initial sync"),await wt(e,"initialSync","$jobs",(async()=>{const r=await e.getPersistedSyncState();(null==r?void 0:r.initiallySynced)||await Zt(e,t,n,{isInitialSync:!0})}),{awaitRemoteJob:!0}),console.debug("Done initial sync")}(b,b.cloud.options,b.cloud.schema),b.setInitiallySynced(!0));l(),Xe||(a.push(e.liveQuery((()=>b.getCurrentUser())).subscribe(s)),a.push(e.liveQuery((()=>b.getPersistedSyncState())).subscribe(b.cloud.persistedSyncState)));(null===(d=b.cloud.options)||void 0===d?void 0:d.requireAuth)&&await ze(b);c&&c.stop();c=null,l(),b.cloud.usingServiceWorker&&(null===(h=b.cloud.options)||void 0===h?void 0:h.databaseUrl)?(bt(b).catch((()=>{})),async function(e){var t;try{const{periodicSync:n}=await navigator.serviceWorker.ready;if(n)try{await n.register(`dexie-cloud:${e.name}`,null===(t=e.cloud.options)||void 0===t?void 0:t.periodicSync),console.debug(`Dexie Cloud: Successfully registered periodicsync event for ${e.name}`)}catch(e){console.debug("Dexie Cloud: Failed to register periodic sync. Your PWA must be installed to allow background sync.",e)}else console.debug("Dexie Cloud: periodicSync not supported.")}catch(t){console.debug(`Dexie Cloud: Could not register periodicSync for ${e.name}`,t)}}(b).catch((()=>{}))):(null===(p=b.cloud.options)||void 0===p?void 0:p.databaseUrl)&&b.cloud.schema&&!Xe&&(c=yn(b,b.cloud.options,b.cloud.schema),c.start());l(),Xe||a.push(t.fromEvent(self,"online").subscribe((()=>{console.debug("online!"),b.syncStateChangedEvent.next({phase:"not-in-sync"}),fn(b)})),t.fromEvent(self,"offline").subscribe((()=>{console.debug("offline!"),b.syncStateChangedEvent.next({phase:"offline"})})));"undefined"!=typeof window&&!Xe&&(null===(y=b.cloud.options)||void 0===y?void 0:y.databaseUrl)&&a.push(function(e){var n;if(!(null===(n=e.cloud.options)||void 0===n?void 0:n.databaseUrl))throw new Error("No database URL to connect WebSocket to");return function n(){return nn.pipe(_e((e=>e)),xe((()=>e.cloud.currentUser)),_e((()=>{var t,n;return null===(n=null===(t=e.cloud.persistedSyncState)||void 0===t?void 0:t.value)||void 0===n?void 0:n.serverRevision})),xe((t=>{var n,r;return new un(e.cloud.options.databaseUrl,null===(r=null===(n=e.cloud.persistedSyncState)||void 0===n?void 0:n.value)||void 0===r?void 0:r.serverRevision,t.accessToken,t.accessTokenExpiration)})),Z((r=>t.from(async function(t){if("TokenExpiredError"!==(null==t?void 0:t.name))throw console.error("WebSocket observable:",t),t;{console.debug("WebSocket observable: Token expired. Refreshing token...");const t=e.cloud.currentUser.value,n=await He(e.cloud.options.databaseUrl,t);await e.table("$logins").update(t.userId,{accessToken:n.accessToken,accessTokenExpiration:n.accessTokenExpiration})}}(r)).pipe(xe((()=>n())),Z((e=>(console.error("WebSocket observable: error but revive when user does some active thing...",e),t.of(!0).pipe(pe(3e3),xe((()=>an)),Se(1),xe((()=>n()))))))))))}().subscribe((async t=>{var n,r;const o=await e.getPersistedSyncState();switch(t.type){case"rev":(!(null==o?void 0:o.serverRevision)||Kt.compare(o.serverRevision,"undefined"==typeof BigInt?new Kt(t.rev):BigInt(t.rev))<0)&&fn(e);break;case"realm-added":(null===(n=null==o?void 0:o.realms)||void 0===n?void 0:n.includes(t.realm))||fn(e);break;case"realm-removed":(null===(r=null==o?void 0:o.realms)||void 0===r?void 0:r.includes(t.realm))&&fn(e)}}))}(b))}(n)}catch(e){console.error(e)}}),!0);let u=!1;function l(){if(u)throw new r.default.DatabaseClosedError}var d;!function(e,t){e.on.close.subscribe(t);const n=e.close;e.close=function(){n.call(this),t()}}(n,(()=>{a.forEach((e=>e.unsubscribe())),u=!0,c&&c.stop(),c=null,s.next(o)})),n.cloud={version:"1.0.0-beta.6",options:null,schema:null,serverState:null,get currentUserId(){return s.value.userId||o.userId},currentUser:s,syncState:new t.BehaviorSubject({phase:"initial"}),persistedSyncState:new t.BehaviorSubject(void 0),userInteraction:new t.BehaviorSubject(void 0),async login(e){const t=f(n);await t.cloud.sync(),await ze(t,e)},configure(e){n.cloud.options=e,e.databaseUrl&&(n.name=`${i}-${function(e){const t=new URL(e);return"/"===t.pathname?t.hostname.split(".")[0]:t.pathname.split("/")[1]}(e.databaseUrl)}`,f(n).reconfigure()),bn(n.cloud.schema,n.cloud.options)},async sync({wait:r,force:o}={wait:!0,force:!1}){void 0===r&&(r=!0);const i=f(n);if(o){const e=i.cloud.persistedSyncState.value;if(fn(i),r){const t=await i.cloud.persistedSyncState.pipe(_e((t=>null!=(null==t?void 0:t.timestamp)&&(!e||t.timestamp>e.timestamp))),Se(1)).toPromise();if(null==t?void 0:t.error)throw new Error("Sync error: "+t.error)}}else if(await hn(i)){const n=i.cloud.persistedSyncState.value;fn(i),r&&(console.debug("db.cloud.login() is waiting for sync completion..."),await t.from(e.liveQuery((async()=>{const e=await hn(i),t=await i.getPersistedSyncState();if((null==t?void 0:t.timestamp)!==(null==n?void 0:n.timestamp)&&(null==t?void 0:t.error))throw new Error("Sync error: "+t.error);return e}))).pipe(_e((e=>!e)),Se(1)).toPromise(),console.debug("Done waiting for sync completion because we have nothing to push anymore"))}}},n.Version.prototype._parseStoresSpec=r.default.override(n.Version.prototype._parseStoresSpec,(e=>_t(e,n))),n.use(mt({currentUserObservable:n.cloud.currentUser,db:f(n)})),n.use((d=f(n),{stack:"dbcore",name:"implicitPropSetterMiddleware",level:1,create:e=>({...e,table:t=>{const n=e.table(t);return{...n,mutate:e=>{var r,o,i;const s=e.trans;if((null===(o=null===(r=d.cloud.schema)||void 0===r?void 0:r[t])||void 0===o?void 0:o.markedForSync)&&(null===(i=s.currentUser)||void 0===i?void 0:i.isLoggedIn)&&("add"===e.type||"put"===e.type))for(const t of e.values)"owner"in t||(t.owner=s.currentUser.userId),"realmId"in t||(t.realmId=s.currentUser.userId);return n.mutate(e)}}}})})),n.use(ut(f(n)))}mr.version="1.0.0-beta.6",r.default.Cloud=mr;const _r=new Map;function gr(e){return e.startsWith("dexie-cloud:")&&e.split(":")[1]}async function wr(e){var t;let n=_r.get(e);if(!n){console.debug("Dexie Cloud SW: Creating new Dexie instance for",e);const t=new r.default(e,{addons:[mr]});n=f(t),t.on("versionchange",o),await n.dx.open(),_r.get(e)||_r.set(e,n)}if(null===(t=n.cloud.options)||void 0===t?void 0:t.databaseUrl)if(n.cloud.schema)try{console.debug("Dexie Cloud SW: Syncing"),await pn(n,n.cloud.options,n.cloud.schema,{retryImmediatelyOnFetchError:!0}),console.debug("Dexie Cloud SW: Done Syncing")}catch(e){if(console.error("Dexie Cloud SW Error",e),o(),e.name!==r.default.errnames.NoSuchDatabase)throw e}else console.error("Dexie Cloud: No schema persisted");else console.error("Dexie Cloud: No databaseUrl configured");function o(){return n.dx.on.versionchange.unsubscribe(o),_r.get(n.name)===n&&_r.delete(n.name),n.dx.close(),!1}}Qe||(self.addEventListener("sync",(e=>{console.debug('SW "sync" Event',e.tag);const t=gr(e.tag);t&&e.waitUntil(wr(t))})),self.addEventListener("periodicsync",(e=>{console.debug('SW "periodicsync" Event',e.tag);const t=gr(e.tag);t&&e.waitUntil(wr(t))})),self.addEventListener("message",(e=>{if(console.debug('SW "message" Event',e.data),"dexie-cloud-sync"===e.data.type){const{dbName:t}=e.data,n=(e=1)=>wr(t).catch((async t=>{if(3===e)throw t;var r;await(r=6e4,new Promise((e=>setTimeout(e,r)))),n(e+1)}));"waitUntil"in e?e.waitUntil(n()):n()}})))}));