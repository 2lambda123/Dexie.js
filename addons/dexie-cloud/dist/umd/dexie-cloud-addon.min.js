(function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("dexie"),require("rxjs")):"function"==typeof define&&define.amd?define(["exports","dexie","rxjs"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).DexieCloud={},e.Dexie,e.rxjs)})(this,function(e,b,y){"use strict";function t(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var m=t(b),r=function(e,t){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])})(e,t)};function n(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function n(){this.constructor=e}r(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}var _=function(){return(_=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var o in t=arguments[n])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e}).apply(this,arguments)};function S(e,s,u,a){return new(u=u||Promise)(function(n,t){function r(e){try{i(a.next(e))}catch(e){t(e)}}function o(e){try{i(a.throw(e))}catch(e){t(e)}}function i(e){var t;e.done?n(e.value):((t=e.value)instanceof u?t:new u(function(e){e(t)})).then(r,o)}i((a=a.apply(e,s||[])).next())})}function k(n,r){var o,i,s,u={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]},e={next:t(0),throw:t(1),return:t(2)};return"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function t(t){return function(e){return function(t){if(o)throw new TypeError("Generator is already executing.");for(;u;)try{if(o=1,i&&(s=2&t[0]?i.return:t[0]?i.throw||((s=i.return)&&s.call(i),0):i.next)&&!(s=s.call(i,t[1])).done)return s;switch(i=0,(t=s?[2&t[0],s.value]:t)[0]){case 0:case 1:s=t;break;case 4:return u.label++,{value:t[1],done:!1};case 5:u.label++,i=t[1],t=[0];continue;case 7:t=u.ops.pop(),u.trys.pop();continue;default:if(!(s=0<(s=u.trys).length&&s[s.length-1])&&(6===t[0]||2===t[0])){u=0;continue}if(3===t[0]&&(!s||t[1]>s[0]&&t[1]<s[3])){u.label=t[1];break}if(6===t[0]&&u.label<s[1]){u.label=s[1],s=t;break}if(s&&u.label<s[2]){u.label=s[2],u.ops.push(t);break}s[2]&&u.ops.pop(),u.trys.pop();continue}t=r.call(n,u)}catch(e){t=[6,e],i=0}finally{o=s=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}([t,e])}}}function g(e,t){for(var n=0,r=t.length,o=e.length;n<r;n++,o++)e[o]=t[n];return e}var o=crypto.getRandomValues;function w(e,t,n){if(e&&void 0!==t&&!("isFrozen"in Object&&Object.isFrozen(e)))if("string"!=typeof t&&"length"in t){(function(e){if(!e)throw new Error("Assertion Failed")})("string"!=typeof n&&"length"in n);for(var r=0,o=t.length;r<o;++r)w(e,t[r],n[r])}else{var i,s=t.indexOf(".");-1!==s?(i=t.substr(0,s),""===(s=t.substr(s+1))?void 0===n?Array.isArray(e)?isNaN(parseInt(i))||e.splice(parseInt(i),1):delete e[i]:e[i]=n:w(e[i]||(e[i]={}),s,n)):void 0===n?Array.isArray(e)&&!isNaN(parseInt(t))?e.splice(t,1):delete e[t]:e[t]=n}}var E="undefined"==typeof self?function(e){e=Buffer.alloc(e);return o(e),e.toString("base64")}:function(e){e=new Uint8Array(e);return crypto.getRandomValues(e),btoa(String.fromCharCode.apply(null,e))};function a(e){return"string"==typeof e||!!(Array.isArray(e)&&e.some(a)&&e.every(i))}function i(e){return"string"==typeof e||"number"==typeof e||Array.isArray(e)&&e.every(i)}function s(e,t){for(var n=0,r=t;n<r.length;n++)for(var o=r[n],i=o.table,s=0,u=o.muts;s<u.length;s++)(function(e,t,a){var c=e[t]||(e[t]={});switch(a.type){case"insert":case"upsert":a.keys.forEach(function(e,t){c[e]={type:"ups",val:a.values[t]}});break;case"update":case"modify":a.keys.forEach(function(e,t){var n="update"===a.type?a.changeSpecs[t]:a.changeSpec,r=c[e];if(r)switch(r.type){case"ups":for(var o=0,i=Object.entries(n);o<i.length;o++){var s=i[o],u=s[0],s=s[1];w(r.val,u,s)}break;case"del":break;case"upd":Object.assign(r.mod,n)}else c[e]={type:"upd",mod:n}});break;case"delete":a.keys.forEach(function(e){c[e]={type:"del"}})}})(e,i,u[s])}var u=function(e,t){return(u=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(e,t)};function c(e,t){function n(){this.constructor=e}u(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}function l(e){return"function"==typeof e}var f=!1,d={Promise:void 0,set useDeprecatedSynchronousErrorHandling(e){e&&(new Error).stack,f=e},get useDeprecatedSynchronousErrorHandling(){return f}};function h(e){setTimeout(function(){throw e},0)}var p={closed:!0,next:function(e){},error:function(e){if(d.useDeprecatedSynchronousErrorHandling)throw e;h(e)},complete:function(){}},v=function(){return Array.isArray||function(e){return e&&"number"==typeof e.length}}();function x(e){return null!==e&&"object"==typeof e}var I=function(){function e(e){return Error.call(this),this.message=e?e.length+" errors occurred during unsubscription:\n"+e.map(function(e,t){return t+1+") "+e.toString()}).join("\n  "):"",this.name="UnsubscriptionError",this.errors=e,this}return e.prototype=Object.create(Error.prototype),e}(),T=function(){function a(e){this.closed=!1,this._parentOrParents=null,this._subscriptions=null,e&&(this._ctorUnsubscribe=!0,this._unsubscribe=e)}var e;return a.prototype.unsubscribe=function(){var t;if(!this.closed){var e=this._parentOrParents,n=this._ctorUnsubscribe,r=this._unsubscribe,o=this._subscriptions;if(this.closed=!0,this._parentOrParents=null,this._subscriptions=null,e instanceof a)e.remove(this);else if(null!==e)for(var i=0;i<e.length;++i)e[i].remove(this);if(l(r)){n&&(this._unsubscribe=void 0);try{r.call(this)}catch(e){t=e instanceof I?C(e.errors):[e]}}if(v(o))for(var i=-1,s=o.length;++i<s;){var u=o[i];if(x(u))try{u.unsubscribe()}catch(e){t=t||[],e instanceof I?t=t.concat(C(e.errors)):t.push(e)}}if(t)throw new I(t)}},a.prototype.add=function(e){var t,n=e;if(!e)return a.EMPTY;switch(typeof e){case"function":n=new a(e);case"object":if(n===this||n.closed||"function"!=typeof n.unsubscribe)return n;if(this.closed)return n.unsubscribe(),n;n instanceof a||(t=n,(n=new a)._subscriptions=[t]);break;default:throw new Error("unrecognized teardown "+e+" added to Subscription.")}var r=n._parentOrParents;if(null===r)n._parentOrParents=this;else if(r instanceof a){if(r===this)return n;n._parentOrParents=[r,this]}else{if(-1!==r.indexOf(this))return n;r.push(this)}r=this._subscriptions;return null===r?this._subscriptions=[n]:r.push(n),n},a.prototype.remove=function(e){var t=this._subscriptions;!t||-1!==(e=t.indexOf(e))&&t.splice(e,1)},a.EMPTY=((e=new a).closed=!0,e),a}();function C(e){return e.reduce(function(e,t){return e.concat(t instanceof I?t.errors:t)},[])}var A=function(){return"function"==typeof Symbol?Symbol("rxSubscriber"):"@@rxSubscriber_"+Math.random()}(),O=function(o){function i(e,t,n){var r=o.call(this)||this;switch(r.syncErrorValue=null,r.syncErrorThrown=!1,r.syncErrorThrowable=!1,r.isStopped=!1,arguments.length){case 0:r.destination=p;break;case 1:if(!e){r.destination=p;break}if("object"==typeof e){e instanceof i?(r.syncErrorThrowable=e.syncErrorThrowable,(r.destination=e).add(r)):(r.syncErrorThrowable=!0,r.destination=new P(r,e));break}default:r.syncErrorThrowable=!0,r.destination=new P(r,e,t,n)}return r}return c(i,o),i.prototype[A]=function(){return this},i.create=function(e,t,n){n=new i(e,t,n);return n.syncErrorThrowable=!1,n},i.prototype.next=function(e){this.isStopped||this._next(e)},i.prototype.error=function(e){this.isStopped||(this.isStopped=!0,this._error(e))},i.prototype.complete=function(){this.isStopped||(this.isStopped=!0,this._complete())},i.prototype.unsubscribe=function(){this.closed||(this.isStopped=!0,o.prototype.unsubscribe.call(this))},i.prototype._next=function(e){this.destination.next(e)},i.prototype._error=function(e){this.destination.error(e),this.unsubscribe()},i.prototype._complete=function(){this.destination.complete(),this.unsubscribe()},i.prototype._unsubscribeAndRecycle=function(){var e=this._parentOrParents;return this._parentOrParents=null,this.unsubscribe(),this.closed=!1,this.isStopped=!1,this._parentOrParents=e,this},i}(T),P=function(s){function e(e,t,n,r){var o,i=s.call(this)||this;i._parentSubscriber=e;e=i;return l(t)?o=t:t&&(o=t.next,n=t.error,r=t.complete,t!==p&&(l((e=Object.create(t)).unsubscribe)&&i.add(e.unsubscribe.bind(e)),e.unsubscribe=i.unsubscribe.bind(i))),i._context=e,i._next=o,i._error=n,i._complete=r,i}return c(e,s),e.prototype.next=function(e){var t;!this.isStopped&&this._next&&(t=this._parentSubscriber,d.useDeprecatedSynchronousErrorHandling&&t.syncErrorThrowable?this.__tryOrSetError(t,this._next,e)&&this.unsubscribe():this.__tryOrUnsub(this._next,e))},e.prototype.error=function(e){if(!this.isStopped){var t=this._parentSubscriber,n=d.useDeprecatedSynchronousErrorHandling;if(this._error)n&&t.syncErrorThrowable?this.__tryOrSetError(t,this._error,e):this.__tryOrUnsub(this._error,e),this.unsubscribe();else if(t.syncErrorThrowable)n?(t.syncErrorValue=e,t.syncErrorThrown=!0):h(e),this.unsubscribe();else{if(this.unsubscribe(),n)throw e;h(e)}}},e.prototype.complete=function(){var e,t,n=this;this.isStopped||(e=this._parentSubscriber,this._complete&&(t=function(){return n._complete.call(n._context)},d.useDeprecatedSynchronousErrorHandling&&e.syncErrorThrowable?this.__tryOrSetError(e,t):this.__tryOrUnsub(t)),this.unsubscribe())},e.prototype.__tryOrUnsub=function(e,t){try{e.call(this._context,t)}catch(e){if(this.unsubscribe(),d.useDeprecatedSynchronousErrorHandling)throw e;h(e)}},e.prototype.__tryOrSetError=function(t,e,n){if(!d.useDeprecatedSynchronousErrorHandling)throw new Error("bad call");try{e.call(this._context,n)}catch(e){return d.useDeprecatedSynchronousErrorHandling?(t.syncErrorValue=e,t.syncErrorThrown=!0):(h(e),!0)}return!1},e.prototype._unsubscribe=function(){var e=this._parentSubscriber;this._context=null,this._parentSubscriber=null,e.unsubscribe()},e}(O);var U=function(){return"function"==typeof Symbol&&Symbol.observable||"@@observable"}();function D(e){return e}var j=function(){function n(e){this._isScalar=!1,e&&(this._subscribe=e)}return n.prototype.lift=function(e){var t=new n;return t.source=this,t.operator=e,t},n.prototype.subscribe=function(e,t,n){var r=this.operator,n=function(e,t,n){if(e){if(e instanceof O)return e;if(e[A])return e[A]()}return e||t||n?new O(e,t,n):new O(p)}(e,t,n);if(r?n.add(r.call(n,this.source)):n.add(this.source||d.useDeprecatedSynchronousErrorHandling&&!n.syncErrorThrowable?this._subscribe(n):this._trySubscribe(n)),d.useDeprecatedSynchronousErrorHandling&&n.syncErrorThrowable&&(n.syncErrorThrowable=!1,n.syncErrorThrown))throw n.syncErrorValue;return n},n.prototype._trySubscribe=function(t){try{return this._subscribe(t)}catch(e){d.useDeprecatedSynchronousErrorHandling&&(t.syncErrorThrown=!0,t.syncErrorValue=e),!function(e){for(;e;){var t=e.closed,n=e.destination,r=e.isStopped;if(t||r)return;e=n&&n instanceof O?n:null}return 1}(t)?console.warn(e):t.error(e)}},n.prototype.forEach=function(r,e){var o=this;return new(e=N(e))(function(e,t){var n=o.subscribe(function(e){try{r(e)}catch(e){t(e),n&&n.unsubscribe()}},t,e)})},n.prototype._subscribe=function(e){var t=this.source;return t&&t.subscribe(e)},n.prototype[U]=function(){return this},n.prototype.pipe=function(){for(var t,e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];return 0===e.length?this:(0===(t=e).length?D:1===t.length?t[0]:function(e){return t.reduce(function(e,t){return t(e)},e)})(this)},n.prototype.toPromise=function(e){var r=this;return new(e=N(e))(function(e,t){var n;r.subscribe(function(e){return n=e},function(e){return t(e)},function(){return e(n)})})},n.create=function(e){return new n(e)},n}();function N(e){if(!(e=e||Promise))throw new Error("no Promise impl found");return e}var L=function(r){return function(e){for(var t=0,n=r.length;t<n&&!e.closed;t++)e.next(r[t]);e.complete()}};function R(){return"function"==typeof Symbol&&Symbol.iterator?Symbol.iterator:"@@iterator"}var B=R(),$=function(e){return e&&"number"==typeof e.length&&"function"!=typeof e};function W(e){return e&&"function"!=typeof e.subscribe&&"function"==typeof e.then}var F=function(e){if(e&&"function"==typeof e[U])return o=e,function(e){var t=o[U]();if("function"!=typeof t.subscribe)throw new TypeError("Provided object does not correctly implement Symbol.observable");return t.subscribe(e)};if($(e))return L(e);if(W(e))return n=e,function(t){return n.then(function(e){t.closed||(t.next(e),t.complete())},function(e){return t.error(e)}).then(null,h),t};if(e&&"function"==typeof e[B])return r=e,function(t){for(var e=r[B]();;){var n=void 0;try{n=e.next()}catch(e){return t.error(e),t}if(n.done){t.complete();break}if(t.next(n.value),t.closed)break}return"function"==typeof e.return&&t.add(function(){e.return&&e.return()}),t};var r,n,o,e=x(e)?"an invalid object":"'"+e+"'";throw new TypeError("You provided "+e+" where a stream was expected. You can provide an Observable, Promise, Array, or Iterable.")},M=function(n){function e(e){var t=n.call(this)||this;return t.parent=e,t}return c(e,n),e.prototype._next=function(e){this.parent.notifyNext(e)},e.prototype._error=function(e){this.parent.notifyError(e),this.unsubscribe()},e.prototype._complete=function(){this.parent.notifyComplete(),this.unsubscribe()},e}(O),H=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return c(t,e),t.prototype.notifyNext=function(e){this.destination.next(e)},t.prototype.notifyError=function(e){this.destination.error(e)},t.prototype.notifyComplete=function(){this.destination.complete()},t}(O);function K(e,t){if(!t.closed){if(e instanceof j)return e.subscribe(t);var n;try{n=F(e)(t)}catch(e){t.error(e)}return n}}var V=function(r){function e(e,t){var n=r.call(this,e,t)||this;return n.scheduler=e,n.work=t,n.pending=!1,n}return c(e,r),e.prototype.schedule=function(e,t){if(void 0===t&&(t=0),this.closed)return this;this.state=e;var n=this.id,e=this.scheduler;return null!=n&&(this.id=this.recycleAsyncId(e,n,t)),this.pending=!0,this.delay=t,this.id=this.id||this.requestAsyncId(e,this.id,t),this},e.prototype.requestAsyncId=function(e,t,n){return void 0===n&&(n=0),setInterval(e.flush.bind(e,this),n)},e.prototype.recycleAsyncId=function(e,t,n){if(null!==(n=void 0===n?0:n)&&this.delay===n&&!1===this.pending)return t;clearInterval(t)},e.prototype.execute=function(e,t){if(this.closed)return new Error("executing a cancelled action");this.pending=!1;t=this._execute(e,t);if(t)return t;!1===this.pending&&null!=this.id&&(this.id=this.recycleAsyncId(this.scheduler,this.id,null))},e.prototype._execute=function(e,t){var n=!1,r=void 0;try{this.work(e)}catch(e){n=!0,r=!!e&&e||new Error(e)}if(n)return this.unsubscribe(),r},e.prototype._unsubscribe=function(){var e=this.id,t=this.scheduler,n=t.actions,r=n.indexOf(this);this.work=null,this.state=null,this.pending=!1,this.scheduler=null,-1!==r&&n.splice(r,1),null!=e&&(this.id=this.recycleAsyncId(t,e,null)),this.delay=null},e}(function(n){function e(e,t){return n.call(this)||this}return c(e,n),e.prototype.schedule=function(e,t){return this},e}(T)),q=function(){function n(e,t){void 0===t&&(t=n.now),this.SchedulerAction=e,this.now=t}return n.prototype.schedule=function(e,t,n){return void 0===t&&(t=0),new this.SchedulerAction(this,e).schedule(n,t)},n.now=function(){return Date.now()},n}(),z=new(function(r){function o(e,t){void 0===t&&(t=q.now);var n=r.call(this,e,function(){return o.delegate&&o.delegate!==n?o.delegate.now():t()})||this;return n.actions=[],n.active=!1,n.scheduled=void 0,n}return c(o,r),o.prototype.schedule=function(e,t,n){return void 0===t&&(t=0),o.delegate&&o.delegate!==this?o.delegate.schedule(e,t,n):r.prototype.schedule.call(this,e,t,n)},o.prototype.flush=function(e){var t,n=this.actions;if(this.active)n.push(e);else{this.active=!0;do{if(t=e.execute(e.state,e.delay))break}while(e=n.shift());if(this.active=!1,t){for(;e=n.shift();)e.unsubscribe();throw t}}},o}(q))(V);function G(n){return function(e){var t=new J(n),e=e.lift(t);return t.caught=e}}var J=function(){function e(e){this.selector=e}return e.prototype.call=function(e,t){return t.subscribe(new Y(e,this.selector,this.caught))},e}(),Y=function(o){function e(e,t,n){e=o.call(this,e)||this;return e.selector=t,e.caught=n,e}return c(e,o),e.prototype.error=function(e){if(!this.isStopped){var t=void 0;try{t=this.selector(e,this.caught)}catch(e){return void o.prototype.error.call(this,e)}this._unsubscribeAndRecycle();var n=new M(this);this.add(n);var r=K(t,n);r!==n&&this.add(r)}},e}(H);function Q(r,o){return new j(function(e){var t=new T,n=0;return t.add(o.schedule(function(){n!==r.length?(e.next(r[n++]),e.closed||t.add(this.schedule())):e.complete()})),t})}function X(e,t){if(null!=e){if((n=e)&&"function"==typeof n[U])return i=e,s=t,new j(function(t){var n=new T;return n.add(s.schedule(function(){var e=i[U]();n.add(e.subscribe({next:function(e){n.add(s.schedule(function(){return t.next(e)}))},error:function(e){n.add(s.schedule(function(){return t.error(e)}))},complete:function(){n.add(s.schedule(function(){return t.complete()}))}}))})),n});if(W(e))return r=e,o=t,new j(function(t){var n=new T;return n.add(o.schedule(function(){return r.then(function(e){n.add(o.schedule(function(){t.next(e),n.add(o.schedule(function(){return t.complete()}))}))},function(e){n.add(o.schedule(function(){return t.error(e)}))})})),n});if($(e))return Q(e,t);if((n=e)&&"function"==typeof n[B]||"string"==typeof e)return function(t,n){if(!t)throw new Error("Iterable cannot be null");return new j(function(r){var o,e=new T;return e.add(function(){o&&"function"==typeof o.return&&o.return()}),e.add(n.schedule(function(){o=t[B](),e.add(n.schedule(function(){if(!r.closed){try{var e=o.next(),t=e.value,n=e.done}catch(e){return void r.error(e)}n?r.complete():(r.next(t),this.schedule())}}))})),e})}(e,t)}var r,o,i,s,n;throw new TypeError((null!==e&&typeof e||e)+" is not observable")}function Z(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var n,r,o=e[e.length-1];return(r=o)&&"function"==typeof r.schedule?(e.pop(),Q(e,o)):(o=e,n?Q(o,n):new j(L(o)))}function ee(t,n){return function(e){if("function"!=typeof t)throw new TypeError("argument is not a function. Are you looking for `mapTo()`?");return e.lift(new te(t,n))}}var te=function(){function e(e,t){this.project=e,this.thisArg=t}return e.prototype.call=function(e,t){return t.subscribe(new ne(e,this.project,this.thisArg))},e}(),ne=function(r){function e(e,t,n){e=r.call(this,e)||this;return e.project=t,e.count=0,e.thisArg=n||e,e}return c(e,r),e.prototype._next=function(e){var t;try{t=this.project.call(this.thisArg,e,this.count++)}catch(e){return void this.destination.error(e)}this.destination.next(t)},e}(O);function re(e){return e instanceof Date&&!isNaN(+e)}var oe=new j(function(e){return e.complete()});function ie(e){return e?(t=e,new j(function(e){return t.schedule(function(){return e.complete()})})):oe;var t}function se(t,n){return new j(n?function(e){return n.schedule(ue,0,{error:t,subscriber:e})}:function(e){return e.error(t)})}function ue(e){var t=e.error;e.subscriber.error(t)}var ae=function(){function t(e,t,n){this.kind=e,this.value=t,this.error=n,this.hasValue="N"===e}return t.prototype.observe=function(e){switch(this.kind){case"N":return e.next&&e.next(this.value);case"E":return e.error&&e.error(this.error);case"C":return e.complete&&e.complete()}},t.prototype.do=function(e,t,n){switch(this.kind){case"N":return e&&e(this.value);case"E":return t&&t(this.error);case"C":return n&&n()}},t.prototype.accept=function(e,t,n){return e&&"function"==typeof e.next?this.observe(e):this.do(e,t,n)},t.prototype.toObservable=function(){switch(this.kind){case"N":return Z(this.value);case"E":return se(this.error);case"C":return ie()}throw new Error("unexpected notification kind value")},t.createNext=function(e){return void 0!==e?new t("N",e):t.undefinedValueNotification},t.createError=function(e){return new t("E",void 0,e)},t.createComplete=function(){return t.completeNotification},t.completeNotification=new t("C"),t.undefinedValueNotification=new t("N",void 0),t}();function ce(e,t){void 0===t&&(t=z);var n=re(e)?+e-t.now():Math.abs(e);return function(e){return e.lift(new le(n,t))}}var le=function(){function e(e,t){this.delay=e,this.scheduler=t}return e.prototype.call=function(e,t){return t.subscribe(new fe(e,this.delay,this.scheduler))},e}(),fe=function(r){function t(e,t,n){e=r.call(this,e)||this;return e.delay=t,e.scheduler=n,e.queue=[],e.active=!1,e.errored=!1,e}return c(t,r),t.dispatch=function(e){for(var t,n=e.source,r=n.queue,o=e.scheduler,i=e.destination;0<r.length&&r[0].time-o.now()<=0;)r.shift().notification.observe(i);0<r.length?(t=Math.max(0,r[0].time-o.now()),this.schedule(e,t)):(this.unsubscribe(),n.active=!1)},t.prototype._schedule=function(e){this.active=!0,this.destination.add(e.schedule(t.dispatch,this.delay,{source:this,destination:this.destination,scheduler:e}))},t.prototype.scheduleNotification=function(e){var t;!0!==this.errored&&(t=this.scheduler,e=new de(t.now()+this.delay,e),this.queue.push(e),!1===this.active&&this._schedule(t))},t.prototype._next=function(e){this.scheduleNotification(ae.createNext(e))},t.prototype._error=function(e){this.errored=!0,this.queue=[],this.destination.error(e),this.unsubscribe()},t.prototype._complete=function(){this.scheduleNotification(ae.createComplete()),this.unsubscribe()},t}(O),de=function(){return function(e,t){this.time=e,this.notification=t}}(),he=function(){function e(){return Error.call(this),this.message="argument out of range",this.name="ArgumentOutOfRangeError",this}return e.prototype=Object.create(Error.prototype),e}();function pe(t,n){return function(e){return e.lift(new ve(t,n))}}var ve=function(){function e(e,t){this.predicate=e,this.thisArg=t}return e.prototype.call=function(e,t){return t.subscribe(new be(e,this.predicate,this.thisArg))},e}(),be=function(r){function e(e,t,n){e=r.call(this,e)||this;return e.predicate=t,e.thisArg=n,e.count=0,e}return c(e,r),e.prototype._next=function(e){var t;try{t=this.predicate.call(this.thisArg,e,this.count++)}catch(e){return void this.destination.error(e)}t&&this.destination.next(e)},e}(O);function ye(t){return function(e){return 0===t?ie():e.lift(new me(t))}}var me=function(){function e(e){if(this.total=e,this.total<0)throw new he}return e.prototype.call=function(e,t){return t.subscribe(new _e(e,this.total))},e}(),_e=function(n){function e(e,t){e=n.call(this,e)||this;return e.total=t,e.count=0,e}return c(e,n),e.prototype._next=function(e){var t=this.total,n=++this.count;n<=t&&(this.destination.next(e),n===t&&(this.destination.complete(),this.unsubscribe()))},e}(O);function ge(o,i){return"function"==typeof i?function(e){return e.pipe(ge(function(n,r){return e=o(n,r),(t?X(e,t):e instanceof j?e:new j(F(e))).pipe(ee(function(e,t){return i(n,e,r,t)}));var e,t}))}:function(e){return e.lift(new we(o))}}var we=function(){function e(e){this.project=e}return e.prototype.call=function(e,t){return t.subscribe(new Se(e,this.project))},e}(),Se=function(n){function e(e,t){e=n.call(this,e)||this;return e.project=t,e.index=0,e}return c(e,n),e.prototype._next=function(e){var t,n=this.index++;try{t=this.project(e,n)}catch(e){return void this.destination.error(e)}this._innerSub(t)},e.prototype._innerSub=function(e){var t=this.innerSubscription;t&&t.unsubscribe();var n=new M(this),t=this.destination;t.add(n),this.innerSubscription=K(e,n),this.innerSubscription!==n&&t.add(this.innerSubscription)},e.prototype._complete=function(){var e=this.innerSubscription;e&&!e.closed||n.prototype._complete.call(this),this.unsubscribe()},e.prototype._unsubscribe=function(){this.innerSubscription=void 0},e.prototype.notifyComplete=function(){this.innerSubscription=void 0,this.isStopped&&n.prototype._complete.call(this)},e.prototype.notifyNext=function(e){this.destination.next(e)},e}(H);function ke(){}function Ee(t,n,r){return function(e){return e.lift(new xe(t,n,r))}}var xe=function(){function e(e,t,n){this.nextOrObserver=e,this.error=t,this.complete=n}return e.prototype.call=function(e,t){return t.subscribe(new Ie(e,this.nextOrObserver,this.error,this.complete))},e}(),Ie=function(o){function e(e,t,n,r){e=o.call(this,e)||this;return e._tapNext=ke,e._tapError=ke,e._tapComplete=ke,e._tapError=n||ke,e._tapComplete=r||ke,l(t)?(e._context=e)._tapNext=t:t&&(e._context=t,e._tapNext=t.next||ke,e._tapError=t.error||ke,e._tapComplete=t.complete||ke),e}return c(e,o),e.prototype._next=function(e){try{this._tapNext.call(this._context,e)}catch(e){return void this.destination.error(e)}this.destination.next(e)},e.prototype._error=function(e){try{this._tapError.call(this._context,e)}catch(e){return void this.destination.error(e)}this.destination.error(e)},e.prototype._complete=function(){try{this._tapComplete.call(this._context)}catch(e){return void this.destination.error(e)}return this.destination.complete()},e}(O),Te=function(){function e(){return Error.call(this),this.message="Timeout has occurred",this.name="TimeoutError",this}return e.prototype=Object.create(Error.prototype),e}();var Ce=function(){function e(e,t,n,r){this.waitFor=e,this.absoluteTimeout=t,this.withObservable=n,this.scheduler=r}return e.prototype.call=function(e,t){return t.subscribe(new Ae(e,this.absoluteTimeout,this.waitFor,this.withObservable,this.scheduler))},e}(),Ae=function(i){function t(e,t,n,r,o){e=i.call(this,e)||this;return e.absoluteTimeout=t,e.waitFor=n,e.withObservable=r,e.scheduler=o,e.scheduleTimeout(),e}return c(t,i),t.dispatchTimeout=function(e){var t=e.withObservable;e._unsubscribeAndRecycle(),e.add(K(t,new M(e)))},t.prototype.scheduleTimeout=function(){var e=this.action;e?this.action=e.schedule(this,this.waitFor):this.add(this.action=this.scheduler.schedule(t.dispatchTimeout,this.waitFor,this))},t.prototype._next=function(e){this.absoluteTimeout||this.scheduleTimeout(),i.prototype._next.call(this,e)},t.prototype._unsubscribe=function(){this.action=void 0,this.scheduler=null,this.withObservable=null},t}(H);function Oe(e,t){return void 0===t&&(t=z),r=e,o=se(new Te),void 0===(i=t)&&(i=z),function(e){var t=re(r),n=t?+r-i.now():Math.abs(r);return e.lift(new Ce(n,t,o,i))};var r,o,i}var Pe="undefined"!=typeof Buffer?function(e){return Buffer.from(e,"base64")}:function(e){for(var t=atob(e),n=t.length,r=new Uint8Array(n),o=0;o<n;o++)r[o]=t.charCodeAt(o);return r},Ue="undefined"!=typeof Buffer?function(e){return(ArrayBuffer.isView(e)?Buffer.from(e.buffer,e.byteOffset,e.byteLength):Buffer.from(e)).toString("base64")}:function(e){return btoa(String.fromCharCode.apply(null,e))};function De(r,o){return new Promise(function(t,e){var n=_(_({},o),{onSubmit:function(e){r.next(void 0),t(e)},onCancel:function(){r.next(void 0),e(new m.default.AbortError("User cancelled"))}});r.next(n)})}function je(e,t){for(var n=[],r=2;r<arguments.length;r++)n[r-2]=arguments[r];return De(e,{type:"message-alert",title:t,alerts:n,fields:{}})}function Ne(n,r,o){return S(this,void 0,void 0,function(){var t;return k(this,function(e){switch(e.label){case 0:t=o||"",e.label=1;case 1:return t&&/^[\w-\.]+@([\w-]+\.)+[\w-]{2,10}$/.test(t)?[3,3]:[4,De(n,{type:"email",title:r,alerts:t?[{type:"error",messageCode:"INVALID_EMAIL",message:"Please enter a valid email address",messageParams:{}}]:[],fields:{email:{type:"email",placeholder:"you@somedomain.com"}}})];case 2:return t=e.sent().email,[3,1];case 3:return[2,t]}})})}function Le(n,r,o){return S(this,void 0,void 0,function(){var t;return k(this,function(e){switch(e.label){case 0:return t=[{type:"info",messageCode:"OTP_SENT",message:"A One-Time password has been sent to {email}",messageParams:{email:r}}],o&&t.push(o),[4,De(n,{type:"otp",title:"Enter OTP",alerts:t,fields:{otp:{type:"otp",label:"OTP",placeholder:"Paste OTP here"}}})];case 1:return[2,e.sent().otp]}})})}function Re(t,n,r,o,i){return S(this,void 0,void 0,function(){return k(this,function(e){switch(e.label){case 0:return n.accessToken&&n.accessTokenExpiration.getTime()>Date.now()?[2,n]:[3,1];case 1:return n.refreshToken&&(!n.refreshTokenExpiration||n.refreshTokenExpiration.getTime()>Date.now())?[4,Be(t,n)]:[3,3];case 2:return[2,e.sent()];case 3:return[4,function(i,s,u,a){return S(this,void 0,void 0,function(){var t,n,r,o;return k(this,function(e){switch(e.label){case 0:return[4,crypto.subtle.generateKey({name:"RSASSA-PKCS1-v1_5",modulusLength:2048,publicExponent:new Uint8Array([1,0,1]),hash:{name:"SHA-256"}},!1,["sign","verify"])];case 1:return n=e.sent(),t=n.privateKey,n=n.publicKey,i.nonExportablePrivateKey=t,[4,crypto.subtle.exportKey("spki",n)];case 2:r=e.sent(),r=function(e){var t="-----BEGIN PUBLIC KEY-----\n";for(;0<e.length;)t+=e.substring(0,64)+"\n",e=e.substring(64);return t+="-----END PUBLIC KEY-----"}(Ue(r)),i.publicKey=n,e.label=3;case 3:return e.trys.push([3,7,,9]),[4,s({public_key:r,hints:a})];case 4:if("tokens"!==(r=e.sent()).type)throw new Error("Unexpected response type from token endpoint: "+r.type);return i.accessToken=r.accessToken,i.accessTokenExpiration=new Date(r.accessTokenExpiration),i.refreshToken=r.refreshToken,r.refreshTokenExpiration&&(i.refreshTokenExpiration=new Date(r.refreshTokenExpiration)),i.userId=r.claims.sub,i.email=r.claims.email,i.name=r.claims.name,i.claims=r.claims,r.alerts&&0<r.alerts.length?[4,De(u,{type:"message-alert",title:"Authentication Alert",fields:{},alerts:r.alerts})]:[3,6];case 5:e.sent(),e.label=6;case 6:return[2,i];case 7:return o=e.sent(),[4,je(u,"Authentication Failed",{type:"error",messageCode:"GENERIC_ERROR",message:"We're having a problem to authenticate rigth now.",messageParams:{}}).catch(function(){})];case 8:throw e.sent(),o;case 9:return[2]}})})}(n,r,o,i)];case 4:return[2,e.sent()]}})})}function Be(i,s){return S(this,void 0,void 0,function(){var t,n,r,o;return k(this,function(e){switch(e.label){case 0:if(!s.refreshToken)throw new Error("Cannot refresh token - refresh token is missing.");if(!s.nonExportablePrivateKey)throw new Error("login.nonExportablePrivateKey is missing - cannot sign refresh token without a private key.");return r=Date.now(),t="RSASSA-PKCS1-v1_5",n=new TextEncoder,n=n.encode(s.refreshToken+r),[4,crypto.subtle.sign(t,s.nonExportablePrivateKey,n)];case 1:return n=e.sent(),n=Ue(n),r={grant_type:"refresh_token",refresh_token:s.refreshToken,scopes:["ACCESS_DB"],signature:n,signing_algorithm:t,time_stamp:r},[4,fetch(i+"/token",{body:JSON.stringify(r),method:"post",headers:{"Content-Type":"application/json"},mode:"cors"})];case 2:if(200!==(o=e.sent()).status)throw new Error("RefreshToken: Status "+o.status+" from "+i+"/token");return[4,o.json()];case 3:return o=e.sent(),s.accessToken=o.accessToken,s.accessTokenExpiration=o.accessTokenExpiration?new Date(o.accessTokenExpiration):void 0,[2,s]}})})}var $e=new WeakMap,We=(Fe.load=function(t,n){return t.table("$logins").get(n).then(function(e){return new Fe(t,e||{userId:n,claims:{sub:n},lastLogin:new Date(0)})})},Fe.prototype.save=function(){return S(this,void 0,void 0,function(){return k(this,function(e){return $e.get(this).table("$logins").put(this),[2]})})},Fe);function Fe(e,t){$e.set(this,e),Object.assign(this,t)}var Me,He=(n(Ke,Me=Error),Object.defineProperty(Ke.prototype,"name",{get:function(){return"HttpError"},enumerable:!1,configurable:!0}),Ke);function Ke(e,t){t=Me.call(this,t||e.status+" "+e.statusText)||this;return t.httpStatus=e.status,t}function Ve(n,r){return S(this,void 0,void 0,function(){var t;return k(this,function(e){switch(e.label){case 0:return[4,n.getCurrentUser()];case 1:if(e.sent().isLoggedIn){if(r){if(r.email&&n.cloud.currentUser.value.email!==r.email)throw new Error("Must logout before changing user");if(r.userId&&n.cloud.currentUserId!==r.userId)throw new Error("Must logout before changing user")}return[2]}return t=new We(n,{claims:{},lastLogin:new Date(0)}),[4,Re(n.cloud.options.databaseUrl,t,n.cloud.options.fetchTokens||(d=(f=n).cloud.userInteraction,function(e){var c=e.public_key,l=e.hints;return S(this,void 0,void 0,function(){var t,n,r,o,i,s,u,a;return k(this,function(e){switch(e.label){case 0:if(!(n=null===(n=f.cloud.options)||void 0===n?void 0:n.databaseUrl))throw new Error("No database URL given.");return"demo"!==(null==l?void 0:l.grant_type)?[3,2]:[4,Ne(d,"Enter a demo user email",(null==l?void 0:l.email)||(null==l?void 0:l.userId))];case 1:return r=e.sent(),t={demo_user:r,grant_type:"demo",scopes:["ACCESS_DB"],public_key:c},[3,4];case 2:return[4,Ne(d,"Enter email address",null==l?void 0:l.email)];case 3:r=e.sent(),t={email:r,grant_type:"otp",scopes:["ACCESS_DB"],public_key:c},e.label=4;case 4:return[4,fetch(n+"/token",{body:JSON.stringify(t),method:"post",headers:{"Content-Type":"application/json",mode:"cors"}})];case 5:return 200===(o=e.sent()).status?[3,8]:[4,o.text()];case 6:return a=e.sent(),[4,je(d,"Token request failed",{type:"error",messageCode:"GENERIC_ERROR",message:a,messageParams:{}}).catch(function(){})];case 7:throw e.sent(),new He(o,a);case 8:return[4,o.json()];case 9:return"tokens"!==(s=e.sent()).type?[3,10]:[2,s];case 10:if("otp"!==t.grant_type)return[3,22];if("otp-sent"!==s.type)throw new Error("Unexpected response from "+n+"/token");return[4,Le(d,t.email)];case 11:return o=e.sent(),t.otp=o||"",t.otp_id=s.otp_id,[4,fetch(n+"/token",{body:JSON.stringify(t),method:"post",headers:{"Content-Type":"application/json"},mode:"cors"})];case 12:i=e.sent(),e.label=13;case 13:return 401!==i.status?[3,17]:[4,i.text()];case 14:return s=e.sent(),u=t,[4,Le(d,t.email,{type:"error",messageCode:"INVALID_OTP",message:s,messageParams:{}})];case 15:return u.otp=e.sent(),[4,fetch(n+"/token",{body:JSON.stringify(t),method:"post",headers:{"Content-Type":"application/json"},mode:"cors"})];case 16:return i=e.sent(),[3,13];case 17:return 200===i.status?[3,20]:[4,i.text()];case 18:return a=e.sent(),[4,je(d,"OTP Authentication Failed",{type:"error",messageCode:"GENERIC_ERROR",message:a,messageParams:{}}).catch(function(){})];case 19:throw e.sent(),new He(i,a);case 20:return[4,i.json()];case 21:return[2,e.sent()];case 22:throw new Error("Unexpected response from "+n+"/token")}})})}),n.cloud.userInteraction,r)];case 2:return e.sent(),[4,t.save()];case 3:return e.sent(),[4,function(r,o){return S(this,void 0,void 0,function(){var n,t=this;return k(this,function(e){switch(e.label){case 0:return o.userId===r.cloud.currentUserId?[2]:(n=r.table("$logins"),[4,r.transaction("rw",n,function(e){return S(t,void 0,void 0,function(){var t;return k(this,function(e){switch(e.label){case 0:return[4,n.toArray()];case 1:return t=e.sent(),[4,Promise.all(t.filter(function(e){return e.userId!==o.userId&&e.isLoggedIn}).map(function(e){return e.isLoggedIn=!1,n.put(e)}))];case 2:return e.sent(),o.isLoggedIn=!0,o.lastLogin=new Date,[4,o.save()];case 3:return e.sent(),console.debug("Saved new user",o.email),[2]}})})})]);case 1:return e.sent(),[4,new Promise(function(t){var n;r.cloud.currentUserId===o.userId?t(null):n=r.cloud.currentUser.subscribe(function(e){e.userId===o.userId&&(n.unsubscribe(),t(null))})})];case 2:return e.sent(),[2]}})})}(n,t)];case 4:return e.sent(),[2]}var f,d})})}var qe={userId:"unauthorized",name:"Unauthorized",claims:{sub:"unauthorized"},lastLogin:new Date(0)};try{Object.freeze(qe),Object.freeze(qe.claims)}catch(e){}var ze={},Ge=self.document&&navigator.serviceWorker;Ge&&Ge.ready.then(function(e){return ze.registration=e}),"undefined"!=typeof self&&"clients"in self&&!self.document&&addEventListener("message",function(n){var e;null!==(e=null===(e=n.data)||void 0===e?void 0:e.type)&&void 0!==e&&e.startsWith("sw-broadcast-")&&g([],self.clients.matchAll({includeUncontrolled:!0})).forEach(function(e){var t;return e.id!==(null===(t=n.source)||void 0===t?void 0:t.id)&&e.postMessage(n.data)})});var Je=(Ye.prototype.subscribe=function(n){var r=this;if(!Ge)return function(){};function e(e){var t;(null===(t=e.data)||void 0===t?void 0:t.type)==="sw-broadcast-"+r.name&&n(e.data.message)}return Ge.addEventListener("message",e),function(){return Ge.removeEventListener("message",e)}},Ye.prototype.postMessage=function(t){var e,n=this;"object"==typeof self.clients?g([],self.clients.matchAll({includeUncontrolled:!0})).forEach(function(e){return e.postMessage({type:"sw-broadcast-"+n.name,message:t})}):ze.registration&&null!==(e=ze.registration.active)&&void 0!==e&&e.postMessage({type:"sw-broadcast-"+this.name,message:t})},Ye);function Ye(e){this.name=e}var Qe,Xe=(n(Ze,Qe=y.Observable),Ze.prototype.next=function(e){console.debug("BroadcastedAndLocalEvent: bc.postMessage()",_({},e),"bc is a",this.bc),this.bc.postMessage(e);e=new CustomEvent("lbc-"+this.name,{detail:e});self.dispatchEvent(e)},Ze);function Ze(o){var e=this,i=new("undefined"==typeof BroadcastChannel?Je:BroadcastChannel)(o);return(e=Qe.call(this,function(t){function e(e){t.next(e.detail)}function n(e){console.debug("BroadcastedAndLocalEvent: onMessageEvent",e),t.next(e.data)}var r;return self.addEventListener("lbc-"+o,e),i instanceof Je?r=i.subscribe(function(e){return t.next(e)}):(console.debug("BroadcastedAndLocalEvent: bc.addEventListener()",o,"bc is a",i),i.addEventListener("message",n)),function(){self.removeEventListener("lbc-"+o,e),i instanceof Je?r():i.removeEventListener("message",n)}})||this).name=o,e.bc=i,e}var et=new WeakMap,tt={realms:"@realmId",members:"@id",roles:"[realmId+name]",$jobs:"",$syncState:"",$baseRevs:"[tableName+clientRev]",$logins:"claims.sub, lastLogin"},nt=0;function rt(e){"vip"in e&&(e=e.vip);var t,n,r,o=et.get(e.cloud);return o||(r=new y.BehaviorSubject({}),t=new Xe("syncstatechanged-"+e.name),r.id=++nt,n=!1,o={get name(){return e.name},close:function(){return e.close()},transaction:e.transaction.bind(e),table:e.table.bind(e),get tables(){return e.tables},cloud:e.cloud,get $jobs(){return e.table("$jobs")},get $syncState(){return e.table("$syncState")},get $baseRevs(){return e.table("$baseRevs")},get $logins(){return e.table("$logins")},get realms(){return e.realms},get members(){return e.members},get roles(){return e.roles},get initiallySynced(){return n},localSyncEvent:r,get syncStateChangedEvent(){return t},dx:e},r={getCurrentUser:function(){return o.$logins.toArray().then(function(e){return e.find(function(e){return e.isLoggedIn})||qe})},getPersistedSyncState:function(){return o.$syncState.get("syncState")},getSchema:function(){return o.$syncState.get("schema")},getOptions:function(){return o.$syncState.get("options")},setInitiallySynced:function(e){n=e},reconfigure:function(){t=new Xe("syncstatechanged-"+e.name)}},Object.assign(o,r),et.set(e.cloud,o)),o}var ot="undefined"!=typeof InstallTrigger,it="undefined"!=typeof navigator&&/Safari\//.test(navigator.userAgent)&&!/Chrom(e|ium)\/|Edge\//.test(navigator.userAgent),st=it?[].concat(navigator.userAgent.match(/Safari\/(\d*)/))[1]:NaN,ut=it&&st<=605||ot;var at="undefined"!=typeof self&&"clients"in self&&!self.document;function ct(){throw new m.default.SchemaError("Version increment needed to allow dexie-cloud change tracking")}function lt(e){return function(e){for(var t="",n=0,r=e.length;n<r;n++)t+=ht[e[n]];return t}(Ue(e))}function ft(e){return Pe(function(e){if("string"!=typeof e)throw new Error("invalid decoder input: "+e);for(var t="",n=0,r=e.length;n<r;n++)t+=dt[e[n]];return t}(e))}for(var dt={"-":"=",0:"A",1:"B",2:"C",3:"D",4:"E",5:"F",6:"G",7:"H",8:"I",9:"J",A:"K",B:"L",C:"M",D:"N",E:"O",F:"P",G:"Q",H:"R",I:"S",J:"T",K:"U",L:"V",M:"W",N:"X",O:"Y",P:"Z",Q:"a",R:"b",S:"c",T:"d",U:"e",V:"f",W:"g",X:"h",Y:"i",Z:"j",_:"k",a:"l",b:"m",c:"n",d:"o",e:"p",f:"q",g:"r",h:"s",i:"t",j:"u",k:"v",l:"w",m:"x",n:"y",o:"z",p:"0",q:"1",r:"2",s:"3",t:"4",u:"5",v:"6",w:"7",x:"8",y:"9",z:"+","|":"/"},ht={},pt=0,vt=Object.keys(dt);pt<vt.length;pt++){var bt=vt[pt];ht[dt[bt]]=bt}var yt={}.toString;function mt(e){return yt.call(e).slice(8,-1)}function _t(e,t){var n;return"delete"===t.type?t.keys:(null===(n=t.keys)||void 0===n?void 0:n.slice())||t.values.map(e.extractKey)}var gt=/b|c|d|f|g|h|j|k|l|m|n|p|q|r|s|t|v|x|y|z/i;var wt=0;function St(h){return{stack:"dbcore",name:"idGenerationMiddleware",level:1,create:function(e){return _(_({},e),{table:function(f){var d=e.table(f);function o(u,a){var c=null,l=_t(d.schema.primaryKey,u);return l.forEach(function(e,t){if(void 0===e){var n=u.values[t].realmId||h.cloud.currentUserId,r=n.substr(n.length-3);l[t]=(o=a,i=r,s=new Uint8Array(18),n=new Uint8Array(s.buffer,0,6),(r=Date.now())<=wt?++wt:wt=r,n[0]=wt/1099511627776,n[1]=wt/4294967296,n[2]=wt/16777216,n[3]=wt/65536,n[4]=wt/256,n[5]=wt,n=new Uint8Array(s.buffer,6),crypto.getRandomValues(n),o+lt(new Uint8Array(s.buffer))+(i||"")),d.schema.primaryKey.outbound||((c=c||u.values.slice())[t]=m.default.deepClone(c[t]),m.default.setByKeyPath(c[t],d.schema.primaryKey.keyPath,l[t]))}else if("string"!=typeof e||!e.startsWith(a))throw new m.default.ConstraintError('The ID "'+e+'" is not valid for table "'+f+"\". Primary '@' keys requires the key to be prefixed with \""+a+".\n\"If you want to generate IDs programmatically, remove '@' from the schema to get rid of this constraint. Dexie Cloud supports custom IDs as long as they are random and globally unique.");var o,i,s}),d.mutate(_(_({},u),{keys:l,values:c||u.values}))}return _(_({},d),{mutate:function(t){var e;if(t.trans.disableChangeTracking)return d.mutate(t);if("add"===t.type||"put"===t.type){var n=null===(e=h.cloud.schema)||void 0===e?void 0:e[f];if(null!=n&&n.generatedGlobalId){if(null===(e=h.cloud.options)||void 0===e||!e.databaseUrl||h.initiallySynced)return o(t,n.idPrefix);var r=_t(d.schema.primaryKey,t);return d.getMany({keys:r,trans:t.trans,cache:"immutable"}).then(function(e){if(e.length<r.length)throw new Error("Unable to create new objects without an initial sync having been performed.");return d.mutate(t)})}null!=n&&n.markedForSync&&_t(d.schema.primaryKey,t).forEach(function(e,t){if(!a(e)){e=Array.isArray(e)?e.map(mt).join(","):mt(e);throw new m.default.ConstraintError("Invalid primary key type "+e+" for table "+f+". Tables marked for sync has primary keys of type string or Array of string (and optional numbers)")}})}return d.mutate(t)}})}})}}}function kt(e){return"$"+e+"_mutations"}function Et(e){e=new Uint8Array(e);return crypto.getRandomValues(e),btoa(String.fromCharCode.apply(null,e))}var xt=0;function It(e){var i,s,t="$lock"+ ++xt;return _(_({},e),{count:Tt(e.count,t),get:Tt(e.get,t),getMany:Tt(e.getMany,t),openCursor:Tt(e.openCursor,t),query:Tt(e.query,t),mutate:(i=e.mutate,s=t,function(e){var t,n=e.trans[s]||(e.trans[s]={writers:[],readers:[]}),r=n.readers,o=n.writers,r=(0<o.length?o[o.length-1].then(function(){return i(e)},function(){return i(e)}):0<r.length?(t=r,new Promise(function(n){0===t.length&&n([]);var r=t.length,o=new Array(r);t.forEach(function(e,t){return Promise.resolve(e).then(function(e){return o[t]={status:"fulfilled",value:e}},function(e){return o[t]={status:"rejected",reason:e}}).then(function(){return--r||n(o)})})}).then(function(){return i(e)})):i(e)).finally(function(){return o.shift()});return o.push(r),r})})}function Tt(i,s){return function(e){var t=e.trans[s]||(e.trans[s]={writers:[],readers:[]}),n=t.readers,r=t.writers,t=r.length,o=(0<t?r[t-1].then(function(){return i(e)},function(){return i(e)}):i(e)).finally(function(){return n.splice(n.indexOf(o))});return n.push(o),o}}var Ct=!1;function At(n){return S(this,void 0,void 0,function(){var t;return k(this,function(e){switch(e.label){case 0:return e.trys.push([0,5,,6]),[4,navigator.serviceWorker.ready];case 1:return(t=e.sent()).sync?[4,t.sync.register("dexie-cloud:"+n.name)]:[3,3];case 2:return e.sent(),[3,4];case 3:t.active?t.active.postMessage({type:"dexie-cloud-sync",dbName:n.name}):console.error("Dexie Cloud: There's no active service worker. Can this ever happen??"),e.label=4;case 4:return[2];case 5:return t=e.sent(),Ct||(console.debug("Dexie Cloud: Could not register sync event",t),Ct=!0),[3,6];case 6:return[2]}})})}var Ot=new y.BehaviorSubject(new Set);function Pt(n,s){return function(e,t){var r=_(_({},tt),e),o=s.cloud.schema||(s.cloud.schema={}),i=new Set;return Object.keys(r).forEach(function(e){var t=r[e],n=o[e]||(o[e]={});null!=t?(/^\@/.test(t)&&(r[e]=r[e].substr(1),n.generatedGlobalId=!0,n.idPrefix=function(e,t){for(var n,r,o,i=e[0].toLocaleLowerCase(),s=1,u=e.length;s<u&&i.length<3;++s)(gt.test(e[s])||"A"<=(n=e[s])&&n<="Z")&&(i+=e[s].toLowerCase());for(;t.has(i);){if(/\d/g.test(i)){if(!(3<(i=i.substr(0,i.length-1)+(i[i.length-1]+1)).length))continue;i=i.substr(0,3)}else if(i.length<3){i+="2";continue}for(var a,c=1,l=i;t.has(l)&&c<8;)r=i,l=(1&(o=c)?r[0].toUpperCase():r[0].toLowerCase())+(2&o?r[1].toUpperCase():r[1].toLowerCase())+(4&o?r[2].toUpperCase():r[2].toLowerCase()),++c;i=c<8?l:(a=i.charCodeAt(2)+1&127,i.substr(0,2)+String.fromCharCode(a))}return i}(e,i),i.add(n.idPrefix)),/^\$/.test(e)||(r["$"+e+"_mutations"]="++rev",n.markedForSync=!0),n.deleted&&(n.deleted=!1)):(n.deleted=!0,n.markedForSync=!1,r["$"+e+"_mutations"]=null)}),n.call(this,r,t)}}var Ut=6e4,Dt=Et(16),jt=1e3,Nt=+Ut;function Lt(i,s,u,r,e){var a=(void 0===e?{}:e).awaitRemoteJob;return S(this,void 0,void 0,function(){var o,t,n=this;return k(this,function(e){switch(e.label){case 0:return o=i.table(u),[4,function r(){return S(this,void 0,void 0,function(){var t,n=this;return k(this,function(e){switch(e.label){case 0:return[4,i.transaction("rw!",u,function(){return S(n,void 0,void 0,function(){var t;return k(this,function(e){switch(e.label){case 0:return[4,o.get(s)];case 1:return(t=e.sent())?[3,3]:[4,o.add({nodeId:Dt,started:new Date,heartbeat:new Date},s)];case 2:return e.sent(),[2,!0];case 3:return t.heartbeat.getTime()<Date.now()-Nt?(console.warn("Latest "+s+" worker seem to have died.\n","The dead job started:",t.started,"\n","Last heart beat was:",t.heartbeat,"\n","We're now taking over!"),[4,o.put({nodeId:Dt,started:new Date,heartbeat:new Date},s)]):[3,5];case 4:return e.sent(),[2,!0];case 5:return[2,!1]}})})})];case 1:if(e.sent())return[2,!0];if(!a)return[3,6];e.label=2;case 2:return e.trys.push([2,4,,6]),[4,y.from(b.liveQuery(function(){return o.get(s)})).pipe(Oe(Nt),pe(function(e){return!e})).toPromise()];case 3:return e.sent(),[2,!1];case 4:if("TimeoutError"!==(t=e.sent()).name)throw t;return[4,r()];case 5:return[2,e.sent()];case 6:return[2,!1]}})})}()];case 1:if(!e.sent())return[3,6];t=setInterval(function(){o.update(s,function(e){return e.nodeId===Dt&&(e.heartbeat=new Date)})},jt),e.label=2;case 2:return e.trys.push([2,,4,6]),[4,r()];case 3:return[2,e.sent()];case 4:return clearInterval(t),[4,i.transaction("rw!",u,function(){return S(n,void 0,void 0,function(){var t;return k(this,function(e){switch(e.label){case 0:return[4,o.get(s)];case 1:return(t=e.sent())&&t.nodeId===Dt&&o.delete(s),[2]}})})})];case 5:return e.sent(),[7];case 6:return[2]}})})}function Rt(t){return Object.entries(t.cloud.schema||{}).filter(function(e){return e[1].markedForSync}).map(function(e){e=e[0];return t.table(e)})}function Bt(n,s,u,r){return S(this,void 0,void 0,function(){var i,t=this;return k(this,function(e){switch(e.label){case 0:return s.isLoggedIn?0<n.length?(i=new Set(r||[]),[4,Promise.all(n.map(function(o){return S(t,void 0,void 0,function(){var n,r,t;return k(this,function(e){switch(e.label){case 0:return(n=o.core.schema.primaryKey.extractKey)?(r=u[o.name],[4,(null!=r&&r.generatedGlobalId?o.filter(function(e){return!i.has(e.realmId||"")&&a(n(e))}):o.filter(function(e){return!i.has(e.realmId||"")&&(t=n(e),!(e=null==r?void 0:r.idPrefix)||"string"==typeof t&&t.startsWith(e));var t})).toArray()]):[2,{table:o.name,muts:[]}];case 1:return 0<(t=e.sent()).length?(t={type:"insert",values:t,keys:t.map(n),userId:s.userId},[2,{table:o.name,muts:[t]}]):[2,{table:o.name,muts:[]}]}})})}))]):[3,2]:[3,2];case 1:return[2,e.sent().filter(function(e){return 0<e.muts.length})];case 2:return[2,[]]}})})}function $t(e,t){var n=(null==t?void 0:t.syncedTables)||[];return Rt(e).filter(function(e){return!n.includes(e.name)})}function Wt(e){var t=null===(t=/^\$(.*)_mutations$/.exec(e))||void 0===t?void 0:t[1];if(!t)throw new Error("Given mutationTable "+e+" is not correct");return t}function Ft(n,e,t){var r=void 0===t?{}:t,t=r.since,o=void 0===t?{}:t,r=r.limit,i=void 0===r?1/0:r;return S(this,void 0,void 0,function(){var t=this;return k(this,function(e){switch(e.label){case 0:return[4,Promise.all(n.map(function(r){return S(t,void 0,void 0,function(){var t,n;return k(this,function(e){switch(e.label){case 0:return t=Wt(r.name),n=o[t],n=n?r.where("rev").above(n):r,[4,(n=i<1/0?n.limit(i):n).toArray()];case 1:return n=e.sent(),[2,{table:t,muts:n}]}})})}))];case 1:return[2,e.sent().filter(function(e){return 0<e.muts.length})]}})})}var Mt={}.toString;var Ht={replace:function(e){for(var t=Object.keys(e),n=null,r=0,o=t.length;r<o;++r)"$"===t[r][0]&&(n=n||[]).push(t[r]);if(!n)return e;for(var i=_({},e),s=0,u=n;s<u.length;s++){var a=u[s];delete i[a],i["$"+a]=e[a]}return i}};function Kt(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var l=e.reduce(function(e,t){return _(_({},e),t)},e.reduce(function(e,t){return _(_({},t),e)},{})),s=new WeakMap;return{stringify:function(e,n,t){return JSON.stringify(e,function(e){var t=this[e],e=function(r){var e=typeof r;switch(typeof r){case"object":case"function":if(null===r)return null;var t=Object.getPrototypeOf(r);if(!t)return Ht;var n=s.get(t);if(void 0!==n)return n;var o=function(e){return Mt.call(e).slice(8,-1)}(r),i=Object.entries(l).find(function(e){var t=e[0],n=e[1];return null!==(n=null===(e=null==n?void 0:n.test)||void 0===e?void 0:e.call(n,r,o))&&void 0!==n?n:t===o});return n=(n=null==i?void 0:i[1])||(Array.isArray(r)?null:"function"==typeof r?l.function||null:Ht),s.set(t,n),n;default:return l[e]}}(t);return e?e.replace(t,n,l):t},t)},parse:function(e,u){var a=null,c=[];return JSON.parse(e,function(e,t){var n,r=null==t?void 0:t.$t;if((t=r&&(n=l[r])?n.revive(t,u,l):t)!==a)return"$"===e[0]&&"$t"!==e&&(a=this,c.push(e)),t;if(0<c.length){t=_({},t);for(var o=0,i=c;o<i.length;o++){var s=i[o];t[s.substr(1)]=t[s],delete t[s]}}return c=[],t})}}}var Vt={Blob:{test:function(e,t){return"Blob"===t},replace:function(e,t){var n=t.length;return t.push(e),{$t:"Blob",mimeType:e.type,i:n}},revive:function(e,t){var n=e.i,e=e.mimeType;return new Blob([t[n]],{type:e})}}},qt={number:{replace:function(e){switch(!0){case isNaN(e):return{$t:"number",v:"NaN"};case e===1/0:return{$t:"number",v:"Infinity"};case e===-1/0:return{$t:"number",v:"-Infinity"};default:return e}},revive:function(e){e=e.v;return Number(e)}}},zt={bigint:{replace:function(e){return{$t:"bigint",v:""+e}},revive:function(e){return BigInt(e.v)}}},Gt={Date:{replace:function(e){return{$t:"Date",v:isNaN(e.getTime())?"NaN":e.toISOString()}},revive:function(e){e=e.v;return new Date("NaN"===e?NaN:Date.parse(e))}}},V={Set:{replace:function(e){return{$t:"Set",v:Array.from(e.entries())}},revive:function(e){e=e.v;return new Set(e)}}},H={Map:{replace:function(e){return{$t:"Map",v:Array.from(e.entries())}},revive:function(e){e=e.v;return new Map(e)}}},Jt="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self?self:"undefined"==typeof global?global:void 0,it=["Int8Array","Uint8Array","Uint8ClampedArray","Int16Array","Uint16Array","Int32Array","Uint32Array","Float32Array","Float64Array","DataView","BigInt64Array","BigUint64Array"].reduce(function(e,o){return _(_({},e),((e={})[o]={replace:function(e,t,n){return{$t:o,v:n.ArrayBuffer.replace(0===e.byteOffset&&e.byteLength===e.buffer.byteLength?e.buffer:e.buffer.slice(e.byteOffset,e.byteOffset+e.byteLength),t,n).v}},revive:function(e,t,n){var r=e.v,e=Jt[o];return e&&new e(n.ArrayBuffer.revive({v:r},t,n))}},e))},{}),st={ArrayBuffer:{replace:function(e){return{$t:"ArrayBuffer",v:lt(e)}},revive:function(e){e=ft(e.v);return e.buffer.byteLength===e.byteLength?e.buffer:e.buffer.slice(e.byteOffset,e.byteOffset+e.byteLength)}}},Yt=function(e,t){this.buf=e,this.type=t};var ot={Blob:{test:function(e,t){return"Blob"===t||e instanceof Yt},replace:function(e){return{$t:"Blob",v:Ue(e instanceof Yt?e.buf:function(e){for(var t=new Uint8Array(e.length),n=0;n<e.length;++n)t[n]=e.charCodeAt(n);return t.buffer}(function(e){var t=new XMLHttpRequest;if(t.overrideMimeType("text/plain; charset=x-user-defined"),t.open("GET",URL.createObjectURL(e),!1),t.send(),200!==t.status&&0!==t.status)throw new Error("Bad Blob access: "+t.status);return t.responseText}(e))),type:e.type}},revive:function(e){e.type;e=e.v,e=Pe(e);return new Blob([e])}}},Qt=_(_(_(_(_(_(_(_({},qt),zt),Gt),V),H),it),st),ot);function Xt(r){return new Promise(function(t,n){var e=new FileReader;e.onabort=function(e){return n(new Error("file read aborted"))},e.onerror=function(e){return n(e.target.error)},e.onload=function(e){return t(e.target.result)},e.readAsArrayBuffer(r)})}var st={undefined:{replace:function(){},revive:function(){}}},ot="undefined"!=typeof BigInt,Zt=(en.compare=function(e,t){if("bigint"==typeof e)return e<t?-1:t<e?1:0;if("bigint"==typeof t)throw new TypeError("Can't compare real bigint with FakeBigInt");return Number(e)<Number(t)?-1:Number(e)>Number(t)?1:0},en.prototype.toString=function(){return this.v},en);function en(e){this.v=e}var st=_(_({},st),ot?{}:{bigint:{test:function(e){return e instanceof Zt},replace:function(e){return _({$t:"bigint"},e)},revive:function(e){e=e.v;return new Zt(e)}}}),tn=Kt(Qt,st),nn=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var c=Kt.apply(void 0,g([Qt,Vt],e));return{toBinary:function(e){var t=this.stringify(e),n=t[0],e=t[1],t=new ArrayBuffer(4);return new DataView(t).setUint32(0,n.size),new Blob([t,n,e])},stringify:function(e){var t=[],e=c.stringify(e,t);return[new Blob(t.map(function(e){var t=new ArrayBuffer(4);return new DataView(t).setUint32(0,"byteLength"in e?e.byteLength:e.size),new Blob([t,e])})),e]},parse:function(u,a){return S(this,void 0,void 0,function(){var t,n,r,o,i,s;return k(this,function(e){switch(e.label){case 0:return t=0,n=[],[4,Xt(a)];case 1:for(r=e.sent(),o=new DataView(r);t<r.byteLength;)i=o.getUint32(t),t+=4,s=r.slice(t,t+i),t+=i,n.push(s);return[2,c.parse(u,n)]}})})},fromBinary:function(i){return S(this,void 0,void 0,function(){var t,n,o;return k(this,function(e){switch(e.label){case 0:return t=DataView.bind,[4,Xt(i.slice(0,4))];case 1:return o=(new(t.apply(DataView,[void 0,e.sent()]))).getUint32(0),n=i.slice(4,o+4),[4,(r=i.slice(o+4),new Promise(function(t,n){var e=new FileReader;e.onabort=function(e){return n(new Error("file read aborted"))},e.onerror=function(e){return n(e.target.error)},e.onload=function(e){return t(e.target.result)},e.readAsText(r)}))];case 2:return o=e.sent(),[4,this.parse(o,n)];case 3:return[2,e.sent()]}var r})})}}}(st);function rn(s,u,a,c,l,f){return S(this,void 0,void 0,function(){var t,n,r,o,i;return k(this,function(e){switch(e.label){case 0:return t={Accept:"application/json, application/x-bison, application/x-bison-stream","Content-Type":"application/tson"},[4,function(a){return S(this,void 0,void 0,function(){var t,n,r,o,i,s,u;return k(this,function(e){switch(e.label){case 0:return[4,a.getCurrentUser()];case 1:if(t=e.sent(),n=t.accessToken,r=t.accessTokenExpiration,o=t.refreshToken,i=t.refreshTokenExpiration,s=t.claims,!n)return[2];if((null!==(r=null==r?void 0:r.getTime())&&void 0!==r?r:1/0)>Date.now())return[2,n];if(!o)throw new Error("Refresh token missing");if((null!==(i=null==i?void 0:i.getTime())&&void 0!==i?i:1/0)<=Date.now())throw new Error("Refresh token has expired");return[4,Be(a.cloud.options.databaseUrl,t)];case 2:return u=e.sent(),[4,a.table("$logins").update(s.sub,{accessToken:u.accessToken,accessTokenExpiration:u.accessTokenExpiration})];case 3:return e.sent(),[2,u.accessToken]}})})}(c)];case 1:return(n=e.sent())&&(t.Authorization="Bearer "+n),n={dbID:null==u?void 0:u.remoteDbId,schema:f||{},lastPull:u?{serverRevision:u.serverRevision,realms:u.realms,inviteRealms:u.inviteRealms}:void 0,baseRevs:a,changes:s},console.debug("Sync request",n),c.syncStateChangedEvent.next({phase:"pushing"}),[4,fetch(l+"/sync",{method:"post",headers:t,body:tn.stringify(n)})];case 2:if(i=e.sent(),c.syncStateChangedEvent.next({phase:"pulling"}),!i.ok)throw new He(i);switch(i.headers.get("content-type")){case"application/x-bison":return[3,3];case"application/x-bison-stream":case"application/json":return[3,5]}return[3,5];case 3:return o=(r=nn).fromBinary,[4,i.blob()];case 4:return[2,o.apply(r,[e.sent()])];case 5:return[4,i.text()];case 6:return i=e.sent(),[2,tn.parse(i)]}})})}function on(i,s,u){return S(this,void 0,void 0,function(){var t,n,r,o;return k(this,function(e){switch(e.label){case 0:t=new Set(u||[]),n=0,r=i,e.label=1;case 1:return n<r.length?"members"!==(o=r[n]).name?[3,3]:[4,o.toCollection().modify(function(e){t.has(e.realmId)||e.userId!==qe.userId||(e.userId=s.userId)})]:[3,9];case 2:return e.sent(),[3,8];case 3:return"roles"!==o.name?[3,4]:[3,8];case 4:return"realms"!==o.name?[3,6]:[4,o.toCollection().modify(function(e){(t.has(e.realmId)||e.owner)&&e.owner!==qe.userId||(e.owner=s.userId)})];case 5:return e.sent(),[3,8];case 6:return[4,o.toCollection().modify(function(e){e.realmId&&t.has(e.realmId)||(e.owner&&e.owner!==qe.userId||(e.owner=s.userId),e.realmId&&e.realmId!==qe.userId||(e.realmId=s.userId))})];case 7:e.sent(),e.label=8;case 8:return n++,[3,1];case 9:return[2]}})})}function sn(e){if(null!=e&&e.cancelled)throw new m.default.AbortError("Operation was cancelled")}var un=navigator.onLine;self.addEventListener("online",function(){return un=!0}),self.addEventListener("offline",function(){return un=!1});var an=new WeakSet,cn="currentSyncWorker";function ln(n,r,o,i){var e=this;return function l(b,y,m,e){var e=void 0===e?{isInitialSync:!1}:e,_=e.isInitialSync,g=e.cancelToken,w=e.justCheckIfNeeded;return S(this,void 0,void 0,function(){var t,i,f,d,s,h,u,n,r,o,a,p,v,c=this;return k(this,function(e){switch(e.label){case 0:if(w||console.debug("SYNC STARTED",{isInitialSync:_}),null===(o=b.cloud.options)||void 0===o||!o.databaseUrl)throw new Error("Internal error: sync must not be called when no databaseUrl is configured");return t=y.databaseUrl,[4,b.getCurrentUser()];case 1:return i=e.sent(),f=i.isLoggedIn?Rt(b):[],d=f.map(function(e){return b.table(kt(e.name))}),[4,b.getPersistedSyncState()];case 2:return(s=e.sent(),h=!_&&i.isLoggedIn?$t(b,s):[],sn(g),u=0<h.length)?w?[2,!0]:(console.debug("sync doSyncify is true"),[4,b.transaction("rw",h,function(t){return S(c,void 0,void 0,function(){return k(this,function(e){switch(e.label){case 0:return t.idbtrans.disableChangeTracking=!0,t.idbtrans.disableAccessControl=!0,[4,on(h,i,null==s?void 0:s.realms)];case 1:return e.sent(),[2]}})})})]):[3,4];case 3:e.sent(),sn(g),e.label=4;case 4:return[4,b.transaction("r",b.tables,function(){return S(c,void 0,void 0,function(){var t,n,r,o;return k(this,function(e){switch(e.label){case 0:return[4,b.getPersistedSyncState()];case 1:return t=e.sent(),[4,b.$baseRevs.toArray()];case 2:return n=e.sent(),[4,Ft(d)];case 3:return r=e.sent(),sn(g),u?[4,Bt(h,i,m,null==s?void 0:s.realms)]:[3,5];case 4:return o=e.sent(),sn(g),[2,[r=r.concat(o),t,n]];case 5:return[2,[r,t,n]]}})})})];case 5:return(a=e.sent(),n=a[0],r=a[1],o=a[2],w)?(a=n.some(function(e){return e.muts.some(function(e){return 0<e.keys.length})}),console.debug("Sync is needed:",a),[2,a]):(p=dn(n,null==r?void 0:r.latestRevisions),sn(g),[4,rn(n,r,o,b,t,m)]);case 6:return v=e.sent(),console.debug("Sync response",v),[4,b.transaction("rw",b.tables,function(l){return S(c,void 0,void 0,function(){var t,n,r,o,i,s,u,a,c;return k(this,function(e){switch(e.label){case 0:for(l.idbtrans.disableChangeTracking=!0,l.idbtrans.disableAccessControl=!0,t=0,n=Object.keys(m);t<n.length;t++)r=n[t],v.schema[r]&&(m[r]=v.schema[r]);return[4,b.$syncState.put(m,"schema")];case 1:return e.sent(),[4,Ft(d,0,{since:p})];case 2:o=e.sent(),i=function(t){var n,r;return k(this,function(e){switch(e.label){case 0:return n=Wt(t.name),o.some(function(e){return e.table===n&&0<e.muts.length})?[3,2]:[4,Promise.all([t.clear(),b.$baseRevs.where({tableName:n}).delete()])];case 1:return e.sent(),[3,5];case 2:return p[t.name]?(r=p[t.name]||0,[4,Promise.all([t.where("rev").belowOrEqual(r).delete(),b.$baseRevs.where(":id").between([n,-1/0],[n,r+1],!0,!0).reverse().offset(1).delete()])]):[3,4];case 3:return e.sent(),[3,5];case 4:e.label=5;case 5:return[2]}})},s=0,u=d,e.label=3;case 3:return s<u.length?(u=u[s],[5,i(u)]):[3,6];case 4:e.sent(),e.label=5;case 5:return s++,[3,3];case 6:return dn(o,p),[4,b.$baseRevs.bulkPut(Object.keys(m).filter(function(e){return m[e].markedForSync}).map(function(e){var t=p[e]||0;return{tableName:e,clientRev:t+1,serverRev:v.serverRevision}}))];case 7:return e.sent(),[4,b.getPersistedSyncState()];case 8:return a=e.sent(),[4,fn(b,v,a)];case 9:return e.sent(),(c=a||{syncedTables:[],latestRevisions:{},realms:[],inviteRealms:[]}).syncedTables=f.map(function(e){return e.name}).concat(h.map(function(e){return e.name})),c.latestRevisions=p,c.remoteDbId=v.dbId,c.initiallySynced=!0,c.realms=v.realms,c.inviteRealms=v.inviteRealms,c.serverRevision=v.serverRevision,c.timestamp=new Date,delete c.error,[4,hn(pn(v.changes,o),b)];case 10:return e.sent(),b.$syncState.put(c,"syncState"),[2,0===o.length]}})})})];case 7:return e.sent()?[3,9]:(console.debug("MORE SYNC NEEDED. Go for it again!"),[4,l(b,y,m,{isInitialSync:_,cancelToken:g})]);case 8:return[2,e.sent()];case 9:return console.debug("SYNC DONE",{isInitialSync:_}),[2,!1]}})})}.apply(this,arguments).then(function(){n.syncStateChangedEvent.next({phase:"in-sync"})}).catch(function(t){return S(e,void 0,void 0,function(){return k(this,function(e){switch(e.label){case 0:return(console.debug("Error from _sync",{isOnline:un,syncOptions:i,error:t}),un&&null!=i&&i.retryImmediatelyOnFetchError&&"TypeError"===(null==t?void 0:t.name)&&/fetch/.test(null==t?void 0:t.message))?(n.syncStateChangedEvent.next({phase:"error",error:t}),[4,new Promise(function(e){return setTimeout(e,500)})]):[3,3];case 1:return e.sent(),[4,ln(n,r,o,_(_({},i),{retryImmediatelyOnFetchError:!1}))];case 2:return[2,e.sent()];case 3:return[4,n.$syncState.update("syncState",{timestamp:new Date,error:""+t})];case 4:return e.sent(),n.syncStateChangedEvent.next({phase:un?"error":"offline",error:t}),[2,Promise.reject(t)]}})})})}function fn(l,f,d){return S(this,void 0,void 0,function(){var t,n,r,o,i,s,u,a,c;return k(this,function(e){switch(e.label){case 0:for(t=[],u=d?d.realms.concat(d.inviteRealms):[],n=new Set(g(g([],f.realms),f.inviteRealms)),r=0,o=u;r<o.length;r++)i=o[r],n.has(i)||t.push(i);if(!(0<t.length))return[3,6];s=new Set(t),a=Rt(l),u=0,a=a,e.label=1;case 1:return u<a.length?(c=a[u]).schema.indexes.some(function(e){return"realmId"===e.keyPath||Array.isArray(e.keyPath)&&"realmId"===e.keyPath[0]})?[4,c.where("realmId").anyOf(t).delete()]:[3,3]:[3,6];case 2:return e.sent(),[3,5];case 3:return[4,c.filter(function(e){return!(null==e||!e.realmId)&&s.has(e.realmId)}).delete()];case 4:e.sent(),e.label=5;case 5:return u++,[3,1];case 6:return[2]}})})}function dn(e,t){void 0===t&&(t={});for(var n=0,r=e;n<r.length;n++){var o=r[n],i=o.table,o=o.muts,o=0<o.length&&o[o.length-1].rev||0;t[i]=o}return t}function hn(i,a){return S(this,void 0,void 0,function(){var t,n,r,o;return k(this,function(e){switch(e.label){case 0:console.debug("Applying server changes",i,m.default.currentTransaction),t=function(t,n){var r,o,i,s,u;return k(this,function(e){switch(e.label){case 0:r=a.table(t),o=r.core.schema.primaryKey,i=function(n){return k(this,function(e){switch(e.label){case 0:switch(n.type){case"insert":return[3,1];case"upsert":return[3,6];case"modify":return[3,11];case"update":return[3,16];case"delete":return[3,18]}return[3,20];case 1:return o.outbound?[4,r.bulkAdd(n.values,n.keys)]:[3,3];case 2:return e.sent(),[3,5];case 3:return n.keys.forEach(function(e,t){m.default.setByKeyPath(n.values[t],o.keyPath,e)}),[4,r.bulkAdd(n.values)];case 4:e.sent(),e.label=5;case 5:return[3,20];case 6:return o.outbound?[4,r.bulkPut(n.values,n.keys)]:[3,8];case 7:return e.sent(),[3,10];case 8:return n.keys.forEach(function(e,t){m.default.setByKeyPath(n.values[t],o.keyPath,e)}),[4,r.bulkPut(n.values)];case 9:e.sent(),e.label=10;case 10:return[3,20];case 11:return 1!==n.keys.length?[3,13]:[4,r.update(n.keys[0],n.changeSpec)];case 12:return e.sent(),[3,15];case 13:return[4,r.where(":id").anyOf(n.keys).modify(n.changeSpec)];case 14:e.sent(),e.label=15;case 15:return[3,20];case 16:return[4,function(l,t,f){return S(this,void 0,void 0,function(){var u,a,c;return k(this,function(e){switch(e.label){case 0:return[4,l.bulkGet(t)];case 1:return u=e.sent(),a=[],c=[],t.forEach(function(e,t){var n=u[t];if(n){for(var r=0,o=Object.entries(f[t]);r<o.length;r++){var i=o[r],s=i[0],i=i[1];if(s===l.schema.primKey.keyPath)throw new Error("Cannot change primary key");m.default.setByKeyPath(n,s,i)}a.push(e),c.push(n)}}),[4,null==l.schema.primKey.keyPath?l.bulkPut(c,a):l.bulkPut(c)];case 2:return e.sent(),[2]}})})}(r,n.keys,n.changeSpecs)];case 17:return e.sent(),[3,20];case 18:return[4,r.bulkDelete(n.keys)];case 19:return e.sent(),[3,20];case 20:return[2]}})},s=0,u=n,e.label=1;case 1:return s<u.length?(u=u[s],[5,i(u)]):[3,4];case 2:e.sent(),e.label=3;case 3:return s++,[3,1];case 4:return[2]}})},n=0,r=i,e.label=1;case 1:return n<r.length?(o=r[n],r=o.table,o=o.muts,[5,t(r,o)]):[3,4];case 2:e.sent(),e.label=3;case 3:return n++,[3,1];case 4:return[2]}})})}function pn(e,t){var n={};s(n,e);e={};return s(e,t),function(e,t){for(var n,r,o=0,i=Object.entries(t);o<i.length;o++)for(var s=(u=i[o])[0],u=u[1],a=0,c=Object.entries(u);a<c.length;a++){var l,f=c[a],d=f[0],h=f[1];switch(h.type){case"ups":if(l=null===(n=e[s])||void 0===n?void 0:n[d])switch(l.type){case"ups":delete e[s][d];break;case"del":break;case"upd":delete e[s][d]}break;case"del":null===(r=e[s])||void 0===r||delete r[d];break;case"upd":if(l=null===(r=e[s])||void 0===r?void 0:r[d])switch(l.type){case"ups":for(var p=0,v=Object.entries(h.mod);p<v.length;p++){var b=v[p],y=b[0],b=b[1];w(l.val,y,b)}break;case"del":break;case"upd":for(var m=0,_=Object.keys(h.mod);m<_.length;m++){y=_[m];delete l.mod[y]}}}}}(n,e),function(e){for(var t=E(16),n={},r=0,o=Object.entries(e);r<o.length;r++)for(var i=o[r],s=i[0],u=i[1],a=0,c=Object.entries(u);a<c.length;a++){var l=c[a],f=l[0],d=l[1],l=n[s]||(n[s]={});(l[d.type]||(l[d.type]=[])).push(Object.assign({key:f},d))}for(var h=[],p=0,v=Object.entries(n);p<v.length;p++){for(var b=v[p],s=b[0],u=b[1],y={table:s,muts:[]},m=0,_=Object.entries(u);m<_.length;m++){var g=_[m],w=g[0],S=g[1];switch(w){case"ups":d={type:"upsert",keys:S.map(function(e){return e.key}),values:S.map(function(e){return e.val}),txid:t};y.muts.push(d);break;case"upd":d={type:"update",keys:S.map(function(e){return e.key}),changeSpecs:S.map(function(e){return e.mod}),txid:t};y.muts.push(d);break;case"del":d={type:"delete",keys:S.map(function(e){return e.key}),txid:t};y.muts.push(d)}}h.push(y)}return h}(n)}var vn=new y.BehaviorSubject(!0),ot="undefined"!=typeof document?y.fromEvent(document,"visibilitychange"):y.of({}),st=ot.pipe(pe(function(){return"hidden"===document.visibilityState})),ot=ot.pipe(pe(function(){return"hidden"===document.visibilityState})),bn="undefined"!=typeof window?y.merge(ot,y.fromEvent(window,"mousemove"),y.fromEvent(window,"keydown"),y.fromEvent(window,"wheel"),y.fromEvent(window,"touchmove")):y.of({});"undefined"!=typeof document&&y.merge(y.of(!0),st,bn).pipe(ee(function(){return"visible"===document.visibilityState}),Ee(function(e){vn.value!==e&&vn.next(e)}),ge(function(e){return e?y.of(!0).pipe(ce(3e5),Ee(function(){return vn.next(!1)})):y.of(!1)})).subscribe(function(){});var yn,mn=(n(_n,yn=Error),_n);function _n(){var e=yn.apply(this,arguments)||this;return e.name="TokenExpiredError",e}var gn,wn=(n(Sn,gn=y.Observable),Sn);function Sn(t,n,r,o){return gn.call(this,function(e){return new xn(t,n,r,o,e)})||this}var kn,En=0,xn=(n(In,kn=y.Subscription),In.prototype.teardown=function(){this.disconnect(),console.debug("Teardown WebSocket Connection",this.id)},In.prototype.disconnect=function(){if(this.pinger&&(clearInterval(this.pinger),this.pinger=null),this.ws)try{this.ws.close()}catch(e){}this.ws=null},In.prototype.reconnect=function(){this.disconnect(),this.connect()},In.prototype.connect=function(){return S(this,void 0,void 0,function(){var t,n,r,o=this;return k(this,function(e){switch(e.label){case 0:if(this.lastServerActivity=new Date,this.pauseUntil&&this.pauseUntil>new Date)return[2];if(this.ws)throw new Error("Called connect() when a connection is already open");if(!this.databaseUrl)throw new Error("Cannot connect without a database URL");if(this.closed)return[2];if(this.tokenExpiration&&this.tokenExpiration<new Date)return this.subscriber.error(new mn),[2];if(this.pinger=setInterval(function(){return S(o,void 0,void 0,function(){var t=this;return k(this,function(e){if(this.closed)return console.debug("pinger check",this.id,"CLOSED."),this.teardown(),[2];if(console.debug("pinger check",this.id,"user is active"),this.ws)try{this.ws.send(JSON.stringify({type:"ping"})),setTimeout(function(){if(console.debug("pinger setTimeout",t.id,t.pinger?"alive":"dead"),t.pinger)return t.closed?(console.debug("pinger setTimeout",t.id,"subscription is closed"),void t.teardown()):void(t.lastServerActivity<new Date(Date.now()-2e4)?(console.debug("pinger: server is inactive"),console.debug("pinger reconnecting"),t.reconnect()):console.debug("pinger: server still active"))},2e4)}catch(e){console.debug("pinger catch error",this.id,"reconnecting"),this.reconnect()}else console.debug("pinger",this.id,"reconnecting"),this.reconnect();return[2]})})},3e4),(t=new URL(this.databaseUrl)).protocol="http:"===t.protocol?"ws":"wss",n=new URLSearchParams,this.subscriber.closed)return[2];n.set("rev",this.rev),this.token&&n.set("token",this.token),console.debug("dexie-cloud WebSocket create"),(r=this.ws=new WebSocket(t+"/revision?"+n)).onclose=function(e){o.pinger&&(console.debug("dexie-cloud WebSocket onclosed"),o.reconnect())},r.onmessage=function(e){if(o.pinger){console.debug("dexie-cloud WebSocket onmessage",e.data),o.lastServerActivity=new Date;try{var t=JSON.parse(e.data);if("error"===t.type)throw new Error("dexie-cloud WebSocket Error "+t.error);"rev"===t.type&&(o.rev=t.rev),"pong"!==t.type&&o.subscriber.next(t)}catch(e){o.disconnect(),o.pauseUntil=new Date(Date.now()+6e4)}}},e.label=1;case 1:return e.trys.push([1,3,,4]),[4,new Promise(function(t,n){r.onopen=function(e){console.debug("dexie-cloud WebSocket onopen"),t(null)},r.onerror=function(e){e=e.error||new Error("WebSocket Error");console.debug("dexie-cloud WebSocket error",e),o.disconnect(),n(e)}})];case 2:return e.sent(),[3,4];case 3:return e.sent(),this.pauseUntil=new Date(Date.now()+6e4),[3,4];case 4:return[2]}})})},In);function In(e,t,n,r,o){var i=kn.call(this,function(){return i.teardown()})||this;return i.id=++En,console.debug("New WebSocket Connection",i.id,n?"authorized":"unauthorized"),i.databaseUrl=e,i.rev=t,i.token=n,i.tokenExpiration=r,i.subscriber=o,i.lastUserActivity=new Date,i.connect(),i}function Tn(e){e.cloud.usingServiceWorker?At(e):e.localSyncEvent.next({})}function Cn(o){var e,t=this;if(null===(e=o.cloud.options)||void 0===e||!e.databaseUrl)throw new Error("No database URL to connect WebSocket to");return function t(){return vn.pipe(pe(function(e){return e}),ge(function(){return o.cloud.currentUser}),pe(function(){var e;return null===(e=null===(e=o.cloud.persistedSyncState)||void 0===e?void 0:e.value)||void 0===e?void 0:e.serverRevision}),ge(function(e){var t;return new wn(o.cloud.options.databaseUrl,null===(t=null===(t=o.cloud.persistedSyncState)||void 0===t?void 0:t.value)||void 0===t?void 0:t.serverRevision,e.accessToken,e.accessTokenExpiration)}),G(function(e){return y.from(function(r){return S(this,void 0,void 0,function(){var t,n;return k(this,function(e){switch(e.label){case 0:return"TokenExpiredError"!==(null==r?void 0:r.name)?[3,3]:(console.debug("WebSocket observable: Token expired. Refreshing token..."),t=o.cloud.currentUser.value,[4,Be(o.cloud.options.databaseUrl,t)]);case 1:return n=e.sent(),[4,o.table("$logins").update(t.userId,{accessToken:n.accessToken,accessTokenExpiration:n.accessTokenExpiration})];case 2:return e.sent(),[3,4];case 3:throw console.error("WebSocket observable:",r),r;case 4:return[2]}})})}(e)).pipe(ge(t),G(function(e){return console.error("WebSocket observable: error but revive when user does some active thing...",e),y.of(!0).pipe(ce(3e3),ge(function(){return bn}),ye(1),ge(t))}))}))}().subscribe(function(r){return S(t,void 0,void 0,function(){var t,n;return k(this,function(e){switch(e.label){case 0:return[4,o.getPersistedSyncState()];case 1:switch(n=e.sent(),r.type){case"rev":(null==n||!n.serverRevision||Zt.compare(n.serverRevision,"undefined"==typeof BigInt?new Zt(r.rev):BigInt(r.rev))<0)&&Tn(o);break;case"realm-added":null!==(t=null==n?void 0:n.realms)&&void 0!==t&&t.includes(r.realm)||Tn(o);break;case"realm-removed":null!==(t=null==n?void 0:n.realms)&&void 0!==t&&t.includes(r.realm)&&Tn(o)}return[2]}})})})}function An(r){return S(this,void 0,void 0,function(){var t,n;return k(this,function(e){switch(e.label){case 0:return null!==(t=r.cloud.options)&&void 0!==t&&t.databaseUrl&&r.cloud.schema?[4,ln(r,r.cloud.options,r.cloud.schema,{justCheckIfNeeded:!0})]:[3,2];case 1:return n=e.sent(),[3,3];case 2:n=!1,e.label=3;case 3:return[2,n]}})})}function On(e,n,r){var t=null,o={cancelled:!1};function i(t){void 0===t&&(t=1),function(n,r,o,i){return S(this,void 0,void 0,function(){var t;return k(this,function(e){switch(e.label){case 0:if(an.has(n))return[2];an.add(n),e.label=1;case 1:return e.trys.push([1,7,,8]),n.cloud.usingServiceWorker?at?[4,ln(n,r,o,i)]:[3,3]:[3,4];case 2:e.sent(),e.label=3;case 3:return[3,6];case 4:return[4,Lt(n,cn,"$jobs",function(){return ln(n,r,o,i)})];case 5:e.sent(),e.label=6;case 6:return an.delete(n),console.debug("Done sync"),[3,8];case 7:throw t=e.sent(),an.delete(n),console.error("Failed to sync client changes",t),t;case 8:return[2]}})})}(e,n,r,{cancelToken:o,retryImmediatelyOnFetchError:!0}).catch(function(e){console.error("error in syncIfPossible()",e),o.cancelled?s():t<3&&setTimeout(function(){return i(t+1)},[0,5,15][t]*Ut)})}var s=function(){console.debug("Stopping LocalSyncWorker"),o.cancelled=!0,t&&t.unsubscribe()};return{start:function(){console.debug("Starting LocalSyncWorker",e.localSyncEvent.id),t=e.localSyncEvent.subscribe(function(){try{i()}catch(e){console.error("What-the....",e)}})},stop:s}}function Pn(e,t){if(e&&t&&t.unsyncedTables)for(var n=0,r=t.unsyncedTables;n<r.length;n++){var o=r[n];e[o]&&(e[o].markedForSync=!1)}}var Un,Dn,jn={},Nn=[],Ln=/acit|ex(?:s|g|n|p|$)|rph|grid|ows|mnc|ntw|ine[ch]|zoo|^ord|itera/i;function Rn(e,t){for(var n in t)e[n]=t[n];return e}function Bn(e){var t=e.parentNode;t&&t.removeChild(e)}function $n(e,t,n){var r,o,i,s=arguments,u={};for(i in t)"key"==i?r=t[i]:"ref"==i?o=t[i]:u[i]=t[i];if(3<arguments.length)for(n=[n],i=3;i<arguments.length;i++)n.push(s[i]);if(null!=n&&(u.children=n),"function"==typeof e&&null!=e.defaultProps)for(i in e.defaultProps)void 0===u[i]&&(u[i]=e.defaultProps[i]);return Wn(e,u,r,o,null)}function Wn(e,t,n,r,o){o={type:e,props:t,key:n,ref:r,__k:null,__:null,__b:0,__e:null,__d:void 0,__c:null,__h:null,constructor:void 0,__v:null==o?++Un.__v:o};return null!=Un.vnode&&Un.vnode(o),o}function Fn(e){return e.children}function Mn(e,t){this.props=e,this.context=t}function Hn(e,t){if(null==t)return e.__?Hn(e.__,e.__.__k.indexOf(e)+1):null;for(var n;t<e.__k.length;t++)if(null!=(n=e.__k[t])&&null!=n.__e)return n.__e;return"function"==typeof e.type?Hn(e):null}function Kn(e){(!e.__d&&(e.__d=!0)&&nr.push(e)&&!Vn.__r++||Dn!==Un.debounceRendering)&&((Dn=Un.debounceRendering)||rr)(Vn)}function Vn(){for(var e;Vn.__r=nr.length;)e=nr.sort(function(e,t){return e.__v.__b-t.__v.__b}),nr=[],e.some(function(e){var t,n,r,o,i;e.__d&&(o=(r=(t=e).__v).__e,(i=t.__P)&&(n=[],(e=Rn({},r)).__v=r.__v+1,Xn(i,r,e,t.__n,void 0!==i.ownerSVGElement,null!=r.__h?[o]:null,n,null==o?Hn(r):o,r.__h),Zn(n,r),r.__e!=o&&function e(t){var n,r;if(null!=(t=t.__)&&null!=t.__c){for(t.__e=t.__c.base=null,n=0;n<t.__k.length;n++)if(null!=(r=t.__k[n])&&null!=r.__e){t.__e=t.__c.base=r.__e;break}return e(t)}}(r)))})}function qn(e,t,n,r,o,i,s,u,a,c){var l,f,d,h,p,v,b,y=r&&r.__k||Nn,m=y.length;for(n.__k=[],l=0;l<t.length;l++)if(null!=(h=n.__k[l]=null==(h=t[l])||"boolean"==typeof h?null:"string"==typeof h||"number"==typeof h||"bigint"==typeof h?Wn(null,h,null,null,h):Array.isArray(h)?Wn(Fn,{children:h},null,null,null):0<h.__b?Wn(h.type,h.props,h.key,null,h.__v):h)){if(h.__=n,h.__b=n.__b+1,null===(d=y[l])||d&&h.key==d.key&&h.type===d.type)y[l]=void 0;else for(f=0;f<m;f++){if((d=y[f])&&h.key==d.key&&h.type===d.type){y[f]=void 0;break}d=null}Xn(e,h,d=d||jn,o,i,s,u,a,c),p=h.__e,(f=h.ref)&&d.ref!=f&&(b=b||[],d.ref&&b.push(d.ref,null,h),b.push(f,h.__c||p,h)),null!=p?(null==v&&(v=p),"function"==typeof h.type&&null!=h.__k&&h.__k===d.__k?h.__d=a=function e(t,n,r){var o,i;for(o=0;o<t.__k.length;o++)(i=t.__k[o])&&(i.__=t,n="function"==typeof i.type?e(i,n,r):zn(r,i,i,t.__k,i.__e,n));return n}(h,a,e):a=zn(e,h,d,y,p,a),c||"option"!==n.type?"function"==typeof n.type&&(n.__d=a):e.value=""):a&&d.__e==a&&a.parentNode!=e&&(a=Hn(d))}for(n.__e=v,l=m;l--;)null!=y[l]&&("function"==typeof n.type&&null!=y[l].__e&&y[l].__e==n.__d&&(n.__d=Hn(r,l+1)),function e(t,n,r){var o,i,s;if(Un.unmount&&Un.unmount(t),(o=t.ref)&&(o.current&&o.current!==t.__e||er(o,null,n)),r||"function"==typeof t.type||(r=null!=(i=t.__e)),t.__e=t.__d=void 0,null!=(o=t.__c)){if(o.componentWillUnmount)try{o.componentWillUnmount()}catch(t){Un.__e(t,n)}o.base=o.__P=null}if(o=t.__k)for(s=0;s<o.length;s++)o[s]&&e(o[s],n,r);null!=i&&Bn(i)}(y[l],y[l]));if(b)for(l=0;l<b.length;l++)er(b[l],b[++l],b[++l])}function zn(e,t,n,r,o,i){var s,u,a;if(void 0!==t.__d)s=t.__d,t.__d=void 0;else if(null==n||o!=i||null==o.parentNode)e:if(null==i||i.parentNode!==e)e.appendChild(o),s=null;else{for(u=i,a=0;(u=u.nextSibling)&&a<r.length;a+=2)if(u==o)break e;e.insertBefore(o,i),s=i}return void 0!==s?s:o.nextSibling}function Gn(e,t,n){"-"===t[0]?e.setProperty(t,n):e[t]=null==n?"":"number"!=typeof n||Ln.test(t)?n:n+"px"}function Jn(e,t,n,r,o){var i;e:if("style"===t)if("string"==typeof n)e.style.cssText=n;else{if("string"==typeof r&&(e.style.cssText=r=""),r)for(t in r)n&&t in n||Gn(e.style,t,"");if(n)for(t in n)r&&n[t]===r[t]||Gn(e.style,t,n[t])}else if("o"===t[0]&&"n"===t[1])i=t!==(t=t.replace(/Capture$/,"")),t=(t.toLowerCase()in e?t.toLowerCase():t).slice(2),e.l||(e.l={}),e.l[t+i]=n,n?r||e.addEventListener(t,i?Qn:Yn,i):e.removeEventListener(t,i?Qn:Yn,i);else if("dangerouslySetInnerHTML"!==t){if(o)t=t.replace(/xlink[H:h]/,"h").replace(/sName$/,"s");else if("href"!==t&&"list"!==t&&"form"!==t&&"tabIndex"!==t&&"download"!==t&&t in e)try{e[t]=null==n?"":n;break e}catch(e){}"function"==typeof n||(null!=n&&(!1!==n||"a"===t[0]&&"r"===t[1])?e.setAttribute(t,n):e.removeAttribute(t))}}function Yn(e){this.l[e.type+!1](Un.event?Un.event(e):e)}function Qn(e){this.l[e.type+!0](Un.event?Un.event(e):e)}function Xn(e,t,n,r,o,i,s,u,a){var c,l,f,d,h,p,v,b,y,m,_=t.type;if(void 0===t.constructor){null!=n.__h&&(a=n.__h,u=t.__e=n.__e,t.__h=null,i=[u]),(c=Un.__b)&&c(t);try{e:if("function"==typeof _){if(v=t.props,b=(c=_.contextType)&&r[c.__c],y=c?b?b.props.value:c.__:r,n.__c?p=(l=t.__c=n.__c).__=l.__E:("prototype"in _&&_.prototype.render?t.__c=l=new _(v,y):(t.__c=l=new Mn(v,y),l.constructor=_,l.render=tr),b&&b.sub(l),l.props=v,l.state||(l.state={}),l.context=y,l.__n=r,m=l.__d=!0,l.__h=[]),null==l.__s&&(l.__s=l.state),null!=_.getDerivedStateFromProps&&(l.__s==l.state&&(l.__s=Rn({},l.__s)),Rn(l.__s,_.getDerivedStateFromProps(v,l.__s))),f=l.props,d=l.state,m)null==_.getDerivedStateFromProps&&null!=l.componentWillMount&&l.componentWillMount(),null!=l.componentDidMount&&l.__h.push(l.componentDidMount);else{if(null==_.getDerivedStateFromProps&&v!==f&&null!=l.componentWillReceiveProps&&l.componentWillReceiveProps(v,y),!l.__e&&null!=l.shouldComponentUpdate&&!1===l.shouldComponentUpdate(v,l.__s,y)||t.__v===n.__v){l.props=v,l.state=l.__s,t.__v!==n.__v&&(l.__d=!1),(l.__v=t).__e=n.__e,t.__k=n.__k,t.__k.forEach(function(e){e&&(e.__=t)}),l.__h.length&&s.push(l);break e}null!=l.componentWillUpdate&&l.componentWillUpdate(v,l.__s,y),null!=l.componentDidUpdate&&l.__h.push(function(){l.componentDidUpdate(f,d,h)})}l.context=y,l.props=v,l.state=l.__s,(c=Un.__r)&&c(t),l.__d=!1,l.__v=t,l.__P=e,c=l.render(l.props,l.state,l.context),l.state=l.__s,null!=l.getChildContext&&(r=Rn(Rn({},r),l.getChildContext())),m||null==l.getSnapshotBeforeUpdate||(h=l.getSnapshotBeforeUpdate(f,d)),m=null!=c&&c.type===Fn&&null==c.key?c.props.children:c,qn(e,Array.isArray(m)?m:[m],t,n,r,o,i,s,u,a),l.base=t.__e,t.__h=null,l.__h.length&&s.push(l),p&&(l.__E=l.__=null),l.__e=!1}else null==i&&t.__v===n.__v?(t.__k=n.__k,t.__e=n.__e):t.__e=function(e,t,n,r,o,i,s,u){var a,c,l,f,d=n.props,h=t.props,p=t.type,v=0;if("svg"===p&&(o=!0),null!=i)for(;v<i.length;v++)if((a=i[v])&&(a===e||(p?a.localName==p:3==a.nodeType))){e=a,i[v]=null;break}if(null==e){if(null===p)return document.createTextNode(h);e=o?document.createElementNS("http://www.w3.org/2000/svg",p):document.createElement(p,h.is&&h),i=null,u=!1}if(null===p)d===h||u&&e.data===h||(e.data=h);else{if(i=i&&Nn.slice.call(e.childNodes),c=(d=n.props||jn).dangerouslySetInnerHTML,l=h.dangerouslySetInnerHTML,!u){if(null!=i)for(d={},f=0;f<e.attributes.length;f++)d[e.attributes[f].name]=e.attributes[f].value;(l||c)&&(l&&(c&&l.__html==c.__html||l.__html===e.innerHTML)||(e.innerHTML=l&&l.__html||""))}if(function(e,t,n,r,o){for(var i in n)"children"===i||"key"===i||i in t||Jn(e,i,null,n[i],r);for(i in t)o&&"function"!=typeof t[i]||"children"===i||"key"===i||"value"===i||"checked"===i||n[i]===t[i]||Jn(e,i,t[i],n[i],r)}(e,h,d,o,u),l)t.__k=[];else if(v=t.props.children,qn(e,Array.isArray(v)?v:[v],t,n,r,o&&"foreignObject"!==p,i,s,e.firstChild,u),null!=i)for(v=i.length;v--;)null!=i[v]&&Bn(i[v]);u||("value"in h&&void 0!==(v=h.value)&&(v!==e.value||"progress"===p&&!v)&&Jn(e,"value",v,d.value,!1),"checked"in h&&void 0!==(v=h.checked)&&v!==e.checked&&Jn(e,"checked",v,d.checked,!1))}return e}(n.__e,t,n,r,o,i,s,a);(c=Un.diffed)&&c(t)}catch(e){t.__v=null,!a&&null==i||(t.__e=u,t.__h=!!a,i[i.indexOf(u)]=null),Un.__e(e,t,n)}}}function Zn(e,t){Un.__c&&Un.__c(t,e),e.some(function(t){try{e=t.__h,t.__h=[],e.some(function(e){e.call(t)})}catch(e){Un.__e(e,t.__v)}})}function er(e,t,n){try{"function"==typeof e?e(t):e.current=t}catch(e){Un.__e(e,n)}}function tr(e,t,n){return this.constructor(e,n)}Un={__e:function(e,t){for(var n,r,o;t=t.__;)if((n=t.__c)&&!n.__)try{if((r=n.constructor)&&null!=r.getDerivedStateFromError&&(n.setState(r.getDerivedStateFromError(e)),o=n.__d),null!=n.componentDidCatch&&(n.componentDidCatch(e),o=n.__d),o)return n.__E=n}catch(t){e=t}throw e},__v:0},Mn.prototype.setState=function(e,t){var n=null!=this.__s&&this.__s!==this.state?this.__s:this.__s=Rn({},this.state);(e="function"==typeof e?e(Rn({},n),this.props):e)&&Rn(n,e),null!=e&&this.__v&&(t&&this.__h.push(t),Kn(this))},Mn.prototype.forceUpdate=function(e){this.__v&&(this.__e=!0,e&&this.__h.push(e),Kn(this))},Mn.prototype.render=Fn;var nr=[],rr="function"==typeof Promise?Promise.prototype.then.bind(Promise.resolve()):setTimeout,or={Error:{color:"red"},Alert:{error:{color:"red"},warning:{color:"yellow"},info:{color:"black"}},Darken:{position:"fixed",top:Vn.__r=0,left:0,opacity:.5,backgroundColor:"#000",width:"100vw",height:"100vh",zIndex:150,webkitBackdropFilter:"blur(2px)",backdropFilter:"blur(2px)"},DialogOuter:{position:"fixed",top:0,left:0,width:"100vw",height:"100vh",zIndex:150,alignItems:"center",display:"flex",justifyContent:"center"},DialogInner:{position:"relative",color:"#222",backgroundColor:"#fff",padding:"30px",marginBottom:"2em",maxWidth:"90%",maxHeight:"90%",overflowY:"auto",border:"3px solid #3d3d5d",borderRadius:"8px",boxShadow:"0 0 80px 10px #666",width:"auto"},Input:{height:"35px",width:"17em",borderColor:"#ccf4",outline:"none",fontSize:"17pt",padding:"8px"}};function ir(e){e=e.children;return $n("div",null,$n("div",{style:or.Darken}),$n("div",{style:or.DialogOuter},$n("div",{style:or.DialogInner},e)))}var sr,ur,ar,cr=0,lr=[],fr=Un.__b,dr=Un.__r,hr=Un.diffed,pr=Un.__c,vr=Un.unmount;function br(e,t){Un.__h&&Un.__h(ur,e,cr||t),cr=0;t=ur.__H||(ur.__H={__:[],__h:[]});return e>=t.__.length&&t.__.push({}),t.__[e]}function yr(e){return cr=1,t=Er,e=e,(r=br(sr++,2)).t=t,r.__c||(r.__=[n?n(e):Er(void 0,e),function(e){e=r.t(r.__[0],e);r.__[0]!==e&&(r.__=[e,r.__[1]],r.__c.setState({}))}],r.__c=ur),r.__;var t,n,r}function mr(e){return cr=5,t=function(){return{current:e}},n=[],kr((r=br(sr++,7)).__H,n)&&(r.__=t(),r.__H=n,r.__h=t),r.__;var t,n,r}function _r(){lr.forEach(function(t){if(t.__P)try{t.__H.__h.forEach(wr),t.__H.__h.forEach(Sr),t.__H.__h=[]}catch(e){t.__H.__h=[],Un.__e(e,t.__v)}}),lr=[]}Un.__b=function(e){ur=null,fr&&fr(e)},Un.__r=function(e){dr&&dr(e),sr=0;e=(ur=e.__c).__H;e&&(e.__h.forEach(wr),e.__h.forEach(Sr),e.__h=[])},Un.diffed=function(e){hr&&hr(e);e=e.__c;e&&e.__H&&e.__H.__h.length&&(1!==lr.push(e)&&ar===Un.requestAnimationFrame||((ar=Un.requestAnimationFrame)||function(e){function t(){clearTimeout(r),gr&&cancelAnimationFrame(n),setTimeout(e)}var n,r=setTimeout(t,100);gr&&(n=requestAnimationFrame(t))})(_r)),ur=void 0},Un.__c=function(e,n){n.some(function(t){try{t.__h.forEach(wr),t.__h=t.__h.filter(function(e){return!e.__||Sr(e)})}catch(e){n.some(function(e){e.__h&&(e.__h=[])}),n=[],Un.__e(e,t.__v)}}),pr&&pr(e,n)},Un.unmount=function(e){vr&&vr(e);var t=e.__c;if(t&&t.__H)try{t.__H.__.forEach(wr)}catch(e){Un.__e(e,t.__v)}};var gr="function"==typeof requestAnimationFrame;function wr(e){var t=ur;"function"==typeof e.__c&&e.__c(),ur=t}function Sr(e){var t=ur;e.__c=e.__(),ur=t}function kr(n,e){return!n||n.length!==e.length||e.some(function(e,t){return e!==n[t]})}function Er(e,t){return"function"==typeof t?t(e):t}function xr(e){var t,n=e.title,r=e.alerts,o=e.fields,i=e.onCancel,s=e.onSubmit,u=yr({}),a=u[0],c=u[1],l=mr();return t=function(){var e;return null===(e=l.current)||void 0===e?void 0:e.focus()},e=[],u=br(sr++,4),!Un.__s&&kr(u.__H,e)&&(u.__=t,u.__H=e,ur.__h.push(u)),$n(ir,null,$n(Fn,null,$n("h3",{style:or.WindowHeader},n),r.map(function(e){return $n("p",{style:or.Alert[e.type]},function(e){var t=e.message;e.messageCode;var n=e.messageParams;return t.replace(/\{\w+\}/gi,function(e){return n[e.substr(1,e.length-2)]})}(e))}),$n("form",{onSubmit:function(e){e.preventDefault(),s(a)}},Object.entries(o).map(function(e,t){var n=e[0],r=e[1],o=r.type,e=r.label,r=r.placeholder;return $n("label",{style:or.Label},e?e+": ":"",$n("input",{ref:0===t?l:void 0,type:o,name:n,autoComplete:"on",style:or.Input,autoFocus:!0,placeholder:r,value:a[n]||"",onInput:function(e){var t;return c(_(_({},a),((t={})[n]=function(e,t){switch(e){case"email":return t.toLowerCase();case"otp":return t.toUpperCase();default:return t}}(o,null===(e=e.target)||void 0===e?void 0:e.value),t)))}}))}))),$n("div",{style:or.ButtonsDiv},$n("button",{type:"submit",style:or.Button,onClick:function(){return s(a)}},"Submit"),$n("button",{style:or.Button,onClick:i},"Cancel")))}var Ir,Tr=(n(Cr,Ir=Mn),Cr.prototype.componentDidMount=function(){this.subscription=y.from(this.props.db.cloud.userInteraction).subscribe(this.observer)},Cr.prototype.componentWillUnmount=function(){this.subscription&&(this.subscription.unsubscribe(),delete this.subscription)},Cr.prototype.render=function(e,t){t=t.userInteraction;return t?$n(xr,Object.assign({},t)):null},Cr);function Cr(e){var t=Ir.call(this,e)||this;return t.observer=function(e){return t.setState({userInteraction:e})},t.state={userInteraction:void 0},t}function Ar(e){var t,n,r,o,i,s=document.createElement("div");document.body.appendChild(s),t=$n(Tr,{db:e.vip}),n=s,Un.__&&Un.__(t,n),i=(o="function"==typeof r)?null:r&&r.__k||n.__k,e=[],Xn(n,t=(!o&&r||n).__k=$n(Fn,null,[t]),i||jn,jn,void 0!==n.ownerSVGElement,!o&&r?[r]:!i&&n.firstChild?Nn.slice.call(n.childNodes):null,e,!o&&r?r:i?i.__e:n.firstChild,o),Zn(e,t);var u=!1;return{unsubscribe:function(){s.remove(),u=!0},get closed(){return u}}}function Or(a){var e=this,t=a.name,c=new y.BehaviorSubject(qe),l=[],f=null;a.on("ready",function(n){return S(e,void 0,void 0,function(){var t;return k(this,function(e){switch(e.label){case 0:return e.trys.push([0,2,,3]),[4,function(u){return S(this,void 0,void 0,function(){var t,n,r,d,h,o,i,s=this;return k(this,function(e){switch(e.label){case 0:return p=!1,d=rt(u),at||(null!==(t=d.cloud.options)&&void 0!==t&&t.customLoginGui||l.push(Ar(u)),l.push(d.syncStateChangedEvent.subscribe(u.cloud.syncState))),d.tables.every(function(e){return e.core})||ct(),"serviceWorker"in navigator?[4,navigator.serviceWorker.getRegistrations()]:[3,2];case 1:return o=e.sent(),[3,3];case 2:o=[],e.label=3;case 3:return h=o,[4,d.transaction("rw",d.$syncState,function(){return S(s,void 0,void 0,function(){var t,n,r,o,i,s,u,a,c,l,f;return k(this,function(e){switch(e.label){case 0:return n=d.cloud,t=n.options,n=n.schema,[4,Promise.all([d.getOptions(),d.getSchema(),d.getPersistedSyncState()])];case 1:return(i=e.sent(),r=i[0],o=i[1],i=i[2],t)?[3,2]:(d.cloud.options=r||null,[3,4]);case 2:return r&&JSON.stringify(r)===JSON.stringify(t)?[3,4]:[4,d.$syncState.put(t,"options")];case 3:e.sent(),e.label=4;case 4:return(null!==(t=d.cloud.options)&&void 0!==t&&t.tryUseServiceWorker&&"serviceWorker"in navigator&&0<h.length&&!ut?(console.debug("Dexie Cloud Addon: Using service worker"),d.cloud.usingServiceWorker=!0):(null!==(t=d.cloud.options)&&void 0!==t&&t.tryUseServiceWorker&&!at&&console.debug("dexie-cloud-addon: Not using service worker.",0===h.length?"No SW registrations found.":"serviceWorker"in navigator&&ut?"Avoiding SW background sync and SW periodic bg sync for this browser due to browser bugs.":"navigator.serviceWorker not present"),d.cloud.usingServiceWorker=!1),Pn(n,d.cloud.options),Pn(o,d.cloud.options),n)?[3,5]:(d.cloud.schema=o||null,[3,7]);case 5:if(o&&JSON.stringify(o)===JSON.stringify(n))return[3,7];for(s=o||{},u=0,a=Object.entries(n);u<a.length;u++)f=a[u],c=f[0],l=f[1],(f=s[c])?(f.markedForSync=l.markedForSync,l.deleted=f.deleted,f.generatedGlobalId=l.generatedGlobalId):s[c]=_({},l);return[4,d.$syncState.put(s,"schema")];case 6:e.sent(),Object.assign(n,s),e.label=7;case 7:return[2,null==i?void 0:i.initiallySynced]}})})})];case 4:return(i=e.sent())&&d.setInitiallySynced(!0),function(e){for(var t,n=0,r=e.tables;n<r.length;n++){var o=r[n];if(null!==(t=null===(t=e.cloud.schema)||void 0===t?void 0:t[o.name])&&void 0!==t&&t.markedForSync){if(o.schema.primKey.auto)throw new m.default.SchemaError("Table "+o.name+" is both autoIncremented and synced. Use db.cloud.configure({unsyncedTables: ["+JSON.stringify(o.name)+"]}) to blacklist it from sync");if(!o.schema.primKey.keyPath)throw new m.default.SchemaError("Table "+o.name+" cannot be both synced and outbound. Use db.cloud.configure({unsyncedTables: ["+JSON.stringify(o.name)+"]}) to blacklist it from sync")}}}(d),null===(o=d.cloud.options)||void 0===o||!o.databaseUrl||i?[3,6]:[4,function(n,r,o){return S(this,void 0,void 0,function(){var t=this;return k(this,function(e){switch(e.label){case 0:return console.debug("Performing initial sync"),[4,Lt(n,"initialSync","$jobs",function(){return S(t,void 0,void 0,function(){var t;return k(this,function(e){switch(e.label){case 0:return[4,n.getPersistedSyncState()];case 1:return null!=(t=e.sent())&&t.initiallySynced?[3,3]:[4,ln(n,r,o,{isInitialSync:!0})];case 2:e.sent(),e.label=3;case 3:return[2]}})})},{awaitRemoteJob:!0})];case 1:return e.sent(),console.debug("Done initial sync"),[2]}})})}(d,d.cloud.options,d.cloud.schema)];case 5:e.sent(),d.setInitiallySynced(!0),e.label=6;case 6:return v(),at||(l.push(b.liveQuery(function(){return d.getCurrentUser()}).subscribe(c)),l.push(b.liveQuery(function(){return d.getPersistedSyncState()}).subscribe(d.cloud.persistedSyncState))),null!==(i=d.cloud.options)&&void 0!==i&&i.requireAuth?[4,Ve(d)]:[3,8];case 7:e.sent(),e.label=8;case 8:return f&&f.stop(),f=null,v(),d.cloud.usingServiceWorker&&null!==(n=d.cloud.options)&&void 0!==n&&n.databaseUrl?(At(d).catch(function(){}),function(r){return S(this,void 0,void 0,function(){var t,n;return k(this,function(e){switch(e.label){case 0:return e.trys.push([0,8,,9]),[4,navigator.serviceWorker.ready];case 1:if(!(t=e.sent().periodicSync))return[3,6];e.label=2;case 2:return e.trys.push([2,4,,5]),[4,t.register("dexie-cloud:"+r.name,null===(t=r.cloud.options)||void 0===t?void 0:t.periodicSync)];case 3:return e.sent(),console.debug("Dexie Cloud: Successfully registered periodicsync event for "+r.name),[3,5];case 4:return n=e.sent(),console.debug("Dexie Cloud: Failed to register periodic sync. Your PWA must be installed to allow background sync.",n),[3,5];case 5:return[3,7];case 6:console.debug("Dexie Cloud: periodicSync not supported."),e.label=7;case 7:return[3,9];case 8:return n=e.sent(),console.debug("Dexie Cloud: Could not register periodicSync for "+r.name,n),[3,9];case 9:return[2]}})})}(d).catch(function(){})):null!==(n=d.cloud.options)&&void 0!==n&&n.databaseUrl&&d.cloud.schema&&!at&&(f=On(d,d.cloud.options,d.cloud.schema)).start(),v(),at||l.push(y.fromEvent(self,"online").subscribe(function(){console.debug("online!"),d.syncStateChangedEvent.next({phase:"not-in-sync"}),Tn(d)}),y.fromEvent(self,"offline").subscribe(function(){console.debug("offline!"),d.syncStateChangedEvent.next({phase:"offline"})})),"undefined"!=typeof window&&!at&&null!==(r=d.cloud.options)&&void 0!==r&&r.databaseUrl&&l.push(Cn(d)),[2]}})})}(n)];case 1:return e.sent(),[3,3];case 2:return t=e.sent(),console.error(t),[3,3];case 3:return[2]}})})},!0);var n,u,d,h,p=!1;function v(){if(p)throw new m.default.DatabaseClosedError}(function(e,t){e.on.close.subscribe(t);var n=e.close;e.close=function(){n.call(this),t()}})(a,function(){l.forEach(function(e){return e.unsubscribe()}),p=!0,f&&f.stop(),f=null,c.next(qe)}),a.cloud={version:"1.0.0-beta.6",options:null,schema:null,serverState:null,get currentUserId(){return c.value.userId||qe.userId},currentUser:c,syncState:new y.BehaviorSubject({phase:"initial"}),persistedSyncState:new y.BehaviorSubject(void 0),userInteraction:new y.BehaviorSubject(void 0),login:function(n){return S(this,void 0,void 0,function(){var t;return k(this,function(e){switch(e.label){case 0:return[4,(t=rt(a)).cloud.sync()];case 1:return e.sent(),[4,Ve(t,n)];case 2:return e.sent(),[2]}})})},configure:function(e){(a.cloud.options=e).databaseUrl&&(a.name=t+"-"+(e=e.databaseUrl,"/"===(e=new URL(e)).pathname?e.hostname.split(".")[0]:e.pathname.split("/")[1]),rt(a).reconfigure()),Pn(a.cloud.schema,a.cloud.options)},sync:function(e){var e=void 0===e?{wait:!0,force:!1}:e,s=e.wait,u=e.force;return S(this,void 0,void 0,function(){var r,t,n,o,i=this;return k(this,function(e){switch(e.label){case 0:return(void 0===s&&(s=!0),r=rt(a),u)?(t=r.cloud.persistedSyncState.value,Tn(r),s?[4,r.cloud.persistedSyncState.pipe(pe(function(e){return null!=(null==e?void 0:e.timestamp)&&(!t||e.timestamp>t.timestamp)}),ye(1)).toPromise()]:[3,2]):[3,3];case 1:if(null!=(n=e.sent())&&n.error)throw new Error("Sync error: "+n.error);e.label=2;case 2:return[3,6];case 3:return[4,An(r)];case 4:return e.sent()?(o=r.cloud.persistedSyncState.value,Tn(r),s?(console.debug("db.cloud.login() is waiting for sync completion..."),[4,y.from(b.liveQuery(function(){return S(i,void 0,void 0,function(){var t,n;return k(this,function(e){switch(e.label){case 0:return[4,An(r)];case 1:return t=e.sent(),[4,r.getPersistedSyncState()];case 2:if((null==(n=e.sent())?void 0:n.timestamp)!==(null==o?void 0:o.timestamp)&&null!=n&&n.error)throw new Error("Sync error: "+n.error);return[2,t]}})})})).pipe(pe(function(e){return!e}),ye(1)).toPromise()]):[3,6]):[3,6];case 5:e.sent(),console.debug("Done waiting for sync completion because we have nothing to push anymore"),e.label=6;case 6:return[2]}})})}},a.Version.prototype._parseStoresSpec=m.default.override(a.Version.prototype._parseStoresSpec,function(e){return Pt(e,a)}),a.use((n={currentUserObservable:a.cloud.currentUser,db:rt(a)},u=n.currentUserObservable,d=n.db,{stack:"dbcore",name:"MutationTrackingMiddleware",level:1,create:function(s){var t,e=s.schema.tables.filter(function(e){return!/^\$/.test(e.name)});try{t=new Map(e.map(function(e){return[e.name,s.table("$"+e.name+"_mutations")]}))}catch(e){ct()}return _(_({},s),{transaction:function(e,t){var n,r,o,i;return r="readwrite"===t?(n=e.filter(function(e){var t;return null===(e=null===(t=d.cloud.schema)||void 0===t?void 0:t[e])||void 0===e?void 0:e.markedForSync}).map(kt),s.transaction(g(g([],e),n),t)):s.transaction(e,t),"readwrite"===t&&(r.txid=Et(16),r.currentUser=u.value,Ot.value.add(r),Ot.next(Ot.value),o=function(){r.removeEventListener("complete",i),r.removeEventListener("error",o),r.removeEventListener("abort",o),Ot.value.delete(r),Ot.next(Ot.value)},i=function(){var e;r.mutationsAdded&&null!==(e=d.cloud.options)&&void 0!==e&&e.databaseUrl&&(d.cloud.usingServiceWorker?(console.debug("registering sync event"),At(d)):d.localSyncEvent.next({})),o()},r.addEventListener("complete",i),r.addEventListener("error",o),r.addEventListener("abort",o)),r},table:function(e){var r=s.table(e);if(/^\$/.test(e))return e.endsWith("_mutations")?_(_({},r),{mutate:function(e){return"add"!==e.type&&"put"!==e.type||(e.trans.mutationsAdded=!0),r.mutate(e)}}):"$logins"===e?_(_({},r),{mutate:function(t){return console.debug("Mutating $logins table",t),r.mutate(t).then(function(e){return console.debug("Mutating $logins"),t.trans.mutationsAdded=!0,console.debug("$logins mutated"),e}).catch(function(e){return console.debug("Failed mutation $logins",e),Promise.reject(e)})}}):r;var o=r.schema,f=t.get(e);return It(_(_({},r),{mutate:function(t){var e,n=t.trans;return n.txid&&!n.disableChangeTracking&&null!==(e=n.currentUser)&&void 0!==e&&e.isLoggedIn?"deleteRange"===t.type?r.query({query:{range:t.range,index:o.primaryKey},trans:t.trans,values:!1}).then(function(e){return i({type:"delete",keys:e.result,trans:t.trans,criteria:{index:null,range:t.range}})}):i(t):r.mutate(t)}}));function i(s){var u=s.trans;u.mutationsAdded=!0;var a=u.txid,c=u.currentUser.userId,l=s.type;return r.mutate(s).then(function(e){var t=e.numFailures,n=e.failures,r="delete"===l?s.keys:e.results,o="values"in s?s.values:[],i="changeSpecs"in s?s.changeSpecs:[];t&&(r=r.filter(function(e,t){return!n[t]}),o=o.filter(function(e,t){return!n[t]}),i=i.filter(function(e,t){return!n[t]}));t=Date.now(),o="delete"===s.type?{type:"delete",ts:t,keys:r,criteria:s.criteria,txid:a,userId:c}:"add"===s.type?{type:"insert",ts:t,keys:r,txid:a,userId:c,values:o}:s.criteria&&s.changeSpec?{type:"modify",ts:t,keys:r,criteria:s.criteria,changeSpec:s.changeSpec,txid:a,userId:c}:s.changeSpecs?{type:"update",ts:t,keys:r,changeSpecs:i,txid:a,userId:c}:{type:"upsert",ts:t,keys:r,values:o,txid:a,userId:c};return 0<r.length||"criteria"in s&&s.criteria?f.mutate({type:"add",trans:u,values:[o]}).then(function(){return e}):e})}}})}})),a.use((h=rt(a),{stack:"dbcore",name:"implicitPropSetterMiddleware",level:1,create:function(e){return _(_({},e),{table:function(u){var a=e.table(u);return _(_({},a),{mutate:function(e){var t,n,r=e.trans;if(null!==(t=null===(t=h.cloud.schema)||void 0===t?void 0:t[u])&&void 0!==t&&t.markedForSync&&null!==(n=r.currentUser)&&void 0!==n&&n.isLoggedIn&&("add"===e.type||"put"===e.type))for(var o=0,i=e.values;o<i.length;o++){var s=i[o];"owner"in s||(s.owner=r.currentUser.userId),"realmId"in s||(s.realmId=r.currentUser.userId)}return a.mutate(e)}})}})}})),a.use(St(rt(a)))}Or.version="1.0.0-beta.6",m.default.Cloud=Or,e.default=Or,e.dexieCloud=Or,Object.defineProperty(e,"__esModule",{value:!0})});