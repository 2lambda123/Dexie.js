import e,{liveQuery as t}from"dexie";import{BehaviorSubject as n,fromEvent as r,of as i,merge as o,from as s,Observable as u,Subscription as a}from"rxjs";var c=function(e,t){return(c=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])})(e,t)};function l(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function n(){this.constructor=e}c(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}var f=function(){return(f=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var i in t=arguments[n])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e}).apply(this,arguments)};function d(e,t,n,r){return new(n||(n=Promise))((function(i,o){function s(e){try{a(r.next(e))}catch(e){o(e)}}function u(e){try{a(r.throw(e))}catch(e){o(e)}}function a(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,u)}a((r=r.apply(e,t||[])).next())}))}function h(e,t){var n,r,i,o,s={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return o={next:u(0),throw:u(1),return:u(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function u(o){return function(u){return function(o){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,r&&(i=2&o[0]?r.return:o[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,o[1])).done)return i;switch(r=0,i&&(o=[2&o[0],i.value]),o[0]){case 0:case 1:i=o;break;case 4:return s.label++,{value:o[1],done:!1};case 5:s.label++,r=o[1],o=[0];continue;case 7:o=s.ops.pop(),s.trys.pop();continue;default:if(!(i=s.trys,(i=i.length>0&&i[i.length-1])||6!==o[0]&&2!==o[0])){s=0;continue}if(3===o[0]&&(!i||o[1]>i[0]&&o[1]<i[3])){s.label=o[1];break}if(6===o[0]&&s.label<i[1]){s.label=i[1],i=o;break}if(i&&s.label<i[2]){s.label=i[2],s.ops.push(o);break}i[2]&&s.ops.pop(),s.trys.pop();continue}o=t.call(e,s)}catch(e){o=[6,e],r=0}finally{n=i=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,u])}}}function p(e,t){for(var n=0,r=t.length,i=e.length;n<r;n++,i++)e[i]=t[n];return e}var v=crypto.getRandomValues;function b(e,t,n){if(e&&void 0!==t&&(!("isFrozen"in Object)||!Object.isFrozen(e)))if("string"!=typeof t&&"length"in t){!function(e){if(!e)throw new Error("Assertion Failed")}("string"!=typeof n&&"length"in n);for(var r=0,i=t.length;r<i;++r)b(e,t[r],n[r])}else{var o=t.indexOf(".");if(-1!==o){var s=t.substr(0,o),u=t.substr(o+1);if(""===u)void 0===n?Array.isArray(e)?isNaN(parseInt(s))||e.splice(parseInt(s),1):delete e[s]:e[s]=n;else{var a=e[s];a||(a=e[s]={}),b(a,u,n)}}else void 0===n?Array.isArray(e)&&!isNaN(parseInt(t))?e.splice(t,1):delete e[t]:e[t]=n}}var y="undefined"==typeof self?function(e){var t=Buffer.alloc(e);return v(t),t.toString("base64")}:function(e){var t=new Uint8Array(e);return crypto.getRandomValues(t),btoa(String.fromCharCode.apply(null,t))};function m(e){return"string"==typeof e||!!(Array.isArray(e)&&e.some((function(e){return m(e)}))&&e.every(_))}function _(e){return"string"==typeof e||"number"==typeof e||Array.isArray(e)&&e.every(_)}function g(e,t,n){var r=e[t]||(e[t]={});switch(n.type){case"insert":case"upsert":n.keys.forEach((function(e,t){r[e]={type:"ups",val:n.values[t]}}));break;case"update":case"modify":n.keys.forEach((function(e,t){var i="update"===n.type?n.changeSpecs[t]:n.changeSpec,o=r[e];if(o)switch(o.type){case"ups":for(var s=0,u=Object.entries(i);s<u.length;s++){var a=u[s],c=a[0],l=a[1];b(o.val,c,l)}break;case"del":break;case"upd":Object.assign(o.mod,i)}else r[e]={type:"upd",mod:i}}));break;case"delete":n.keys.forEach((function(e){r[e]={type:"del"}}))}return e}function w(e,t){for(var n=0,r=t;n<r.length;n++)for(var i=r[n],o=i.table,s=0,u=i.muts;s<u.length;s++){g(e,o,u[s])}}var S=function(e,t){return(S=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(e,t)};function k(e,t){function n(){this.constructor=e}S(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}function E(e){return"function"==typeof e}var x=!1,I={Promise:void 0,set useDeprecatedSynchronousErrorHandling(e){e&&(new Error).stack;x=e},get useDeprecatedSynchronousErrorHandling(){return x}};function T(e){setTimeout((function(){throw e}),0)}var C={closed:!0,next:function(e){},error:function(e){if(I.useDeprecatedSynchronousErrorHandling)throw e;T(e)},complete:function(){}},A=function(){return Array.isArray||function(e){return e&&"number"==typeof e.length}}();function O(e){return null!==e&&"object"==typeof e}var P=function(){function e(e){return Error.call(this),this.message=e?e.length+" errors occurred during unsubscription:\n"+e.map((function(e,t){return t+1+") "+e.toString()})).join("\n  "):"",this.name="UnsubscriptionError",this.errors=e,this}return e.prototype=Object.create(Error.prototype),e}(),U=function(){function e(e){this.closed=!1,this._parentOrParents=null,this._subscriptions=null,e&&(this._ctorUnsubscribe=!0,this._unsubscribe=e)}return e.prototype.unsubscribe=function(){var t;if(!this.closed){var n=this,r=n._parentOrParents,i=n._ctorUnsubscribe,o=n._unsubscribe,s=n._subscriptions;if(this.closed=!0,this._parentOrParents=null,this._subscriptions=null,r instanceof e)r.remove(this);else if(null!==r)for(var u=0;u<r.length;++u){r[u].remove(this)}if(E(o)){i&&(this._unsubscribe=void 0);try{o.call(this)}catch(e){t=e instanceof P?D(e.errors):[e]}}if(A(s)){u=-1;for(var a=s.length;++u<a;){var c=s[u];if(O(c))try{c.unsubscribe()}catch(e){t=t||[],e instanceof P?t=t.concat(D(e.errors)):t.push(e)}}}if(t)throw new P(t)}},e.prototype.add=function(t){var n=t;if(!t)return e.EMPTY;switch(typeof t){case"function":n=new e(t);case"object":if(n===this||n.closed||"function"!=typeof n.unsubscribe)return n;if(this.closed)return n.unsubscribe(),n;if(!(n instanceof e)){var r=n;(n=new e)._subscriptions=[r]}break;default:throw new Error("unrecognized teardown "+t+" added to Subscription.")}var i=n._parentOrParents;if(null===i)n._parentOrParents=this;else if(i instanceof e){if(i===this)return n;n._parentOrParents=[i,this]}else{if(-1!==i.indexOf(this))return n;i.push(this)}var o=this._subscriptions;return null===o?this._subscriptions=[n]:o.push(n),n},e.prototype.remove=function(e){var t=this._subscriptions;if(t){var n=t.indexOf(e);-1!==n&&t.splice(n,1)}},e.EMPTY=function(e){return e.closed=!0,e}(new e),e}();function D(e){return e.reduce((function(e,t){return e.concat(t instanceof P?t.errors:t)}),[])}var N=function(){return"function"==typeof Symbol?Symbol("rxSubscriber"):"@@rxSubscriber_"+Math.random()}(),j=function(e){function t(n,r,i){var o=e.call(this)||this;switch(o.syncErrorValue=null,o.syncErrorThrown=!1,o.syncErrorThrowable=!1,o.isStopped=!1,arguments.length){case 0:o.destination=C;break;case 1:if(!n){o.destination=C;break}if("object"==typeof n){n instanceof t?(o.syncErrorThrowable=n.syncErrorThrowable,o.destination=n,n.add(o)):(o.syncErrorThrowable=!0,o.destination=new L(o,n));break}default:o.syncErrorThrowable=!0,o.destination=new L(o,n,r,i)}return o}return k(t,e),t.prototype[N]=function(){return this},t.create=function(e,n,r){var i=new t(e,n,r);return i.syncErrorThrowable=!1,i},t.prototype.next=function(e){this.isStopped||this._next(e)},t.prototype.error=function(e){this.isStopped||(this.isStopped=!0,this._error(e))},t.prototype.complete=function(){this.isStopped||(this.isStopped=!0,this._complete())},t.prototype.unsubscribe=function(){this.closed||(this.isStopped=!0,e.prototype.unsubscribe.call(this))},t.prototype._next=function(e){this.destination.next(e)},t.prototype._error=function(e){this.destination.error(e),this.unsubscribe()},t.prototype._complete=function(){this.destination.complete(),this.unsubscribe()},t.prototype._unsubscribeAndRecycle=function(){var e=this._parentOrParents;return this._parentOrParents=null,this.unsubscribe(),this.closed=!1,this.isStopped=!1,this._parentOrParents=e,this},t}(U),L=function(e){function t(t,n,r,i){var o,s=e.call(this)||this;s._parentSubscriber=t;var u=s;return E(n)?o=n:n&&(o=n.next,r=n.error,i=n.complete,n!==C&&(E((u=Object.create(n)).unsubscribe)&&s.add(u.unsubscribe.bind(u)),u.unsubscribe=s.unsubscribe.bind(s))),s._context=u,s._next=o,s._error=r,s._complete=i,s}return k(t,e),t.prototype.next=function(e){if(!this.isStopped&&this._next){var t=this._parentSubscriber;I.useDeprecatedSynchronousErrorHandling&&t.syncErrorThrowable?this.__tryOrSetError(t,this._next,e)&&this.unsubscribe():this.__tryOrUnsub(this._next,e)}},t.prototype.error=function(e){if(!this.isStopped){var t=this._parentSubscriber,n=I.useDeprecatedSynchronousErrorHandling;if(this._error)n&&t.syncErrorThrowable?(this.__tryOrSetError(t,this._error,e),this.unsubscribe()):(this.__tryOrUnsub(this._error,e),this.unsubscribe());else if(t.syncErrorThrowable)n?(t.syncErrorValue=e,t.syncErrorThrown=!0):T(e),this.unsubscribe();else{if(this.unsubscribe(),n)throw e;T(e)}}},t.prototype.complete=function(){var e=this;if(!this.isStopped){var t=this._parentSubscriber;if(this._complete){var n=function(){return e._complete.call(e._context)};I.useDeprecatedSynchronousErrorHandling&&t.syncErrorThrowable?(this.__tryOrSetError(t,n),this.unsubscribe()):(this.__tryOrUnsub(n),this.unsubscribe())}else this.unsubscribe()}},t.prototype.__tryOrUnsub=function(e,t){try{e.call(this._context,t)}catch(e){if(this.unsubscribe(),I.useDeprecatedSynchronousErrorHandling)throw e;T(e)}},t.prototype.__tryOrSetError=function(e,t,n){if(!I.useDeprecatedSynchronousErrorHandling)throw new Error("bad call");try{t.call(this._context,n)}catch(t){return I.useDeprecatedSynchronousErrorHandling?(e.syncErrorValue=t,e.syncErrorThrown=!0,!0):(T(t),!0)}return!1},t.prototype._unsubscribe=function(){var e=this._parentSubscriber;this._context=null,this._parentSubscriber=null,e.unsubscribe()},t}(j);var R=function(){return"function"==typeof Symbol&&Symbol.observable||"@@observable"}();function $(e){return e}function B(e){return 0===e.length?$:1===e.length?e[0]:function(t){return e.reduce((function(e,t){return t(e)}),t)}}var W=function(){function e(e){this._isScalar=!1,e&&(this._subscribe=e)}return e.prototype.lift=function(t){var n=new e;return n.source=this,n.operator=t,n},e.prototype.subscribe=function(e,t,n){var r=this.operator,i=function(e,t,n){if(e){if(e instanceof j)return e;if(e[N])return e[N]()}return e||t||n?new j(e,t,n):new j(C)}(e,t,n);if(r?i.add(r.call(i,this.source)):i.add(this.source||I.useDeprecatedSynchronousErrorHandling&&!i.syncErrorThrowable?this._subscribe(i):this._trySubscribe(i)),I.useDeprecatedSynchronousErrorHandling&&i.syncErrorThrowable&&(i.syncErrorThrowable=!1,i.syncErrorThrown))throw i.syncErrorValue;return i},e.prototype._trySubscribe=function(e){try{return this._subscribe(e)}catch(t){I.useDeprecatedSynchronousErrorHandling&&(e.syncErrorThrown=!0,e.syncErrorValue=t),!function(e){for(;e;){var t=e,n=t.closed,r=t.destination,i=t.isStopped;if(n||i)return!1;e=r&&r instanceof j?r:null}return!0}(e)?console.warn(t):e.error(t)}},e.prototype.forEach=function(e,t){var n=this;return new(t=F(t))((function(t,r){var i;i=n.subscribe((function(t){try{e(t)}catch(e){r(e),i&&i.unsubscribe()}}),r,t)}))},e.prototype._subscribe=function(e){var t=this.source;return t&&t.subscribe(e)},e.prototype[R]=function(){return this},e.prototype.pipe=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return 0===e.length?this:B(e)(this)},e.prototype.toPromise=function(e){var t=this;return new(e=F(e))((function(e,n){var r;t.subscribe((function(e){return r=e}),(function(e){return n(e)}),(function(){return e(r)}))}))},e.create=function(t){return new e(t)},e}();function F(e){if(e||(e=Promise),!e)throw new Error("no Promise impl found");return e}var M=function(e){return function(t){for(var n=0,r=e.length;n<r&&!t.closed;n++)t.next(e[n]);t.complete()}};function H(){return"function"==typeof Symbol&&Symbol.iterator?Symbol.iterator:"@@iterator"}var K=H(),V=function(e){return e&&"number"==typeof e.length&&"function"!=typeof e};function q(e){return!!e&&"function"!=typeof e.subscribe&&"function"==typeof e.then}var z=function(e){if(e&&"function"==typeof e[R])return r=e,function(e){var t=r[R]();if("function"!=typeof t.subscribe)throw new TypeError("Provided object does not correctly implement Symbol.observable");return t.subscribe(e)};if(V(e))return M(e);if(q(e))return n=e,function(e){return n.then((function(t){e.closed||(e.next(t),e.complete())}),(function(t){return e.error(t)})).then(null,T),e};if(e&&"function"==typeof e[K])return t=e,function(e){for(var n=t[K]();;){var r=void 0;try{r=n.next()}catch(t){return e.error(t),e}if(r.done){e.complete();break}if(e.next(r.value),e.closed)break}return"function"==typeof n.return&&e.add((function(){n.return&&n.return()})),e};var t,n,r,i=O(e)?"an invalid object":"'"+e+"'";throw new TypeError("You provided "+i+" where a stream was expected. You can provide an Observable, Promise, Array, or Iterable.")},G=function(e){function t(t){var n=e.call(this)||this;return n.parent=t,n}return k(t,e),t.prototype._next=function(e){this.parent.notifyNext(e)},t.prototype._error=function(e){this.parent.notifyError(e),this.unsubscribe()},t.prototype._complete=function(){this.parent.notifyComplete(),this.unsubscribe()},t}(j),J=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return k(t,e),t.prototype.notifyNext=function(e){this.destination.next(e)},t.prototype.notifyError=function(e){this.destination.error(e)},t.prototype.notifyComplete=function(){this.destination.complete()},t}(j);function Y(e,t){if(!t.closed){if(e instanceof W)return e.subscribe(t);var n;try{n=z(e)(t)}catch(e){t.error(e)}return n}}var X=function(e){function t(t,n){var r=e.call(this,t,n)||this;return r.scheduler=t,r.work=n,r.pending=!1,r}return k(t,e),t.prototype.schedule=function(e,t){if(void 0===t&&(t=0),this.closed)return this;this.state=e;var n=this.id,r=this.scheduler;return null!=n&&(this.id=this.recycleAsyncId(r,n,t)),this.pending=!0,this.delay=t,this.id=this.id||this.requestAsyncId(r,this.id,t),this},t.prototype.requestAsyncId=function(e,t,n){return void 0===n&&(n=0),setInterval(e.flush.bind(e,this),n)},t.prototype.recycleAsyncId=function(e,t,n){if(void 0===n&&(n=0),null!==n&&this.delay===n&&!1===this.pending)return t;clearInterval(t)},t.prototype.execute=function(e,t){if(this.closed)return new Error("executing a cancelled action");this.pending=!1;var n=this._execute(e,t);if(n)return n;!1===this.pending&&null!=this.id&&(this.id=this.recycleAsyncId(this.scheduler,this.id,null))},t.prototype._execute=function(e,t){var n=!1,r=void 0;try{this.work(e)}catch(e){n=!0,r=!!e&&e||new Error(e)}if(n)return this.unsubscribe(),r},t.prototype._unsubscribe=function(){var e=this.id,t=this.scheduler,n=t.actions,r=n.indexOf(this);this.work=null,this.state=null,this.pending=!1,this.scheduler=null,-1!==r&&n.splice(r,1),null!=e&&(this.id=this.recycleAsyncId(t,e,null)),this.delay=null},t}(function(e){function t(t,n){return e.call(this)||this}return k(t,e),t.prototype.schedule=function(e,t){return this},t}(U)),Z=function(){function e(t,n){void 0===n&&(n=e.now),this.SchedulerAction=t,this.now=n}return e.prototype.schedule=function(e,t,n){return void 0===t&&(t=0),new this.SchedulerAction(this,e).schedule(n,t)},e.now=function(){return Date.now()},e}(),Q=new(function(e){function t(n,r){void 0===r&&(r=Z.now);var i=e.call(this,n,(function(){return t.delegate&&t.delegate!==i?t.delegate.now():r()}))||this;return i.actions=[],i.active=!1,i.scheduled=void 0,i}return k(t,e),t.prototype.schedule=function(n,r,i){return void 0===r&&(r=0),t.delegate&&t.delegate!==this?t.delegate.schedule(n,r,i):e.prototype.schedule.call(this,n,r,i)},t.prototype.flush=function(e){var t=this.actions;if(this.active)t.push(e);else{var n;this.active=!0;do{if(n=e.execute(e.state,e.delay))break}while(e=t.shift());if(this.active=!1,n){for(;e=t.shift();)e.unsubscribe();throw n}}},t}(Z))(X);function ee(e){return e&&"function"==typeof e.schedule}function te(e){return function(t){var n=new ne(e),r=t.lift(n);return n.caught=r}}var ne=function(){function e(e){this.selector=e}return e.prototype.call=function(e,t){return t.subscribe(new re(e,this.selector,this.caught))},e}(),re=function(e){function t(t,n,r){var i=e.call(this,t)||this;return i.selector=n,i.caught=r,i}return k(t,e),t.prototype.error=function(t){if(!this.isStopped){var n=void 0;try{n=this.selector(t,this.caught)}catch(t){return void e.prototype.error.call(this,t)}this._unsubscribeAndRecycle();var r=new G(this);this.add(r);var i=Y(n,r);i!==r&&this.add(i)}},t}(J);function ie(e,t){return new W((function(n){var r=new U,i=0;return r.add(t.schedule((function(){i!==e.length?(n.next(e[i++]),n.closed||r.add(this.schedule())):n.complete()}))),r}))}function oe(e,t){return t?ie(e,t):new W(M(e))}function se(e,t){if(null!=e){if(function(e){return e&&"function"==typeof e[R]}(e))return function(e,t){return new W((function(n){var r=new U;return r.add(t.schedule((function(){var i=e[R]();r.add(i.subscribe({next:function(e){r.add(t.schedule((function(){return n.next(e)})))},error:function(e){r.add(t.schedule((function(){return n.error(e)})))},complete:function(){r.add(t.schedule((function(){return n.complete()})))}}))}))),r}))}(e,t);if(q(e))return function(e,t){return new W((function(n){var r=new U;return r.add(t.schedule((function(){return e.then((function(e){r.add(t.schedule((function(){n.next(e),r.add(t.schedule((function(){return n.complete()})))})))}),(function(e){r.add(t.schedule((function(){return n.error(e)})))}))}))),r}))}(e,t);if(V(e))return ie(e,t);if(function(e){return e&&"function"==typeof e[K]}(e)||"string"==typeof e)return function(e,t){if(!e)throw new Error("Iterable cannot be null");return new W((function(n){var r,i=new U;return i.add((function(){r&&"function"==typeof r.return&&r.return()})),i.add(t.schedule((function(){r=e[K](),i.add(t.schedule((function(){if(!n.closed){var e,t;try{var i=r.next();e=i.value,t=i.done}catch(e){return void n.error(e)}t?n.complete():(n.next(e),this.schedule())}})))}))),i}))}(e,t)}throw new TypeError((null!==e&&typeof e||e)+" is not observable")}function ue(e,t){return function(n){if("function"!=typeof e)throw new TypeError("argument is not a function. Are you looking for `mapTo()`?");return n.lift(new ae(e,t))}}var ae=function(){function e(e,t){this.project=e,this.thisArg=t}return e.prototype.call=function(e,t){return t.subscribe(new ce(e,this.project,this.thisArg))},e}(),ce=function(e){function t(t,n,r){var i=e.call(this,t)||this;return i.project=n,i.count=0,i.thisArg=r||i,i}return k(t,e),t.prototype._next=function(e){var t;try{t=this.project.call(this.thisArg,e,this.count++)}catch(e){return void this.destination.error(e)}this.destination.next(t)},t}(j);function le(e){return e instanceof Date&&!isNaN(+e)}var fe=new W((function(e){return e.complete()}));function de(e){return e?function(e){return new W((function(t){return e.schedule((function(){return t.complete()}))}))}(e):fe}function he(e,t){return new W(t?function(n){return t.schedule(pe,0,{error:e,subscriber:n})}:function(t){return t.error(e)})}function pe(e){var t=e.error;e.subscriber.error(t)}var ve=function(){function e(e,t,n){this.kind=e,this.value=t,this.error=n,this.hasValue="N"===e}return e.prototype.observe=function(e){switch(this.kind){case"N":return e.next&&e.next(this.value);case"E":return e.error&&e.error(this.error);case"C":return e.complete&&e.complete()}},e.prototype.do=function(e,t,n){switch(this.kind){case"N":return e&&e(this.value);case"E":return t&&t(this.error);case"C":return n&&n()}},e.prototype.accept=function(e,t,n){return e&&"function"==typeof e.next?this.observe(e):this.do(e,t,n)},e.prototype.toObservable=function(){switch(this.kind){case"N":return function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var n=e[e.length-1];return ee(n)?(e.pop(),ie(e,n)):oe(e)}(this.value);case"E":return he(this.error);case"C":return de()}throw new Error("unexpected notification kind value")},e.createNext=function(t){return void 0!==t?new e("N",t):e.undefinedValueNotification},e.createError=function(t){return new e("E",void 0,t)},e.createComplete=function(){return e.completeNotification},e.completeNotification=new e("C"),e.undefinedValueNotification=new e("N",void 0),e}();function be(e,t){void 0===t&&(t=Q);var n=le(e)?+e-t.now():Math.abs(e);return function(e){return e.lift(new ye(n,t))}}var ye=function(){function e(e,t){this.delay=e,this.scheduler=t}return e.prototype.call=function(e,t){return t.subscribe(new me(e,this.delay,this.scheduler))},e}(),me=function(e){function t(t,n,r){var i=e.call(this,t)||this;return i.delay=n,i.scheduler=r,i.queue=[],i.active=!1,i.errored=!1,i}return k(t,e),t.dispatch=function(e){for(var t=e.source,n=t.queue,r=e.scheduler,i=e.destination;n.length>0&&n[0].time-r.now()<=0;)n.shift().notification.observe(i);if(n.length>0){var o=Math.max(0,n[0].time-r.now());this.schedule(e,o)}else this.unsubscribe(),t.active=!1},t.prototype._schedule=function(e){this.active=!0,this.destination.add(e.schedule(t.dispatch,this.delay,{source:this,destination:this.destination,scheduler:e}))},t.prototype.scheduleNotification=function(e){if(!0!==this.errored){var t=this.scheduler,n=new _e(t.now()+this.delay,e);this.queue.push(n),!1===this.active&&this._schedule(t)}},t.prototype._next=function(e){this.scheduleNotification(ve.createNext(e))},t.prototype._error=function(e){this.errored=!0,this.queue=[],this.destination.error(e),this.unsubscribe()},t.prototype._complete=function(){this.scheduleNotification(ve.createComplete()),this.unsubscribe()},t}(j),_e=function(){return function(e,t){this.time=e,this.notification=t}}(),ge=function(){function e(){return Error.call(this),this.message="argument out of range",this.name="ArgumentOutOfRangeError",this}return e.prototype=Object.create(Error.prototype),e}();function we(e,t){return function(n){return n.lift(new Se(e,t))}}var Se=function(){function e(e,t){this.predicate=e,this.thisArg=t}return e.prototype.call=function(e,t){return t.subscribe(new ke(e,this.predicate,this.thisArg))},e}(),ke=function(e){function t(t,n,r){var i=e.call(this,t)||this;return i.predicate=n,i.thisArg=r,i.count=0,i}return k(t,e),t.prototype._next=function(e){var t;try{t=this.predicate.call(this.thisArg,e,this.count++)}catch(e){return void this.destination.error(e)}t&&this.destination.next(e)},t}(j);function Ee(e){return function(t){return 0===e?de():t.lift(new xe(e))}}var xe=function(){function e(e){if(this.total=e,this.total<0)throw new ge}return e.prototype.call=function(e,t){return t.subscribe(new Ie(e,this.total))},e}(),Ie=function(e){function t(t,n){var r=e.call(this,t)||this;return r.total=n,r.count=0,r}return k(t,e),t.prototype._next=function(e){var t=this.total,n=++this.count;n<=t&&(this.destination.next(e),n===t&&(this.destination.complete(),this.unsubscribe()))},t}(j);function Te(e,t){return"function"==typeof t?function(n){return n.pipe(Te((function(n,r){return(i=e(n,r),o?se(i,o):i instanceof W?i:new W(z(i))).pipe(ue((function(e,i){return t(n,e,r,i)})));var i,o})))}:function(t){return t.lift(new Ce(e))}}var Ce=function(){function e(e){this.project=e}return e.prototype.call=function(e,t){return t.subscribe(new Ae(e,this.project))},e}(),Ae=function(e){function t(t,n){var r=e.call(this,t)||this;return r.project=n,r.index=0,r}return k(t,e),t.prototype._next=function(e){var t,n=this.index++;try{t=this.project(e,n)}catch(e){return void this.destination.error(e)}this._innerSub(t)},t.prototype._innerSub=function(e){var t=this.innerSubscription;t&&t.unsubscribe();var n=new G(this),r=this.destination;r.add(n),this.innerSubscription=Y(e,n),this.innerSubscription!==n&&r.add(this.innerSubscription)},t.prototype._complete=function(){var t=this.innerSubscription;t&&!t.closed||e.prototype._complete.call(this),this.unsubscribe()},t.prototype._unsubscribe=function(){this.innerSubscription=void 0},t.prototype.notifyComplete=function(){this.innerSubscription=void 0,this.isStopped&&e.prototype._complete.call(this)},t.prototype.notifyNext=function(e){this.destination.next(e)},t}(J);function Oe(){}function Pe(e,t,n){return function(r){return r.lift(new Ue(e,t,n))}}var Ue=function(){function e(e,t,n){this.nextOrObserver=e,this.error=t,this.complete=n}return e.prototype.call=function(e,t){return t.subscribe(new De(e,this.nextOrObserver,this.error,this.complete))},e}(),De=function(e){function t(t,n,r,i){var o=e.call(this,t)||this;return o._tapNext=Oe,o._tapError=Oe,o._tapComplete=Oe,o._tapError=r||Oe,o._tapComplete=i||Oe,E(n)?(o._context=o,o._tapNext=n):n&&(o._context=n,o._tapNext=n.next||Oe,o._tapError=n.error||Oe,o._tapComplete=n.complete||Oe),o}return k(t,e),t.prototype._next=function(e){try{this._tapNext.call(this._context,e)}catch(e){return void this.destination.error(e)}this.destination.next(e)},t.prototype._error=function(e){try{this._tapError.call(this._context,e)}catch(e){return void this.destination.error(e)}this.destination.error(e)},t.prototype._complete=function(){try{this._tapComplete.call(this._context)}catch(e){return void this.destination.error(e)}return this.destination.complete()},t}(j),Ne=function(){function e(){return Error.call(this),this.message="Timeout has occurred",this.name="TimeoutError",this}return e.prototype=Object.create(Error.prototype),e}();var je=function(){function e(e,t,n,r){this.waitFor=e,this.absoluteTimeout=t,this.withObservable=n,this.scheduler=r}return e.prototype.call=function(e,t){return t.subscribe(new Le(e,this.absoluteTimeout,this.waitFor,this.withObservable,this.scheduler))},e}(),Le=function(e){function t(t,n,r,i,o){var s=e.call(this,t)||this;return s.absoluteTimeout=n,s.waitFor=r,s.withObservable=i,s.scheduler=o,s.scheduleTimeout(),s}return k(t,e),t.dispatchTimeout=function(e){var t=e.withObservable;e._unsubscribeAndRecycle(),e.add(Y(t,new G(e)))},t.prototype.scheduleTimeout=function(){var e=this.action;e?this.action=e.schedule(this,this.waitFor):this.add(this.action=this.scheduler.schedule(t.dispatchTimeout,this.waitFor,this))},t.prototype._next=function(t){this.absoluteTimeout||this.scheduleTimeout(),e.prototype._next.call(this,t)},t.prototype._unsubscribe=function(){this.action=void 0,this.scheduler=null,this.withObservable=null},t}(J);function Re(e,t){return void 0===t&&(t=Q),function(e,t,n){return void 0===n&&(n=Q),function(r){var i=le(e),o=i?+e-n.now():Math.abs(e);return r.lift(new je(o,i,t,n))}}(e,he(new Ne),t)}var $e="undefined"!=typeof Buffer?function(e){return Buffer.from(e,"base64")}:function(e){for(var t=atob(e),n=t.length,r=new Uint8Array(n),i=0;i<n;i++)r[i]=t.charCodeAt(i);return r},Be="undefined"!=typeof Buffer?function(e){return ArrayBuffer.isView(e)?Buffer.from(e.buffer,e.byteOffset,e.byteLength).toString("base64"):Buffer.from(e).toString("base64")}:function(e){return btoa(String.fromCharCode.apply(null,e))};function We(t,n){return new Promise((function(r,i){var o=f(f({},n),{onSubmit:function(e){t.next(void 0),r(e)},onCancel:function(){t.next(void 0),i(new e.AbortError("User cancelled"))}});t.next(o)}))}function Fe(e,t){for(var n=[],r=2;r<arguments.length;r++)n[r-2]=arguments[r];return We(e,{type:"message-alert",title:t,alerts:n,fields:{}})}function Me(e,t,n){return d(this,void 0,void 0,(function(){var r;return h(this,(function(i){switch(i.label){case 0:r=n||"",i.label=1;case 1:return r&&/^[\w-\.]+@([\w-]+\.)+[\w-]{2,10}$/.test(r)?[3,3]:[4,We(e,{type:"email",title:t,alerts:r?[{type:"error",messageCode:"INVALID_EMAIL",message:"Please enter a valid email address",messageParams:{}}]:[],fields:{email:{type:"email",placeholder:"you@somedomain.com"}}})];case 2:return r=i.sent().email,[3,1];case 3:return[2,r]}}))}))}function He(e,t,n){return d(this,void 0,void 0,(function(){var r;return h(this,(function(i){switch(i.label){case 0:return r=[{type:"info",messageCode:"OTP_SENT",message:"A One-Time password has been sent to {email}",messageParams:{email:t}}],n&&r.push(n),[4,We(e,{type:"otp",title:"Enter OTP",alerts:r,fields:{otp:{type:"otp",label:"OTP",placeholder:"Paste OTP here"}}})];case 1:return[2,i.sent().otp]}}))}))}function Ke(e){return d(this,void 0,void 0,(function(){var t,n,r,i,o,s,u,a,c;return h(this,(function(l){switch(l.label){case 0:return[4,e.getCurrentUser()];case 1:if(r=l.sent(),i=r.accessToken,o=r.accessTokenExpiration,s=r.refreshToken,u=r.refreshTokenExpiration,a=r.claims,!i)return[2];if((null!==(t=null==o?void 0:o.getTime())&&void 0!==t?t:1/0)>Date.now())return[2,i];if(!s)throw new Error("Refresh token missing");if((null!==(n=null==u?void 0:u.getTime())&&void 0!==n?n:1/0)<=Date.now())throw new Error("Refresh token has expired");return[4,qe(e.cloud.options.databaseUrl,r)];case 2:return c=l.sent(),[4,e.table("$logins").update(a.sub,{accessToken:c.accessToken,accessTokenExpiration:c.accessTokenExpiration})];case 3:return l.sent(),[2,c.accessToken]}}))}))}function Ve(e,t,n,r,i){return d(this,void 0,void 0,(function(){return h(this,(function(o){switch(o.label){case 0:return t.accessToken&&t.accessTokenExpiration.getTime()>Date.now()?[2,t]:[3,1];case 1:return t.refreshToken&&(!t.refreshTokenExpiration||t.refreshTokenExpiration.getTime()>Date.now())?[4,qe(e,t)]:[3,3];case 2:return[2,o.sent()];case 3:return[4,ze(t,n,r,i)];case 4:return[2,o.sent()]}}))}))}function qe(e,t){return d(this,void 0,void 0,(function(){var n,r,i,o,s,u,a,c,l;return h(this,(function(f){switch(f.label){case 0:if(!t.refreshToken)throw new Error("Cannot refresh token - refresh token is missing.");if(!t.nonExportablePrivateKey)throw new Error("login.nonExportablePrivateKey is missing - cannot sign refresh token without a private key.");return n=Date.now(),r="RSASSA-PKCS1-v1_5",i=new TextEncoder,o=i.encode(t.refreshToken+n),[4,crypto.subtle.sign(r,t.nonExportablePrivateKey,o)];case 1:return s=f.sent(),u=Be(s),a={grant_type:"refresh_token",refresh_token:t.refreshToken,scopes:["ACCESS_DB"],signature:u,signing_algorithm:r,time_stamp:n},[4,fetch(e+"/token",{body:JSON.stringify(a),method:"post",headers:{"Content-Type":"application/json"},mode:"cors"})];case 2:if(200!==(c=f.sent()).status)throw new Error("RefreshToken: Status "+c.status+" from "+e+"/token");return[4,c.json()];case 3:return l=f.sent(),t.accessToken=l.accessToken,t.accessTokenExpiration=l.accessTokenExpiration?new Date(l.accessTokenExpiration):void 0,[2,t]}}))}))}function ze(e,t,n,r){return d(this,void 0,void 0,(function(){var i,o,s,u,a,c,l;return h(this,(function(f){switch(f.label){case 0:return[4,crypto.subtle.generateKey({name:"RSASSA-PKCS1-v1_5",modulusLength:2048,publicExponent:new Uint8Array([1,0,1]),hash:{name:"SHA-256"}},!1,["sign","verify"])];case 1:return i=f.sent(),o=i.privateKey,s=i.publicKey,e.nonExportablePrivateKey=o,[4,crypto.subtle.exportKey("spki",s)];case 2:u=f.sent(),a=function(e){for(var t="-----BEGIN PUBLIC KEY-----\n";e.length>0;)t+=e.substring(0,64)+"\n",e=e.substring(64);return t+="-----END PUBLIC KEY-----"}(Be(u)),e.publicKey=s,f.label=3;case 3:return f.trys.push([3,7,,9]),[4,t({public_key:a,hints:r})];case 4:if("tokens"!==(c=f.sent()).type)throw new Error("Unexpected response type from token endpoint: "+c.type);return e.accessToken=c.accessToken,e.accessTokenExpiration=new Date(c.accessTokenExpiration),e.refreshToken=c.refreshToken,c.refreshTokenExpiration&&(e.refreshTokenExpiration=new Date(c.refreshTokenExpiration)),e.userId=c.claims.sub,e.email=c.claims.email,e.name=c.claims.name,e.claims=c.claims,c.alerts&&c.alerts.length>0?[4,We(n,{type:"message-alert",title:"Authentication Alert",fields:{},alerts:c.alerts})]:[3,6];case 5:f.sent(),f.label=6;case 6:return[2,e];case 7:return l=f.sent(),[4,Fe(n,"Authentication Failed",{type:"error",messageCode:"GENERIC_ERROR",message:"We're having a problem to authenticate rigth now.",messageParams:{}}).catch((function(){}))];case 8:throw f.sent(),l;case 9:return[2]}}))}))}var Ge=new WeakMap,Je=function(){function e(e,t){Ge.set(this,e),Object.assign(this,t)}return e.load=function(t,n){return t.table("$logins").get(n).then((function(r){return new e(t,r||{userId:n,claims:{sub:n},lastLogin:new Date(0)})}))},e.prototype.save=function(){return d(this,void 0,void 0,(function(){return h(this,(function(e){return Ge.get(this).table("$logins").put(this),[2]}))}))},e}(),Ye=function(e){function t(t,n){var r=e.call(this,n||t.status+" "+t.statusText)||this;return r.httpStatus=t.status,r}return l(t,e),Object.defineProperty(t.prototype,"name",{get:function(){return"HttpError"},enumerable:!1,configurable:!0}),t}(Error);function Xe(e){var t=e.cloud.userInteraction;return function(n){var r=n.public_key,i=n.hints;return d(this,void 0,void 0,(function(){var n,o,s,u,a,c,l,f,d,p,v,b;return h(this,(function(h){switch(h.label){case 0:if(!(s=null===(n=e.cloud.options)||void 0===n?void 0:n.databaseUrl))throw new Error("No database URL given.");return"demo"!==(null==i?void 0:i.grant_type)?[3,2]:[4,Me(t,"Enter a demo user email",(null==i?void 0:i.email)||(null==i?void 0:i.userId))];case 1:return u=h.sent(),o={demo_user:u,grant_type:"demo",scopes:["ACCESS_DB"],public_key:r},[3,4];case 2:return[4,Me(t,"Enter email address",null==i?void 0:i.email)];case 3:a=h.sent(),o={email:a,grant_type:"otp",scopes:["ACCESS_DB"],public_key:r},h.label=4;case 4:return[4,fetch(s+"/token",{body:JSON.stringify(o),method:"post",headers:{"Content-Type":"application/json",mode:"cors"}})];case 5:return 200===(c=h.sent()).status?[3,8]:[4,c.text()];case 6:return b=h.sent(),[4,Fe(t,"Token request failed",{type:"error",messageCode:"GENERIC_ERROR",message:b,messageParams:{}}).catch((function(){}))];case 7:throw h.sent(),new Ye(c,b);case 8:return[4,c.json()];case 9:return"tokens"!==(l=h.sent()).type?[3,10]:[2,l];case 10:if("otp"!==o.grant_type)return[3,22];if("otp-sent"!==l.type)throw new Error("Unexpected response from "+s+"/token");return[4,He(t,o.email)];case 11:return f=h.sent(),o.otp=f||"",o.otp_id=l.otp_id,[4,fetch(s+"/token",{body:JSON.stringify(o),method:"post",headers:{"Content-Type":"application/json"},mode:"cors"})];case 12:d=h.sent(),h.label=13;case 13:return 401!==d.status?[3,17]:[4,d.text()];case 14:return p=h.sent(),v=o,[4,He(t,o.email,{type:"error",messageCode:"INVALID_OTP",message:p,messageParams:{}})];case 15:return v.otp=h.sent(),[4,fetch(s+"/token",{body:JSON.stringify(o),method:"post",headers:{"Content-Type":"application/json"},mode:"cors"})];case 16:return d=h.sent(),[3,13];case 17:return 200===d.status?[3,20]:[4,d.text()];case 18:return b=h.sent(),[4,Fe(t,"OTP Authentication Failed",{type:"error",messageCode:"GENERIC_ERROR",message:b,messageParams:{}}).catch((function(){}))];case 19:throw h.sent(),new Ye(d,b);case 20:return[4,d.json()];case 21:return[2,h.sent()];case 22:throw new Error("Unexpected response from "+s+"/token")}}))}))}}function Ze(e,t){return d(this,void 0,void 0,(function(){var n,r=this;return h(this,(function(i){switch(i.label){case 0:return t.userId===e.cloud.currentUserId?[2]:(n=e.table("$logins"),[4,e.transaction("rw",n,(function(e){return d(r,void 0,void 0,(function(){var e;return h(this,(function(r){switch(r.label){case 0:return[4,n.toArray()];case 1:return e=r.sent(),[4,Promise.all(e.filter((function(e){return e.userId!==t.userId&&e.isLoggedIn})).map((function(e){return e.isLoggedIn=!1,n.put(e)})))];case 2:return r.sent(),t.isLoggedIn=!0,t.lastLogin=new Date,[4,t.save()];case 3:return r.sent(),console.debug("Saved new user",t.email),[2]}}))}))}))]);case 1:return i.sent(),[4,new Promise((function(n){if(e.cloud.currentUserId===t.userId)n(null);else var r=e.cloud.currentUser.subscribe((function(e){e.userId===t.userId&&(r.unsubscribe(),n(null))}))}))];case 2:return i.sent(),[2]}}))}))}function Qe(e,t){return d(this,void 0,void 0,(function(){var n;return h(this,(function(r){switch(r.label){case 0:return[4,e.getCurrentUser()];case 1:if(r.sent().isLoggedIn){if(t){if(t.email&&e.cloud.currentUser.value.email!==t.email)throw new Error("Must logout before changing user");if(t.userId&&e.cloud.currentUserId!==t.userId)throw new Error("Must logout before changing user")}return[2]}return n=new Je(e,{claims:{},lastLogin:new Date(0)}),[4,Ve(e.cloud.options.databaseUrl,n,e.cloud.options.fetchTokens||Xe(e),e.cloud.userInteraction,t)];case 2:return r.sent(),[4,n.save()];case 3:return r.sent(),[4,Ze(e,n)];case 4:return r.sent(),[2]}}))}))}var et={userId:"unauthorized",name:"Unauthorized",claims:{sub:"unauthorized"},lastLogin:new Date(0)};try{Object.freeze(et),Object.freeze(et.claims)}catch(e){}var tt={},nt=self.document&&navigator.serviceWorker;nt&&nt.ready.then((function(e){return tt.registration=e})),"undefined"!=typeof self&&"clients"in self&&!self.document&&addEventListener("message",(function(e){var t,n;(null===(n=null===(t=e.data)||void 0===t?void 0:t.type)||void 0===n?void 0:n.startsWith("sw-broadcast-"))&&p([],self.clients.matchAll({includeUncontrolled:!0})).forEach((function(t){var n;return t.id!==(null===(n=e.source)||void 0===n?void 0:n.id)&&t.postMessage(e.data)}))}));var rt=function(){function e(e){this.name=e}return e.prototype.subscribe=function(e){var t=this;if(!nt)return function(){};var n=function(n){var r;(null===(r=n.data)||void 0===r?void 0:r.type)==="sw-broadcast-"+t.name&&e(n.data.message)};return nt.addEventListener("message",n),function(){return nt.removeEventListener("message",n)}},e.prototype.postMessage=function(e){var t,n=this;"object"==typeof self.clients?p([],self.clients.matchAll({includeUncontrolled:!0})).forEach((function(t){return t.postMessage({type:"sw-broadcast-"+n.name,message:e})})):tt.registration&&(null===(t=tt.registration.active)||void 0===t||t.postMessage({type:"sw-broadcast-"+this.name,message:e}))},e}(),it=function(e){function t(t){var n=this,r="undefined"==typeof BroadcastChannel?new rt(t):new BroadcastChannel(t);return(n=e.call(this,(function(e){function n(t){e.next(t.detail)}function i(t){console.debug("BroadcastedAndLocalEvent: onMessageEvent",t),e.next(t.data)}var o;return self.addEventListener("lbc-"+t,n),r instanceof rt?o=r.subscribe((function(t){return e.next(t)})):(console.debug("BroadcastedAndLocalEvent: bc.addEventListener()",t,"bc is a",r),r.addEventListener("message",i)),function(){self.removeEventListener("lbc-"+t,n),r instanceof rt?o():r.removeEventListener("message",i)}}))||this).name=t,n.bc=r,n}return l(t,e),t.prototype.next=function(e){console.debug("BroadcastedAndLocalEvent: bc.postMessage()",f({},e),"bc is a",this.bc),this.bc.postMessage(e);var t=new CustomEvent("lbc-"+this.name,{detail:e});self.dispatchEvent(t)},t}(u),ot=new WeakMap,st={realms:"@realmId",members:"@id",roles:"[realmId+name]",$jobs:"",$syncState:"",$baseRevs:"[tableName+clientRev]",$logins:"claims.sub, lastLogin"},ut=0;function at(e){"vip"in e&&(e=e.vip);var t=ot.get(e.cloud);if(!t){var r=new n({}),i=new it("syncstatechanged-"+e.name);r.id=++ut;var o=!1;t={get name(){return e.name},close:function(){return e.close()},transaction:e.transaction.bind(e),table:e.table.bind(e),get tables(){return e.tables},cloud:e.cloud,get $jobs(){return e.table("$jobs")},get $syncState(){return e.table("$syncState")},get $baseRevs(){return e.table("$baseRevs")},get $logins(){return e.table("$logins")},get realms(){return e.realms},get members(){return e.members},get roles(){return e.roles},get initiallySynced(){return o},localSyncEvent:r,get syncStateChangedEvent(){return i},dx:e};var s={getCurrentUser:function(){return t.$logins.toArray().then((function(e){return e.find((function(e){return e.isLoggedIn}))||et}))},getPersistedSyncState:function(){return t.$syncState.get("syncState")},getSchema:function(){return t.$syncState.get("schema")},getOptions:function(){return t.$syncState.get("options")},setInitiallySynced:function(e){o=e},reconfigure:function(){i=new it("syncstatechanged-"+e.name)}};Object.assign(t,s),ot.set(e.cloud,t)}return t}var ct="undefined"!=typeof InstallTrigger,lt="undefined"!=typeof navigator&&/Safari\//.test(navigator.userAgent)&&!/Chrom(e|ium)\/|Edge\//.test(navigator.userAgent),ft=lt?[].concat(navigator.userAgent.match(/Safari\/(\d*)/))[1]:NaN,dt=lt&&ft<=605||ct;var ht="undefined"!=typeof self&&"clients"in self&&!self.document;function pt(){throw new e.SchemaError("Version increment needed to allow dexie-cloud change tracking")}function vt(e){return function(e){for(var t="",n=0,r=e.length;n<r;n++)t+=mt[e[n]];return t}(Be(e))}function bt(e){return $e(function(e){if("string"!=typeof e)throw new Error("invalid decoder input: "+e);for(var t="",n=0,r=e.length;n<r;n++)t+=yt[e[n]];return t}(e))}for(var yt={"-":"=",0:"A",1:"B",2:"C",3:"D",4:"E",5:"F",6:"G",7:"H",8:"I",9:"J",A:"K",B:"L",C:"M",D:"N",E:"O",F:"P",G:"Q",H:"R",I:"S",J:"T",K:"U",L:"V",M:"W",N:"X",O:"Y",P:"Z",Q:"a",R:"b",S:"c",T:"d",U:"e",V:"f",W:"g",X:"h",Y:"i",Z:"j",_:"k",a:"l",b:"m",c:"n",d:"o",e:"p",f:"q",g:"r",h:"s",i:"t",j:"u",k:"v",l:"w",m:"x",n:"y",o:"z",p:"0",q:"1",r:"2",s:"3",t:"4",u:"5",v:"6",w:"7",x:"8",y:"9",z:"+","|":"/"},mt={},_t=0,gt=Object.keys(yt);_t<gt.length;_t++){var wt=gt[_t];mt[yt[wt]]=wt}var St={}.toString;function kt(e){return St.call(e).slice(8,-1)}function Et(e,t){var n;return"delete"===t.type?t.keys:(null===(n=t.keys)||void 0===n?void 0:n.slice())||t.values.map(e.extractKey)}var xt=/b|c|d|f|g|h|j|k|l|m|n|p|q|r|s|t|v|x|y|z/i;var It=0;function Tt(t){return{stack:"dbcore",name:"idGenerationMiddleware",level:1,create:function(n){return f(f({},n),{table:function(r){var i=n.table(r);function o(n,o){var s=null,u=Et(i.schema.primaryKey,n);return u.forEach((function(a,c){if(void 0===a){var l=n.values[c].realmId||t.cloud.currentUserId,f=l.substr(l.length-3);u[c]=function(e,t){var n=new Uint8Array(18),r=new Uint8Array(n.buffer,0,6),i=Date.now();It>=i?++It:It=i,r[0]=It/1099511627776,r[1]=It/4294967296,r[2]=It/16777216,r[3]=It/65536,r[4]=It/256,r[5]=It;var o=new Uint8Array(n.buffer,6);return crypto.getRandomValues(o),e+vt(new Uint8Array(n.buffer))+(t||"")}(o,f),i.schema.primaryKey.outbound||(s||(s=n.values.slice()),s[c]=e.deepClone(s[c]),e.setByKeyPath(s[c],i.schema.primaryKey.keyPath,u[c]))}else if("string"!=typeof a||!a.startsWith(o))throw new e.ConstraintError('The ID "'+a+'" is not valid for table "'+r+"\". Primary '@' keys requires the key to be prefixed with \""+o+".\n\"If you want to generate IDs programmatically, remove '@' from the schema to get rid of this constraint. Dexie Cloud supports custom IDs as long as they are random and globally unique.")})),i.mutate(f(f({},n),{keys:u,values:s||n.values}))}return f(f({},i),{mutate:function(n){var s,u;if(n.trans.disableChangeTracking)return i.mutate(n);if("add"===n.type||"put"===n.type){var a=null===(s=t.cloud.schema)||void 0===s?void 0:s[r];if(null==a?void 0:a.generatedGlobalId){if((null===(u=t.cloud.options)||void 0===u?void 0:u.databaseUrl)&&!t.initiallySynced){var c=Et(i.schema.primaryKey,n);return i.getMany({keys:c,trans:n.trans,cache:"immutable"}).then((function(e){if(e.length<c.length)throw new Error("Unable to create new objects without an initial sync having been performed.");return i.mutate(n)}))}return o(n,a.idPrefix)}(null==a?void 0:a.markedForSync)&&Et(i.schema.primaryKey,n).forEach((function(t,n){if(!m(t)){var i=Array.isArray(t)?t.map(kt).join(","):kt(t);throw new e.ConstraintError("Invalid primary key type "+i+" for table "+r+". Tables marked for sync has primary keys of type string or Array of string (and optional numbers)")}}))}return i.mutate(n)}})}})}}}function Ct(e){return"$"+e+"_mutations"}function At(e){var t=new Uint8Array(e);return crypto.getRandomValues(t),btoa(String.fromCharCode.apply(null,t))}var Ot=0;function Pt(e,t){return function(n){var r=n.trans[t]||(n.trans[t]={writers:[],readers:[]}),i=r.readers,o=r.writers,s=o.length,u=(s>0?o[s-1].then((function(){return e(n)}),(function(){return e(n)})):e(n)).finally((function(){return i.splice(i.indexOf(u))}));return i.push(u),u}}function Ut(e,t){return function(n){var r,i=n.trans[t]||(n.trans[t]={writers:[],readers:[]}),o=i.readers,s=i.writers,u=(s.length>0?s[s.length-1].then((function(){return e(n)}),(function(){return e(n)})):o.length>0?(r=o,new Promise((function(e){0===r.length&&e([]);var t=r.length,n=new Array(t);r.forEach((function(r,i){return Promise.resolve(r).then((function(e){return n[i]={status:"fulfilled",value:e}}),(function(e){return n[i]={status:"rejected",reason:e}})).then((function(){return--t||e(n)}))}))}))).then((function(){return e(n)})):e(n)).finally((function(){return s.shift()}));return s.push(u),u}}var Dt=!1;function Nt(e){return d(this,void 0,void 0,(function(){var t,n;return h(this,(function(r){switch(r.label){case 0:return r.trys.push([0,5,,6]),[4,navigator.serviceWorker.ready];case 1:return(t=r.sent()).sync?[4,t.sync.register("dexie-cloud:"+e.name)]:[3,3];case 2:return r.sent(),[3,4];case 3:t.active?t.active.postMessage({type:"dexie-cloud-sync",dbName:e.name}):console.error("Dexie Cloud: There's no active service worker. Can this ever happen??"),r.label=4;case 4:return[2];case 5:return n=r.sent(),Dt||(console.debug("Dexie Cloud: Could not register sync event",n),Dt=!0),[3,6];case 6:return[2]}}))}))}var jt=new n(new Set);function Lt(e){var t=e.currentUserObservable,n=e.db;return{stack:"dbcore",name:"MutationTrackingMiddleware",level:1,create:function(e){var r,i=e.schema.tables.filter((function(e){return!/^\$/.test(e.name)}));try{r=new Map(i.map((function(t){return[t.name,e.table("$"+t.name+"_mutations")]})))}catch(e){pt()}return f(f({},e),{transaction:function(r,i){var o;if("readwrite"===i){var s=r.filter((function(e){var t,r;return null===(r=null===(t=n.cloud.schema)||void 0===t?void 0:t[e])||void 0===r?void 0:r.markedForSync})).map((function(e){return Ct(e)}));o=e.transaction(p(p([],r),s),i)}else o=e.transaction(r,i);if("readwrite"===i){o.txid=At(16),o.currentUser=t.value,jt.value.add(o),jt.next(jt.value);var u=function(){o.removeEventListener("complete",a),o.removeEventListener("error",u),o.removeEventListener("abort",u),jt.value.delete(o),jt.next(jt.value)},a=function(){var e;o.mutationsAdded&&(null===(e=n.cloud.options)||void 0===e?void 0:e.databaseUrl)&&(n.cloud.usingServiceWorker?(console.debug("registering sync event"),Nt(n)):n.localSyncEvent.next({})),u()};o.addEventListener("complete",a),o.addEventListener("error",u),o.addEventListener("abort",u)}return o},table:function(t){var n=e.table(t);if(/^\$/.test(t))return t.endsWith("_mutations")?f(f({},n),{mutate:function(e){return"add"!==e.type&&"put"!==e.type||(e.trans.mutationsAdded=!0),n.mutate(e)}}):"$logins"===t?f(f({},n),{mutate:function(e){return console.debug("Mutating $logins table",e),n.mutate(e).then((function(t){return console.debug("Mutating $logins"),e.trans.mutationsAdded=!0,console.debug("$logins mutated"),t})).catch((function(e){return console.debug("Failed mutation $logins",e),Promise.reject(e)}))}}):n;var i=n.schema,o=r.get(t);return function(e){var t="$lock"+ ++Ot;return f(f({},e),{count:Pt(e.count,t),get:Pt(e.get,t),getMany:Pt(e.getMany,t),openCursor:Pt(e.openCursor,t),query:Pt(e.query,t),mutate:Ut(e.mutate,t)})}(f(f({},n),{mutate:function(e){var t,r=e.trans;return r.txid?r.disableChangeTracking?n.mutate(e):(null===(t=r.currentUser)||void 0===t?void 0:t.isLoggedIn)?"deleteRange"===e.type?n.query({query:{range:e.range,index:i.primaryKey},trans:e.trans,values:!1}).then((function(t){return s({type:"delete",keys:t.result,trans:e.trans,criteria:{index:null,range:e.range}})})):s(e):n.mutate(e):n.mutate(e)}}));function s(e){var t=e.trans;t.mutationsAdded=!0;var r=t.txid,i=t.currentUser.userId,s=e.type;return n.mutate(e).then((function(n){var u=n.numFailures,a=n.failures,c="delete"===s?e.keys:n.results,l="values"in e?e.values:[],f="changeSpecs"in e?e.changeSpecs:[];u&&(c=c.filter((function(e,t){return!a[t]})),l=l.filter((function(e,t){return!a[t]})),f=f.filter((function(e,t){return!a[t]})));var d=Date.now(),h="delete"===e.type?{type:"delete",ts:d,keys:c,criteria:e.criteria,txid:r,userId:i}:"add"===e.type?{type:"insert",ts:d,keys:c,txid:r,userId:i,values:l}:e.criteria&&e.changeSpec?{type:"modify",ts:d,keys:c,criteria:e.criteria,changeSpec:e.changeSpec,txid:r,userId:i}:e.changeSpecs?{type:"update",ts:d,keys:c,changeSpecs:f,txid:r,userId:i}:{type:"upsert",ts:d,keys:c,values:l,txid:r,userId:i};return c.length>0||"criteria"in e&&e.criteria?o.mutate({type:"add",trans:t,values:[h]}).then((function(){return n})):n}))}}})}}}function Rt(e,t){return function(n,r){var i=f(f({},st),n),o=t.cloud.schema||(t.cloud.schema={}),s=new Set;return Object.keys(i).forEach((function(e){var t=i[e],n=o[e]||(o[e]={});null!=t?(/^\@/.test(t)&&(i[e]=i[e].substr(1),n.generatedGlobalId=!0,n.idPrefix=function(e,t){for(var n,r,i,o=e[0].toLocaleLowerCase(),s=1,u=e.length;s<u&&o.length<3;++s)(xt.test(e[s])||(n=e[s])>="A"&&n<="Z")&&(o+=e[s].toLowerCase());for(;t.has(o);){if(/\d/g.test(o)){if(!((o=o.substr(0,o.length-1)+(o[o.length-1]+1)).length>3))continue;o=o.substr(0,3)}else if(o.length<3){o+="2";continue}for(var a=1,c=o;t.has(c)&&a<8;)r=o,c=(1&(i=a)?r[0].toUpperCase():r[0].toLowerCase())+(2&i?r[1].toUpperCase():r[1].toLowerCase())+(4&i?r[2].toUpperCase():r[2].toLowerCase()),++a;if(a<8)o=c;else{var l=o.charCodeAt(2)+1&127;o=o.substr(0,2)+String.fromCharCode(l)}}return o}(e,s),s.add(n.idPrefix)),/^\$/.test(e)||(i["$"+e+"_mutations"]="++rev",n.markedForSync=!0),n.deleted&&(n.deleted=!1)):(n.deleted=!0,n.markedForSync=!1,i["$"+e+"_mutations"]=null)})),e.call(this,i,r)}}var $t=At(16);function Bt(e,n,r,i,o){var u=(void 0===o?{}:o).awaitRemoteJob;return d(this,void 0,void 0,(function(){function o(){return d(this,void 0,void 0,(function(){var i,c=this;return h(this,(function(l){switch(l.label){case 0:return[4,e.transaction("rw!",r,(function(){return d(c,void 0,void 0,(function(){var e;return h(this,(function(t){switch(t.label){case 0:return[4,a.get(n)];case 1:return(e=t.sent())?[3,3]:[4,a.add({nodeId:$t,started:new Date,heartbeat:new Date},n)];case 2:return t.sent(),[2,!0];case 3:return e.heartbeat.getTime()<Date.now()-6e4?(console.warn("Latest "+n+" worker seem to have died.\n","The dead job started:",e.started,"\n","Last heart beat was:",e.heartbeat,"\n","We're now taking over!"),[4,a.put({nodeId:$t,started:new Date,heartbeat:new Date},n)]):[3,5];case 4:return t.sent(),[2,!0];case 5:return[2,!1]}}))}))}))];case 1:if(l.sent())return[2,!0];if(!u)return[3,6];l.label=2;case 2:return l.trys.push([2,4,,6]),[4,s(t((function(){return a.get(n)}))).pipe(Re(6e4),we((function(e){return!e}))).toPromise()];case 3:return l.sent(),[2,!1];case 4:if("TimeoutError"!==(i=l.sent()).name)throw i;return[4,o()];case 5:return[2,l.sent()];case 6:return[2,!1]}}))}))}var a,c,l=this;return h(this,(function(t){switch(t.label){case 0:return a=e.table(r),[4,o()];case 1:if(!t.sent())return[3,6];c=setInterval((function(){a.update(n,(function(e){return e.nodeId===$t&&(e.heartbeat=new Date)}))}),1e3),t.label=2;case 2:return t.trys.push([2,,4,6]),[4,i()];case 3:return[2,t.sent()];case 4:return clearInterval(c),[4,e.transaction("rw!",r,(function(){return d(l,void 0,void 0,(function(){var e;return h(this,(function(t){switch(t.label){case 0:return[4,a.get(n)];case 1:return(e=t.sent())&&e.nodeId===$t&&a.delete(n),[2]}}))}))}))];case 5:return t.sent(),[7];case 6:return[2]}}))}))}function Wt(e){return Object.entries(e.cloud.schema||{}).filter((function(e){return e[1].markedForSync})).map((function(t){var n=t[0];return e.table(n)}))}function Ft(e,t,n,r){return d(this,void 0,void 0,(function(){var i,o=this;return h(this,(function(s){switch(s.label){case 0:return t.isLoggedIn&&e.length>0?(i=new Set(r||[]),[4,Promise.all(e.map((function(e){return d(o,void 0,void 0,(function(){var r,o,s,u;return h(this,(function(a){switch(a.label){case 0:return(r=e.core.schema.primaryKey.extractKey)?(o=n[e.name],[4,((null==o?void 0:o.generatedGlobalId)?e.filter((function(e){return!i.has(e.realmId||"")&&m(r(e))})):e.filter((function(e){return!i.has(e.realmId||"")&&(t=r(e),!(n=null==o?void 0:o.idPrefix)||"string"==typeof t&&t.startsWith(n));var t,n}))).toArray()]):[2,{table:e.name,muts:[]}];case 1:return(s=a.sent()).length>0?(u={type:"insert",values:s,keys:s.map(r),userId:t.userId},[2,{table:e.name,muts:[u]}]):[2,{table:e.name,muts:[]}]}}))}))})))]):[3,2];case 1:return[2,s.sent().filter((function(e){return e.muts.length>0}))];case 2:return[2,[]]}}))}))}function Mt(e){var t,n=null===(t=/^\$(.*)_mutations$/.exec(e))||void 0===t?void 0:t[1];if(!n)throw new Error("Given mutationTable "+e+" is not correct");return n}function Ht(e,t,n){var r=void 0===n?{}:n,i=r.since,o=void 0===i?{}:i,s=r.limit,u=void 0===s?1/0:s;return d(this,void 0,void 0,(function(){var t=this;return h(this,(function(n){switch(n.label){case 0:return[4,Promise.all(e.map((function(e){return d(t,void 0,void 0,(function(){var t,n,r,i;return h(this,(function(s){switch(s.label){case 0:return t=Mt(e.name),n=o[t],r=n?e.where("rev").above(n):e,u<1/0&&(r=r.limit(u)),[4,r.toArray()];case 1:return i=s.sent(),[2,{table:t,muts:i}]}}))}))})))];case 1:return[2,n.sent().filter((function(e){return e.muts.length>0}))]}}))}))}var Kt={}.toString;function Vt(e){return Kt.call(e).slice(8,-1)}var qt={replace:function(e){for(var t=Object.keys(e),n=null,r=0,i=t.length;r<i;++r)"$"===t[r][0]&&(n=n||[]).push(t[r]);if(!n)return e;for(var o=f({},e),s=0,u=n;s<u.length;s++){var a=u[s];delete o[a],o["$"+a]=e[a]}return o}};function zt(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var n=e.reduce((function(e,t){return f(f({},e),t)}),e.reduce((function(e,t){return f(f({},t),e)}),{})),r=new WeakMap;return{stringify:function(e,t,r){return JSON.stringify(e,(function(e){var r=this[e],o=i(r);return o?o.replace(r,t,n):r}),r)},parse:function(e,t){var r=null,i=[];return JSON.parse(e,(function(e,o){var s=null==o?void 0:o.$t;if(s){var u=n[s];o=u?u.revive(o,t,n):o}if(o===r){if(i.length>0){o=f({},o);for(var a=0,c=i;a<c.length;a++){var l=c[a];o[l.substr(1)]=o[l],delete o[l]}}return i=[],o}return"$"===e[0]&&"$t"!==e&&(r=this,i.push(e)),o}))}};function i(e){var t=typeof e;switch(typeof e){case"object":case"function":if(null===e)return null;var i=Object.getPrototypeOf(e);if(!i)return qt;var o=r.get(i);if(void 0!==o)return o;var s=Vt(e),u=Object.entries(n).find((function(t){var n,r,i=t[0],o=t[1];return null!==(r=null===(n=null==o?void 0:o.test)||void 0===n?void 0:n.call(o,e,s))&&void 0!==r?r:i===s}));return(o=null==u?void 0:u[1])||(o=Array.isArray(e)?null:"function"==typeof e?n.function||null:qt),r.set(i,o),o;default:return n[t]}}}var Gt={Blob:{test:function(e,t){return"Blob"===t},replace:function(e,t){var n=t.length;return t.push(e),{$t:"Blob",mimeType:e.type,i:n}},revive:function(e,t){var n=e.i,r=e.mimeType;return new Blob([t[n]],{type:r})}}},Jt={number:{replace:function(e){switch(!0){case isNaN(e):return{$t:"number",v:"NaN"};case e===1/0:return{$t:"number",v:"Infinity"};case e===-1/0:return{$t:"number",v:"-Infinity"};default:return e}},revive:function(e){var t=e.v;return Number(t)}}},Yt={bigint:{replace:function(e){return{$t:"bigint",v:""+e}},revive:function(e){return BigInt(e.v)}}},Xt={Date:{replace:function(e){return{$t:"Date",v:isNaN(e.getTime())?"NaN":e.toISOString()}},revive:function(e){var t=e.v;return new Date("NaN"===t?NaN:Date.parse(t))}}},Zt={Set:{replace:function(e){return{$t:"Set",v:Array.from(e.entries())}},revive:function(e){var t=e.v;return new Set(t)}}},Qt={Map:{replace:function(e){return{$t:"Map",v:Array.from(e.entries())}},revive:function(e){var t=e.v;return new Map(t)}}},en="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self?self:"undefined"==typeof global?global:void 0,tn=["Int8Array","Uint8Array","Uint8ClampedArray","Int16Array","Uint16Array","Int32Array","Uint32Array","Float32Array","Float64Array","DataView","BigInt64Array","BigUint64Array"].reduce((function(e,t){var n;return f(f({},e),((n={})[t]={replace:function(e,n,r){return{$t:t,v:r.ArrayBuffer.replace(0===e.byteOffset&&e.byteLength===e.buffer.byteLength?e.buffer:e.buffer.slice(e.byteOffset,e.byteOffset+e.byteLength),n,r).v}},revive:function(e,n,r){var i=e.v,o=en[t];return o&&new o(r.ArrayBuffer.revive({v:i},n,r))}},n))}),{}),nn={ArrayBuffer:{replace:function(e){return{$t:"ArrayBuffer",v:vt(e)}},revive:function(e){var t=bt(e.v);return t.buffer.byteLength===t.byteLength?t.buffer:t.buffer.slice(t.byteOffset,t.byteOffset+t.byteLength)}}},rn=function(e,t){this.buf=e,this.type=t};function on(e){var t=new XMLHttpRequest;if(t.overrideMimeType("text/plain; charset=x-user-defined"),t.open("GET",URL.createObjectURL(e),!1),t.send(),200!==t.status&&0!==t.status)throw new Error("Bad Blob access: "+t.status);return t.responseText}function sn(e){for(var t=new Uint8Array(e.length),n=0;n<e.length;++n)t[n]=e.charCodeAt(n);return t.buffer}var un={Blob:{test:function(e,t){return"Blob"===t||e instanceof rn},replace:function(e){return{$t:"Blob",v:Be(e instanceof rn?e.buf:sn(on(e))),type:e.type}},revive:function(e){var t=e.type,n=e.v,r=$e(n);return void 0!==typeof Blob?new Blob([r]):new rn(r.buffer,t)}}},an=f(f(f(f(f(f(f(f({},Jt),Yt),Xt),Zt),Qt),tn),nn),un);function cn(e){return new Promise((function(t,n){var r=new FileReader;r.onabort=function(e){return n(new Error("file read aborted"))},r.onerror=function(e){return n(e.target.error)},r.onload=function(e){return t(e.target.result)},r.readAsText(e)}))}function ln(e){return new Promise((function(t,n){var r=new FileReader;r.onabort=function(e){return n(new Error("file read aborted"))},r.onerror=function(e){return n(e.target.error)},r.onload=function(e){return t(e.target.result)},r.readAsArrayBuffer(e)}))}var fn={undefined:{replace:function(){},revive:function(){}}},dn="undefined"!=typeof BigInt,hn=function(){function e(e){this.v=e}return e.compare=function(e,t){if("bigint"==typeof e)return e<t?-1:e>t?1:0;if("bigint"==typeof t)throw new TypeError("Can't compare real bigint with FakeBigInt");return Number(e)<Number(t)?-1:Number(e)>Number(t)?1:0},e.prototype.toString=function(){return this.v},e}(),pn=f(f({},fn),dn?{}:{bigint:{test:function(e){return e instanceof hn},replace:function(e){return f({$t:"bigint"},e)},revive:function(e){var t=e.v;return new hn(t)}}}),vn=zt(an,pn),bn=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var n=zt.apply(void 0,p([an,Gt],e));return{toBinary:function(e){var t=this.stringify(e),n=t[0],r=t[1],i=new ArrayBuffer(4);return new DataView(i).setUint32(0,n.size),new Blob([i,n,r])},stringify:function(e){var t=[],r=n.stringify(e,t);return[new Blob(t.map((function(e){var t=new ArrayBuffer(4);return new DataView(t).setUint32(0,"byteLength"in e?e.byteLength:e.size),new Blob([t,e])}))),r]},parse:function(e,t){return d(this,void 0,void 0,(function(){var r,i,o,s,u,a;return h(this,(function(c){switch(c.label){case 0:return r=0,i=[],[4,ln(t)];case 1:for(o=c.sent(),s=new DataView(o);r<o.byteLength;)u=s.getUint32(r),r+=4,a=o.slice(r,r+u),r+=u,i.push(a);return[2,n.parse(e,i)]}}))}))},fromBinary:function(e){return d(this,void 0,void 0,(function(){var t,n,r,i;return h(this,(function(o){switch(o.label){case 0:return n=DataView.bind,[4,ln(e.slice(0,4))];case 1:return t=(new(n.apply(DataView,[void 0,o.sent()]))).getUint32(0),r=e.slice(4,t+4),[4,cn(e.slice(t+4))];case 2:return i=o.sent(),[4,this.parse(i,r)];case 3:return[2,o.sent()]}}))}))}}}(pn);function yn(e,t,n,r,i,o){return d(this,void 0,void 0,(function(){var s,u,a,c,l,f,d;return h(this,(function(h){switch(h.label){case 0:return s={Accept:"application/json, application/x-bison, application/x-bison-stream","Content-Type":"application/tson"},[4,Ke(r)];case 1:return(u=h.sent())&&(s.Authorization="Bearer "+u),a={dbID:null==t?void 0:t.remoteDbId,schema:o||{},lastPull:t?{serverRevision:t.serverRevision,realms:t.realms,inviteRealms:t.inviteRealms}:void 0,baseRevs:n,changes:e},console.debug("Sync request",a),r.syncStateChangedEvent.next({phase:"pushing"}),[4,fetch(i+"/sync",{method:"post",headers:s,body:vn.stringify(a)})];case 2:if(c=h.sent(),r.syncStateChangedEvent.next({phase:"pulling"}),!c.ok)throw new Ye(c);switch(c.headers.get("content-type")){case"application/x-bison":return[3,3];case"application/x-bison-stream":case"application/json":return[3,5]}return[3,5];case 3:return f=(l=bn).fromBinary,[4,c.blob()];case 4:return[2,f.apply(l,[h.sent()])];case 5:return[4,c.text()];case 6:return d=h.sent(),[2,vn.parse(d)]}}))}))}function mn(e,t,n){return d(this,void 0,void 0,(function(){var r,i,o,s;return h(this,(function(u){switch(u.label){case 0:r=new Set(n||[]),i=0,o=e,u.label=1;case 1:return i<o.length?"members"!==(s=o[i]).name?[3,3]:[4,s.toCollection().modify((function(e){r.has(e.realmId)||e.userId!==et.userId||(e.userId=t.userId)}))]:[3,9];case 2:return u.sent(),[3,8];case 3:return"roles"!==s.name?[3,4]:[3,8];case 4:return"realms"!==s.name?[3,6]:[4,s.toCollection().modify((function(e){(r.has(e.realmId)||e.owner)&&e.owner!==et.userId||(e.owner=t.userId)}))];case 5:return u.sent(),[3,8];case 6:return[4,s.toCollection().modify((function(e){e.realmId&&r.has(e.realmId)||(e.owner&&e.owner!==et.userId||(e.owner=t.userId),e.realmId&&e.realmId!==et.userId||(e.realmId=t.userId))}))];case 7:u.sent(),u.label=8;case 8:return i++,[3,1];case 9:return[2]}}))}))}function _n(t,n,r){return d(this,void 0,void 0,(function(){var i,o,s;return h(this,(function(u){switch(u.label){case 0:return[4,t.bulkGet(n)];case 1:return i=u.sent(),o=[],s=[],n.forEach((function(n,u){var a=i[u];if(a){for(var c=0,l=Object.entries(r[u]);c<l.length;c++){var f=l[c],d=f[0],h=f[1];if(d===t.schema.primKey.keyPath)throw new Error("Cannot change primary key");e.setByKeyPath(a,d,h)}o.push(n),s.push(a)}})),[4,null==t.schema.primKey.keyPath?t.bulkPut(s,o):t.bulkPut(s)];case 2:return u.sent(),[2]}}))}))}function gn(t){if(null==t?void 0:t.cancelled)throw new e.AbortError("Operation was cancelled")}var wn=navigator.onLine;self.addEventListener("online",(function(){return wn=!0})),self.addEventListener("offline",(function(){return wn=!1}));var Sn=new WeakSet;function kn(e,t,n,r){var i=this;return En.apply(this,arguments).then((function(){e.syncStateChangedEvent.next({phase:"in-sync"})})).catch((function(o){return d(i,void 0,void 0,(function(){return h(this,(function(i){switch(i.label){case 0:return console.debug("Error from _sync",{isOnline:wn,syncOptions:r,error:o}),wn&&(null==r?void 0:r.retryImmediatelyOnFetchError)&&"TypeError"===(null==o?void 0:o.name)&&/fetch/.test(null==o?void 0:o.message)?(e.syncStateChangedEvent.next({phase:"error",error:o}),[4,new Promise((function(e){return setTimeout(e,500)}))]):[3,3];case 1:return i.sent(),[4,kn(e,t,n,f(f({},r),{retryImmediatelyOnFetchError:!1}))];case 2:return[2,i.sent()];case 3:return[4,e.$syncState.update("syncState",{timestamp:new Date,error:""+o})];case 4:return i.sent(),e.syncStateChangedEvent.next({phase:wn?"error":"offline",error:o}),[2,Promise.reject(o)]}}))}))}))}function En(e,t,n,r){var i=void 0===r?{isInitialSync:!1}:r,o=i.isInitialSync,s=i.cancelToken,u=i.justCheckIfNeeded;return d(this,void 0,void 0,(function(){var r,i,a,c,l,f,p,v,m,_,g,S,k,E,x,I=this;return h(this,(function(T){switch(T.label){case 0:if(u||console.debug("SYNC STARTED",{isInitialSync:o}),!(null===(r=e.cloud.options)||void 0===r?void 0:r.databaseUrl))throw new Error("Internal error: sync must not be called when no databaseUrl is configured");return i=t.databaseUrl,[4,e.getCurrentUser()];case 1:return a=T.sent(),c=a.isLoggedIn?Wt(e):[],l=c.map((function(t){return e.table(Ct(t.name))})),[4,e.getPersistedSyncState()];case 2:return f=T.sent(),p=!o&&a.isLoggedIn?function(e,t){var n=(null==t?void 0:t.syncedTables)||[];return Wt(e).filter((function(e){return!n.includes(e.name)}))}(e,f):[],gn(s),(v=p.length>0)?u?[2,!0]:(console.debug("sync doSyncify is true"),[4,e.transaction("rw",p,(function(e){return d(I,void 0,void 0,(function(){return h(this,(function(t){switch(t.label){case 0:return e.idbtrans.disableChangeTracking=!0,e.idbtrans.disableAccessControl=!0,[4,mn(p,a,null==f?void 0:f.realms)];case 1:return t.sent(),[2]}}))}))}))]):[3,4];case 3:T.sent(),gn(s),T.label=4;case 4:return[4,e.transaction("r",e.tables,(function(){return d(I,void 0,void 0,(function(){var t,r,i,o;return h(this,(function(u){switch(u.label){case 0:return[4,e.getPersistedSyncState()];case 1:return t=u.sent(),[4,e.$baseRevs.toArray()];case 2:return r=u.sent(),[4,Ht(l)];case 3:return i=u.sent(),gn(s),v?[4,Ft(p,a,n,null==f?void 0:f.realms)]:[3,5];case 4:return o=u.sent(),gn(s),[2,[i=i.concat(o),t,r]];case 5:return[2,[i,t,r]]}}))}))}))];case 5:return m=T.sent(),_=m[0],g=m[1],S=m[2],u?(k=_.some((function(e){return e.muts.some((function(e){return e.keys.length>0}))})),console.debug("Sync is needed:",k),[2,k]):(E=In(_,null==g?void 0:g.latestRevisions),gn(s),[4,yn(_,g,S,e,i,n)]);case 6:return x=T.sent(),console.debug("Sync response",x),[4,e.transaction("rw",e.tables,(function(t){return d(I,void 0,void 0,(function(){var r,i,o,s,u,a,f,d,v,m;return h(this,(function(_){switch(_.label){case 0:for(t.idbtrans.disableChangeTracking=!0,t.idbtrans.disableAccessControl=!0,r=0,i=Object.keys(n);r<i.length;r++)o=i[r],x.schema[o]&&(n[o]=x.schema[o]);return[4,e.$syncState.put(n,"schema")];case 1:return _.sent(),[4,Ht(l,0,{since:E})];case 2:s=_.sent(),u=function(t){var n,r;return h(this,(function(i){switch(i.label){case 0:return n=Mt(t.name),s.some((function(e){return e.table===n&&e.muts.length>0}))?[3,2]:[4,Promise.all([t.clear(),e.$baseRevs.where({tableName:n}).delete()])];case 1:return i.sent(),[3,5];case 2:return E[t.name]?(r=E[t.name]||0,[4,Promise.all([t.where("rev").belowOrEqual(r).delete(),e.$baseRevs.where(":id").between([n,-1/0],[n,r+1],!0,!0).reverse().offset(1).delete()])]):[3,4];case 3:return i.sent(),[3,5];case 4:i.label=5;case 5:return[2]}}))},a=0,f=l,_.label=3;case 3:return a<f.length?(d=f[a],[5,u(d)]):[3,6];case 4:_.sent(),_.label=5;case 5:return a++,[3,3];case 6:return In(s,E),[4,e.$baseRevs.bulkPut(Object.keys(n).filter((function(e){return n[e].markedForSync})).map((function(e){return{tableName:e,clientRev:(E[e]||0)+1,serverRev:x.serverRevision}})))];case 7:return _.sent(),[4,e.getPersistedSyncState()];case 8:return v=_.sent(),[4,xn(e,x,v)];case 9:return _.sent(),(m=v||{syncedTables:[],latestRevisions:{},realms:[],inviteRealms:[]}).syncedTables=c.map((function(e){return e.name})).concat(p.map((function(e){return e.name}))),m.latestRevisions=E,m.remoteDbId=x.dbId,m.initiallySynced=!0,m.realms=x.realms,m.inviteRealms=x.inviteRealms,m.serverRevision=x.serverRevision,m.timestamp=new Date,delete m.error,[4,Tn(function(e,t){var n={};w(n,e);var r={};return w(r,t),function(e,t){for(var n,r,i,o=0,s=Object.entries(t);o<s.length;o++)for(var u=s[o],a=u[0],c=u[1],l=0,f=Object.entries(c);l<f.length;l++){var d=f[l],h=d[0],p=d[1];switch(p.type){case"ups":if(v=null===(n=e[a])||void 0===n?void 0:n[h])switch(v.type){case"ups":delete e[a][h];break;case"del":break;case"upd":delete e[a][h]}break;case"del":null===(r=e[a])||void 0===r||delete r[h];break;case"upd":var v;if(v=null===(i=e[a])||void 0===i?void 0:i[h])switch(v.type){case"ups":for(var y=0,m=Object.entries(p.mod);y<m.length;y++){var _=m[y],g=_[0],w=_[1];b(v.val,g,w)}break;case"del":break;case"upd":for(var S=0,k=Object.keys(p.mod);S<k.length;S++)g=k[S],delete v.mod[g]}}}}(n,r),function(e){for(var t=y(16),n={},r=0,i=Object.entries(e);r<i.length;r++)for(var o=i[r],s=o[0],u=o[1],a=0,c=Object.entries(u);a<c.length;a++){var l=c[a],f=l[0],d=l[1],h=n[s]||(n[s]={});(h[d.type]||(h[d.type]=[])).push(Object.assign({key:f},d))}for(var p=[],v=0,b=Object.entries(n);v<b.length;v++){for(var m=b[v],_=(s=m[0],u=m[1],{table:s,muts:[]}),g=0,w=Object.entries(u);g<w.length;g++){var S=w[g],k=S[0],E=S[1];switch(k){case"ups":d={type:"upsert",keys:E.map((function(e){return e.key})),values:E.map((function(e){return e.val})),txid:t},_.muts.push(d);break;case"upd":d={type:"update",keys:E.map((function(e){return e.key})),changeSpecs:E.map((function(e){return e.mod})),txid:t},_.muts.push(d);break;case"del":d={type:"delete",keys:E.map((function(e){return e.key})),txid:t},_.muts.push(d)}}p.push(_)}return p}(n)}(x.changes,s),e)];case 10:return _.sent(),e.$syncState.put(m,"syncState"),[2,0===s.length]}}))}))}))];case 7:return T.sent()?[3,9]:(console.debug("MORE SYNC NEEDED. Go for it again!"),[4,En(e,t,n,{isInitialSync:o,cancelToken:s})]);case 8:return[2,T.sent()];case 9:return console.debug("SYNC DONE",{isInitialSync:o}),[2,!1]}}))}))}function xn(e,t,n){return d(this,void 0,void 0,(function(){var r,i,o,s,u,a,c,l,f,d,v;return h(this,(function(h){switch(h.label){case 0:for(r=[],i=n?n.realms.concat(n.inviteRealms):[],o=new Set(p(p([],t.realms),t.inviteRealms)),s=0,u=i;s<u.length;s++)a=u[s],o.has(a)||r.push(a);if(!(r.length>0))return[3,6];c=new Set(r),l=Wt(e),f=0,d=l,h.label=1;case 1:return f<d.length?(v=d[f]).schema.indexes.some((function(e){return"realmId"===e.keyPath||Array.isArray(e.keyPath)&&"realmId"===e.keyPath[0]}))?[4,v.where("realmId").anyOf(r).delete()]:[3,3]:[3,6];case 2:return h.sent(),[3,5];case 3:return[4,v.filter((function(e){return!!(null==e?void 0:e.realmId)&&c.has(e.realmId)})).delete()];case 4:h.sent(),h.label=5;case 5:return f++,[3,1];case 6:return[2]}}))}))}function In(e,t){void 0===t&&(t={});for(var n=0,r=e;n<r.length;n++){var i=r[n],o=i.table,s=i.muts,u=s.length>0&&s[s.length-1].rev||0;t[o]=u}return t}function Tn(t,n){return d(this,void 0,void 0,(function(){var r,i,o,s,u,a;return h(this,(function(c){switch(c.label){case 0:console.debug("Applying server changes",t,e.currentTransaction),r=function(t,r){var i,o,s,u,a,c;return h(this,(function(l){switch(l.label){case 0:i=n.table(t),o=i.core.schema.primaryKey,s=function(t){return h(this,(function(n){switch(n.label){case 0:switch(t.type){case"insert":return[3,1];case"upsert":return[3,6];case"modify":return[3,11];case"update":return[3,16];case"delete":return[3,18]}return[3,20];case 1:return o.outbound?[4,i.bulkAdd(t.values,t.keys)]:[3,3];case 2:return n.sent(),[3,5];case 3:return t.keys.forEach((function(n,r){e.setByKeyPath(t.values[r],o.keyPath,n)})),[4,i.bulkAdd(t.values)];case 4:n.sent(),n.label=5;case 5:return[3,20];case 6:return o.outbound?[4,i.bulkPut(t.values,t.keys)]:[3,8];case 7:return n.sent(),[3,10];case 8:return t.keys.forEach((function(n,r){e.setByKeyPath(t.values[r],o.keyPath,n)})),[4,i.bulkPut(t.values)];case 9:n.sent(),n.label=10;case 10:return[3,20];case 11:return 1!==t.keys.length?[3,13]:[4,i.update(t.keys[0],t.changeSpec)];case 12:return n.sent(),[3,15];case 13:return[4,i.where(":id").anyOf(t.keys).modify(t.changeSpec)];case 14:n.sent(),n.label=15;case 15:return[3,20];case 16:return[4,_n(i,t.keys,t.changeSpecs)];case 17:return n.sent(),[3,20];case 18:return[4,i.bulkDelete(t.keys)];case 19:return n.sent(),[3,20];case 20:return[2]}}))},u=0,a=r,l.label=1;case 1:return u<a.length?(c=a[u],[5,s(c)]):[3,4];case 2:l.sent(),l.label=3;case 3:return u++,[3,1];case 4:return[2]}}))},i=0,o=t,c.label=1;case 1:return i<o.length?(s=o[i],u=s.table,a=s.muts,[5,r(u,a)]):[3,4];case 2:c.sent(),c.label=3;case 3:return i++,[3,1];case 4:return[2]}}))}))}function Cn(e,t,n){return d(this,void 0,void 0,(function(){var r=this;return h(this,(function(i){switch(i.label){case 0:return console.debug("Performing initial sync"),[4,Bt(e,"initialSync","$jobs",(function(){return d(r,void 0,void 0,(function(){var r;return h(this,(function(i){switch(i.label){case 0:return[4,e.getPersistedSyncState()];case 1:return(null==(r=i.sent())?void 0:r.initiallySynced)?[3,3]:[4,kn(e,t,n,{isInitialSync:!0})];case 2:i.sent(),i.label=3;case 3:return[2]}}))}))}),{awaitRemoteJob:!0})];case 1:return i.sent(),console.debug("Done initial sync"),[2]}}))}))}var An=new n(!0),On="undefined"!=typeof document?r(document,"visibilitychange"):i({}),Pn=On.pipe(we((function(){return"hidden"===document.visibilityState}))),Un=On.pipe(we((function(){return"hidden"===document.visibilityState}))),Dn="undefined"!=typeof window?o(Un,r(window,"mousemove"),r(window,"keydown"),r(window,"wheel"),r(window,"touchmove")):i({});"undefined"!=typeof document&&o(i(!0),Pn,Dn).pipe(ue((function(){return"visible"===document.visibilityState})),Pe((function(e){An.value!==e&&An.next(e)})),Te((function(e){return e?i(!0).pipe(be(3e5),Pe((function(){return An.next(!1)}))):i(!1)}))).subscribe((function(){}));var Nn=function(e){function t(){var t=e.apply(this,arguments)||this;return t.name="TokenExpiredError",t}return l(t,e),t}(Error),jn=function(e){function t(t,n,r,i){return e.call(this,(function(e){return new Rn(t,n,r,i,e)}))||this}return l(t,e),t}(u),Ln=0,Rn=function(e){function t(t,n,r,i,o){var s=e.call(this,(function(){return s.teardown()}))||this;return s.id=++Ln,console.debug("New WebSocket Connection",s.id,r?"authorized":"unauthorized"),s.databaseUrl=t,s.rev=n,s.token=r,s.tokenExpiration=i,s.subscriber=o,s.lastUserActivity=new Date,s.connect(),s}return l(t,e),t.prototype.teardown=function(){this.disconnect(),console.debug("Teardown WebSocket Connection",this.id)},t.prototype.disconnect=function(){if(this.pinger&&(clearInterval(this.pinger),this.pinger=null),this.ws)try{this.ws.close()}catch(e){}this.ws=null},t.prototype.reconnect=function(){this.disconnect(),this.connect()},t.prototype.connect=function(){return d(this,void 0,void 0,(function(){var e,t,n,r=this;return h(this,(function(i){switch(i.label){case 0:if(this.lastServerActivity=new Date,this.pauseUntil&&this.pauseUntil>new Date)return[2];if(this.ws)throw new Error("Called connect() when a connection is already open");if(!this.databaseUrl)throw new Error("Cannot connect without a database URL");if(this.closed)return[2];if(this.tokenExpiration&&this.tokenExpiration<new Date)return this.subscriber.error(new Nn),[2];if(this.pinger=setInterval((function(){return d(r,void 0,void 0,(function(){var e=this;return h(this,(function(t){if(this.closed)return console.debug("pinger check",this.id,"CLOSED."),this.teardown(),[2];if(console.debug("pinger check",this.id,"user is active"),this.ws)try{this.ws.send(JSON.stringify({type:"ping"})),setTimeout((function(){if(console.debug("pinger setTimeout",e.id,e.pinger?"alive":"dead"),e.pinger)return e.closed?(console.debug("pinger setTimeout",e.id,"subscription is closed"),void e.teardown()):void(e.lastServerActivity<new Date(Date.now()-2e4)?(console.debug("pinger: server is inactive"),console.debug("pinger reconnecting"),e.reconnect()):console.debug("pinger: server still active"))}),2e4)}catch(e){console.debug("pinger catch error",this.id,"reconnecting"),this.reconnect()}else console.debug("pinger",this.id,"reconnecting"),this.reconnect();return[2]}))}))}),3e4),(e=new URL(this.databaseUrl)).protocol="http:"===e.protocol?"ws":"wss",t=new URLSearchParams,this.subscriber.closed)return[2];t.set("rev",this.rev),this.token&&t.set("token",this.token),console.debug("dexie-cloud WebSocket create"),(n=this.ws=new WebSocket(e+"/revision?"+t)).onclose=function(e){r.pinger&&(console.debug("dexie-cloud WebSocket onclosed"),r.reconnect())},n.onmessage=function(e){if(r.pinger){console.debug("dexie-cloud WebSocket onmessage",e.data),r.lastServerActivity=new Date;try{var t=JSON.parse(e.data);if("error"===t.type)throw new Error("dexie-cloud WebSocket Error "+t.error);"rev"===t.type&&(r.rev=t.rev),"pong"!==t.type&&r.subscriber.next(t)}catch(e){r.disconnect(),r.pauseUntil=new Date(Date.now()+6e4)}}},i.label=1;case 1:return i.trys.push([1,3,,4]),[4,new Promise((function(e,t){n.onopen=function(t){console.debug("dexie-cloud WebSocket onopen"),e(null)},n.onerror=function(e){var n=e.error||new Error("WebSocket Error");console.debug("dexie-cloud WebSocket error",n),r.disconnect(),t(n)}}))];case 2:return i.sent(),[3,4];case 3:return i.sent(),this.pauseUntil=new Date(Date.now()+6e4),[3,4];case 4:return[2]}}))}))},t}(a);function $n(e){e.cloud.usingServiceWorker?Nt(e):e.localSyncEvent.next({})}function Bn(e){return d(this,void 0,void 0,(function(){var t,n;return h(this,(function(r){switch(r.label){case 0:return(null===(t=e.cloud.options)||void 0===t?void 0:t.databaseUrl)&&e.cloud.schema?[4,kn(e,e.cloud.options,e.cloud.schema,{justCheckIfNeeded:!0})]:[3,2];case 1:return n=r.sent(),[3,3];case 2:n=!1,r.label=3;case 3:return[2,n]}}))}))}function Wn(e,t,n){var r=null,i={cancelled:!1};function o(r){void 0===r&&(r=1),function(e,t,n,r){return d(this,void 0,void 0,(function(){var i;return h(this,(function(o){switch(o.label){case 0:if(Sn.has(e))return[2];Sn.add(e),o.label=1;case 1:return o.trys.push([1,7,,8]),e.cloud.usingServiceWorker?ht?[4,kn(e,t,n,r)]:[3,3]:[3,4];case 2:o.sent(),o.label=3;case 3:return[3,6];case 4:return[4,Bt(e,"currentSyncWorker","$jobs",(function(){return kn(e,t,n,r)}))];case 5:o.sent(),o.label=6;case 6:return Sn.delete(e),console.debug("Done sync"),[3,8];case 7:throw i=o.sent(),Sn.delete(e),console.error("Failed to sync client changes",i),i;case 8:return[2]}}))}))}(e,t,n,{cancelToken:i,retryImmediatelyOnFetchError:!0}).catch((function(e){console.error("error in syncIfPossible()",e),i.cancelled?s():r<3&&setTimeout((function(){return o(r+1)}),6e4*[0,5,15][r])}))}var s=function(){console.debug("Stopping LocalSyncWorker"),i.cancelled=!0,r&&r.unsubscribe()};return{start:function(){console.debug("Starting LocalSyncWorker",e.localSyncEvent.id),r=e.localSyncEvent.subscribe((function(){try{o()}catch(e){console.error("What-the....",e)}}))},stop:s}}function Fn(e,t){if(e&&t&&t.unsyncedTables)for(var n=0,r=t.unsyncedTables;n<r.length;n++){var i=r[n];e[i]&&(e[i].markedForSync=!1)}}var Mn,Hn,Kn,Vn,qn={},zn=[],Gn=/acit|ex(?:s|g|n|p|$)|rph|grid|ows|mnc|ntw|ine[ch]|zoo|^ord|itera/i;function Jn(e,t){for(var n in t)e[n]=t[n];return e}function Yn(e){var t=e.parentNode;t&&t.removeChild(e)}function Xn(e,t,n){var r,i,o,s=arguments,u={};for(o in t)"key"==o?r=t[o]:"ref"==o?i=t[o]:u[o]=t[o];if(arguments.length>3)for(n=[n],o=3;o<arguments.length;o++)n.push(s[o]);if(null!=n&&(u.children=n),"function"==typeof e&&null!=e.defaultProps)for(o in e.defaultProps)void 0===u[o]&&(u[o]=e.defaultProps[o]);return Zn(e,u,r,i,null)}function Zn(e,t,n,r,i){var o={type:e,props:t,key:n,ref:r,__k:null,__:null,__b:0,__e:null,__d:void 0,__c:null,__h:null,constructor:void 0,__v:null==i?++Mn.__v:i};return null!=Mn.vnode&&Mn.vnode(o),o}function Qn(e){return e.children}function er(e,t){this.props=e,this.context=t}function tr(e,t){if(null==t)return e.__?tr(e.__,e.__.__k.indexOf(e)+1):null;for(var n;t<e.__k.length;t++)if(null!=(n=e.__k[t])&&null!=n.__e)return n.__e;return"function"==typeof e.type?tr(e):null}function nr(e){var t,n;if(null!=(e=e.__)&&null!=e.__c){for(e.__e=e.__c.base=null,t=0;t<e.__k.length;t++)if(null!=(n=e.__k[t])&&null!=n.__e){e.__e=e.__c.base=n.__e;break}return nr(e)}}function rr(e){(!e.__d&&(e.__d=!0)&&Hn.push(e)&&!ir.__r++||Vn!==Mn.debounceRendering)&&((Vn=Mn.debounceRendering)||Kn)(ir)}function ir(){for(var e;ir.__r=Hn.length;)e=Hn.sort((function(e,t){return e.__v.__b-t.__v.__b})),Hn=[],e.some((function(e){var t,n,r,i,o,s;e.__d&&(o=(i=(t=e).__v).__e,(s=t.__P)&&(n=[],(r=Jn({},i)).__v=i.__v+1,dr(s,i,r,t.__n,void 0!==s.ownerSVGElement,null!=i.__h?[o]:null,n,null==o?tr(i):o,i.__h),hr(n,i),i.__e!=o&&nr(i)))}))}function or(e,t,n,r,i,o,s,u,a,c){var l,f,d,h,p,v,b,y=r&&r.__k||zn,m=y.length;for(n.__k=[],l=0;l<t.length;l++)if(null!=(h=n.__k[l]=null==(h=t[l])||"boolean"==typeof h?null:"string"==typeof h||"number"==typeof h||"bigint"==typeof h?Zn(null,h,null,null,h):Array.isArray(h)?Zn(Qn,{children:h},null,null,null):h.__b>0?Zn(h.type,h.props,h.key,null,h.__v):h)){if(h.__=n,h.__b=n.__b+1,null===(d=y[l])||d&&h.key==d.key&&h.type===d.type)y[l]=void 0;else for(f=0;f<m;f++){if((d=y[f])&&h.key==d.key&&h.type===d.type){y[f]=void 0;break}d=null}dr(e,h,d=d||qn,i,o,s,u,a,c),p=h.__e,(f=h.ref)&&d.ref!=f&&(b||(b=[]),d.ref&&b.push(d.ref,null,h),b.push(f,h.__c||p,h)),null!=p?(null==v&&(v=p),"function"==typeof h.type&&null!=h.__k&&h.__k===d.__k?h.__d=a=sr(h,a,e):a=ur(e,h,d,y,p,a),c||"option"!==n.type?"function"==typeof n.type&&(n.__d=a):e.value=""):a&&d.__e==a&&a.parentNode!=e&&(a=tr(d))}for(n.__e=v,l=m;l--;)null!=y[l]&&("function"==typeof n.type&&null!=y[l].__e&&y[l].__e==n.__d&&(n.__d=tr(r,l+1)),br(y[l],y[l]));if(b)for(l=0;l<b.length;l++)vr(b[l],b[++l],b[++l])}function sr(e,t,n){var r,i;for(r=0;r<e.__k.length;r++)(i=e.__k[r])&&(i.__=e,t="function"==typeof i.type?sr(i,t,n):ur(n,i,i,e.__k,i.__e,t));return t}function ur(e,t,n,r,i,o){var s,u,a;if(void 0!==t.__d)s=t.__d,t.__d=void 0;else if(null==n||i!=o||null==i.parentNode)e:if(null==o||o.parentNode!==e)e.appendChild(i),s=null;else{for(u=o,a=0;(u=u.nextSibling)&&a<r.length;a+=2)if(u==i)break e;e.insertBefore(i,o),s=o}return void 0!==s?s:i.nextSibling}function ar(e,t,n){"-"===t[0]?e.setProperty(t,n):e[t]=null==n?"":"number"!=typeof n||Gn.test(t)?n:n+"px"}function cr(e,t,n,r,i){var o;e:if("style"===t)if("string"==typeof n)e.style.cssText=n;else{if("string"==typeof r&&(e.style.cssText=r=""),r)for(t in r)n&&t in n||ar(e.style,t,"");if(n)for(t in n)r&&n[t]===r[t]||ar(e.style,t,n[t])}else if("o"===t[0]&&"n"===t[1])o=t!==(t=t.replace(/Capture$/,"")),t=t.toLowerCase()in e?t.toLowerCase().slice(2):t.slice(2),e.l||(e.l={}),e.l[t+o]=n,n?r||e.addEventListener(t,o?fr:lr,o):e.removeEventListener(t,o?fr:lr,o);else if("dangerouslySetInnerHTML"!==t){if(i)t=t.replace(/xlink[H:h]/,"h").replace(/sName$/,"s");else if("href"!==t&&"list"!==t&&"form"!==t&&"tabIndex"!==t&&"download"!==t&&t in e)try{e[t]=null==n?"":n;break e}catch(e){}"function"==typeof n||(null!=n&&(!1!==n||"a"===t[0]&&"r"===t[1])?e.setAttribute(t,n):e.removeAttribute(t))}}function lr(e){this.l[e.type+!1](Mn.event?Mn.event(e):e)}function fr(e){this.l[e.type+!0](Mn.event?Mn.event(e):e)}function dr(e,t,n,r,i,o,s,u,a){var c,l,f,d,h,p,v,b,y,m,_,g=t.type;if(void 0!==t.constructor)return null;null!=n.__h&&(a=n.__h,u=t.__e=n.__e,t.__h=null,o=[u]),(c=Mn.__b)&&c(t);try{e:if("function"==typeof g){if(b=t.props,y=(c=g.contextType)&&r[c.__c],m=c?y?y.props.value:c.__:r,n.__c?v=(l=t.__c=n.__c).__=l.__E:("prototype"in g&&g.prototype.render?t.__c=l=new g(b,m):(t.__c=l=new er(b,m),l.constructor=g,l.render=yr),y&&y.sub(l),l.props=b,l.state||(l.state={}),l.context=m,l.__n=r,f=l.__d=!0,l.__h=[]),null==l.__s&&(l.__s=l.state),null!=g.getDerivedStateFromProps&&(l.__s==l.state&&(l.__s=Jn({},l.__s)),Jn(l.__s,g.getDerivedStateFromProps(b,l.__s))),d=l.props,h=l.state,f)null==g.getDerivedStateFromProps&&null!=l.componentWillMount&&l.componentWillMount(),null!=l.componentDidMount&&l.__h.push(l.componentDidMount);else{if(null==g.getDerivedStateFromProps&&b!==d&&null!=l.componentWillReceiveProps&&l.componentWillReceiveProps(b,m),!l.__e&&null!=l.shouldComponentUpdate&&!1===l.shouldComponentUpdate(b,l.__s,m)||t.__v===n.__v){l.props=b,l.state=l.__s,t.__v!==n.__v&&(l.__d=!1),l.__v=t,t.__e=n.__e,t.__k=n.__k,t.__k.forEach((function(e){e&&(e.__=t)})),l.__h.length&&s.push(l);break e}null!=l.componentWillUpdate&&l.componentWillUpdate(b,l.__s,m),null!=l.componentDidUpdate&&l.__h.push((function(){l.componentDidUpdate(d,h,p)}))}l.context=m,l.props=b,l.state=l.__s,(c=Mn.__r)&&c(t),l.__d=!1,l.__v=t,l.__P=e,c=l.render(l.props,l.state,l.context),l.state=l.__s,null!=l.getChildContext&&(r=Jn(Jn({},r),l.getChildContext())),f||null==l.getSnapshotBeforeUpdate||(p=l.getSnapshotBeforeUpdate(d,h)),_=null!=c&&c.type===Qn&&null==c.key?c.props.children:c,or(e,Array.isArray(_)?_:[_],t,n,r,i,o,s,u,a),l.base=t.__e,t.__h=null,l.__h.length&&s.push(l),v&&(l.__E=l.__=null),l.__e=!1}else null==o&&t.__v===n.__v?(t.__k=n.__k,t.__e=n.__e):t.__e=pr(n.__e,t,n,r,i,o,s,a);(c=Mn.diffed)&&c(t)}catch(e){t.__v=null,(a||null!=o)&&(t.__e=u,t.__h=!!a,o[o.indexOf(u)]=null),Mn.__e(e,t,n)}}function hr(e,t){Mn.__c&&Mn.__c(t,e),e.some((function(t){try{e=t.__h,t.__h=[],e.some((function(e){e.call(t)}))}catch(e){Mn.__e(e,t.__v)}}))}function pr(e,t,n,r,i,o,s,u){var a,c,l,f,d=n.props,h=t.props,p=t.type,v=0;if("svg"===p&&(i=!0),null!=o)for(;v<o.length;v++)if((a=o[v])&&(a===e||(p?a.localName==p:3==a.nodeType))){e=a,o[v]=null;break}if(null==e){if(null===p)return document.createTextNode(h);e=i?document.createElementNS("http://www.w3.org/2000/svg",p):document.createElement(p,h.is&&h),o=null,u=!1}if(null===p)d===h||u&&e.data===h||(e.data=h);else{if(o=o&&zn.slice.call(e.childNodes),c=(d=n.props||qn).dangerouslySetInnerHTML,l=h.dangerouslySetInnerHTML,!u){if(null!=o)for(d={},f=0;f<e.attributes.length;f++)d[e.attributes[f].name]=e.attributes[f].value;(l||c)&&(l&&(c&&l.__html==c.__html||l.__html===e.innerHTML)||(e.innerHTML=l&&l.__html||""))}if(function(e,t,n,r,i){var o;for(o in n)"children"===o||"key"===o||o in t||cr(e,o,null,n[o],r);for(o in t)i&&"function"!=typeof t[o]||"children"===o||"key"===o||"value"===o||"checked"===o||n[o]===t[o]||cr(e,o,t[o],n[o],r)}(e,h,d,i,u),l)t.__k=[];else if(v=t.props.children,or(e,Array.isArray(v)?v:[v],t,n,r,i&&"foreignObject"!==p,o,s,e.firstChild,u),null!=o)for(v=o.length;v--;)null!=o[v]&&Yn(o[v]);u||("value"in h&&void 0!==(v=h.value)&&(v!==e.value||"progress"===p&&!v)&&cr(e,"value",v,d.value,!1),"checked"in h&&void 0!==(v=h.checked)&&v!==e.checked&&cr(e,"checked",v,d.checked,!1))}return e}function vr(e,t,n){try{"function"==typeof e?e(t):e.current=t}catch(e){Mn.__e(e,n)}}function br(e,t,n){var r,i,o;if(Mn.unmount&&Mn.unmount(e),(r=e.ref)&&(r.current&&r.current!==e.__e||vr(r,null,t)),n||"function"==typeof e.type||(n=null!=(i=e.__e)),e.__e=e.__d=void 0,null!=(r=e.__c)){if(r.componentWillUnmount)try{r.componentWillUnmount()}catch(e){Mn.__e(e,t)}r.base=r.__P=null}if(r=e.__k)for(o=0;o<r.length;o++)r[o]&&br(r[o],t,n);null!=i&&Yn(i)}function yr(e,t,n){return this.constructor(e,n)}Mn={__e:function(e,t){for(var n,r,i;t=t.__;)if((n=t.__c)&&!n.__)try{if((r=n.constructor)&&null!=r.getDerivedStateFromError&&(n.setState(r.getDerivedStateFromError(e)),i=n.__d),null!=n.componentDidCatch&&(n.componentDidCatch(e),i=n.__d),i)return n.__E=n}catch(t){e=t}throw e},__v:0},er.prototype.setState=function(e,t){var n;n=null!=this.__s&&this.__s!==this.state?this.__s:this.__s=Jn({},this.state),"function"==typeof e&&(e=e(Jn({},n),this.props)),e&&Jn(n,e),null!=e&&this.__v&&(t&&this.__h.push(t),rr(this))},er.prototype.forceUpdate=function(e){this.__v&&(this.__e=!0,e&&this.__h.push(e),rr(this))},er.prototype.render=Qn,Hn=[],Kn="function"==typeof Promise?Promise.prototype.then.bind(Promise.resolve()):setTimeout,ir.__r=0;var mr={Error:{color:"red"},Alert:{error:{color:"red"},warning:{color:"yellow"},info:{color:"black"}},Darken:{position:"fixed",top:0,left:0,opacity:.5,backgroundColor:"#000",width:"100vw",height:"100vh",zIndex:150,webkitBackdropFilter:"blur(2px)",backdropFilter:"blur(2px)"},DialogOuter:{position:"fixed",top:0,left:0,width:"100vw",height:"100vh",zIndex:150,alignItems:"center",display:"flex",justifyContent:"center"},DialogInner:{position:"relative",color:"#222",backgroundColor:"#fff",padding:"30px",marginBottom:"2em",maxWidth:"90%",maxHeight:"90%",overflowY:"auto",border:"3px solid #3d3d5d",borderRadius:"8px",boxShadow:"0 0 80px 10px #666",width:"auto"},Input:{height:"35px",width:"17em",borderColor:"#ccf4",outline:"none",fontSize:"17pt",padding:"8px"}};function _r(e){var t=e.children;return Xn("div",null,Xn("div",{style:mr.Darken}),Xn("div",{style:mr.DialogOuter},Xn("div",{style:mr.DialogInner},t)))}var gr,wr,Sr,kr=0,Er=[],xr=Mn.__b,Ir=Mn.__r,Tr=Mn.diffed,Cr=Mn.__c,Ar=Mn.unmount;function Or(e,t){Mn.__h&&Mn.__h(wr,e,kr||t),kr=0;var n=wr.__H||(wr.__H={__:[],__h:[]});return e>=n.__.length&&n.__.push({}),n.__[e]}function Pr(e){return kr=1,function(e,t,n){var r=Or(gr++,2);return r.t=e,r.__c||(r.__=[n?n(t):$r(void 0,t),function(e){var t=r.t(r.__[0],e);r.__[0]!==t&&(r.__=[t,r.__[1]],r.__c.setState({}))}],r.__c=wr),r.__}($r,e)}function Ur(e){return kr=5,function(e,t){var n=Or(gr++,7);return Rr(n.__H,t)&&(n.__=e(),n.__H=t,n.__h=e),n.__}((function(){return{current:e}}),[])}function Dr(){Er.forEach((function(e){if(e.__P)try{e.__H.__h.forEach(jr),e.__H.__h.forEach(Lr),e.__H.__h=[]}catch(t){e.__H.__h=[],Mn.__e(t,e.__v)}})),Er=[]}Mn.__b=function(e){wr=null,xr&&xr(e)},Mn.__r=function(e){Ir&&Ir(e),gr=0;var t=(wr=e.__c).__H;t&&(t.__h.forEach(jr),t.__h.forEach(Lr),t.__h=[])},Mn.diffed=function(e){Tr&&Tr(e);var t=e.__c;t&&t.__H&&t.__H.__h.length&&(1!==Er.push(t)&&Sr===Mn.requestAnimationFrame||((Sr=Mn.requestAnimationFrame)||function(e){var t,n=function(){clearTimeout(r),Nr&&cancelAnimationFrame(t),setTimeout(e)},r=setTimeout(n,100);Nr&&(t=requestAnimationFrame(n))})(Dr)),wr=void 0},Mn.__c=function(e,t){t.some((function(e){try{e.__h.forEach(jr),e.__h=e.__h.filter((function(e){return!e.__||Lr(e)}))}catch(n){t.some((function(e){e.__h&&(e.__h=[])})),t=[],Mn.__e(n,e.__v)}})),Cr&&Cr(e,t)},Mn.unmount=function(e){Ar&&Ar(e);var t=e.__c;if(t&&t.__H)try{t.__H.__.forEach(jr)}catch(e){Mn.__e(e,t.__v)}};var Nr="function"==typeof requestAnimationFrame;function jr(e){var t=wr;"function"==typeof e.__c&&e.__c(),wr=t}function Lr(e){var t=wr;e.__c=e.__(),wr=t}function Rr(e,t){return!e||e.length!==t.length||t.some((function(t,n){return t!==e[n]}))}function $r(e,t){return"function"==typeof t?t(e):t}function Br(e){var t=e.title,n=e.alerts,r=e.fields,i=e.onCancel,o=e.onSubmit,s=Pr({}),u=s[0],a=s[1],c=Ur();return function(e,t){var n=Or(gr++,4);!Mn.__s&&Rr(n.__H,t)&&(n.__=e,n.__H=t,wr.__h.push(n))}((function(){var e;return null===(e=c.current)||void 0===e?void 0:e.focus()}),[]),Xn(_r,null,Xn(Qn,null,Xn("h3",{style:mr.WindowHeader},t),n.map((function(e){return Xn("p",{style:mr.Alert[e.type]},function(e){var t=e.message;e.messageCode;var n=e.messageParams;return t.replace(/\{\w+\}/gi,(function(e){return n[e.substr(1,e.length-2)]}))}(e))})),Xn("form",{onSubmit:function(e){e.preventDefault(),o(u)}},Object.entries(r).map((function(e,t){var n=e[0],r=e[1],i=r.type,o=r.label,s=r.placeholder;return Xn("label",{style:mr.Label},o?o+": ":"",Xn("input",{ref:0===t?c:void 0,type:i,name:n,autoComplete:"on",style:mr.Input,autoFocus:!0,placeholder:s,value:u[n]||"",onInput:function(e){var t,r;return a(f(f({},u),((t={})[n]=function(e,t){switch(e){case"email":return t.toLowerCase();case"otp":return t.toUpperCase();default:return t}}(i,null===(r=e.target)||void 0===r?void 0:r.value),t)))}}))})))),Xn("div",{style:mr.ButtonsDiv},Xn("button",{type:"submit",style:mr.Button,onClick:function(){return o(u)}},"Submit"),Xn("button",{style:mr.Button,onClick:i},"Cancel")))}var Wr=function(e){function t(t){var n=e.call(this,t)||this;return n.observer=function(e){return n.setState({userInteraction:e})},n.state={userInteraction:void 0},n}return l(t,e),t.prototype.componentDidMount=function(){this.subscription=s(this.props.db.cloud.userInteraction).subscribe(this.observer)},t.prototype.componentWillUnmount=function(){this.subscription&&(this.subscription.unsubscribe(),delete this.subscription)},t.prototype.render=function(e,t){var n=t.userInteraction;return n?Xn(Br,Object.assign({},n)):null},t}(er);function Fr(e){var t=document.createElement("div");document.body.appendChild(t),function(e,t,n){var r,i,o;Mn.__&&Mn.__(e,t),i=(r="function"==typeof n)?null:n&&n.__k||t.__k,o=[],dr(t,e=(!r&&n||t).__k=Xn(Qn,null,[e]),i||qn,qn,void 0!==t.ownerSVGElement,!r&&n?[n]:i?null:t.firstChild?zn.slice.call(t.childNodes):null,o,!r&&n?n:i?i.__e:t.firstChild,r),hr(o,e)}(Xn(Wr,{db:e.vip}),t);var n=!1;return{unsubscribe:function(){t.remove(),n=!0},get closed(){return n}}}function Mr(o){var u=this,a=o.name,c=new n(et),l=[],p=null;o.on("ready",(function(e){return d(u,void 0,void 0,(function(){var t;return h(this,(function(n){switch(n.label){case 0:return n.trys.push([0,2,,3]),[4,m(e)];case 1:return n.sent(),[3,3];case 2:return t=n.sent(),console.error(t),[3,3];case 3:return[2]}}))}))}),!0);var v,b=!1;function y(){if(b)throw new e.DatabaseClosedError}function m(n){return d(this,void 0,void 0,(function(){var o,u,a,v,m,_,g,w,S,k,E=this;return h(this,(function(x){switch(x.label){case 0:return b=!1,g=at(n),ht||((null===(o=g.cloud.options)||void 0===o?void 0:o.customLoginGui)||l.push(Fr(n)),l.push(g.syncStateChangedEvent.subscribe(n.cloud.syncState))),g.tables.every((function(e){return e.core}))||pt(),"serviceWorker"in navigator?[4,navigator.serviceWorker.getRegistrations()]:[3,2];case 1:return S=x.sent(),[3,3];case 2:S=[],x.label=3;case 3:return w=S,[4,g.transaction("rw",g.$syncState,(function(){return d(E,void 0,void 0,(function(){var e,t,n,r,i,o,s,u,a,c,l,d,p,v,b,y;return h(this,(function(h){switch(h.label){case 0:return n=g.cloud,r=n.options,i=n.schema,[4,Promise.all([g.getOptions(),g.getSchema(),g.getPersistedSyncState()])];case 1:return o=h.sent(),s=o[0],u=o[1],a=o[2],r?[3,2]:(g.cloud.options=s||null,[3,4]);case 2:return s&&JSON.stringify(s)===JSON.stringify(r)?[3,4]:[4,g.$syncState.put(r,"options")];case 3:h.sent(),h.label=4;case 4:return(null===(e=g.cloud.options)||void 0===e?void 0:e.tryUseServiceWorker)&&"serviceWorker"in navigator&&w.length>0&&!dt?(console.debug("Dexie Cloud Addon: Using service worker"),g.cloud.usingServiceWorker=!0):((null===(t=g.cloud.options)||void 0===t?void 0:t.tryUseServiceWorker)&&!ht&&console.debug("dexie-cloud-addon: Not using service worker.",0===w.length?"No SW registrations found.":"serviceWorker"in navigator&&dt?"Avoiding SW background sync and SW periodic bg sync for this browser due to browser bugs.":"navigator.serviceWorker not present"),g.cloud.usingServiceWorker=!1),Fn(i,g.cloud.options),Fn(u,g.cloud.options),i?[3,5]:(g.cloud.schema=u||null,[3,7]);case 5:if(u&&JSON.stringify(u)===JSON.stringify(i))return[3,7];for(c=u||{},l=0,d=Object.entries(i);l<d.length;l++)p=d[l],v=p[0],b=p[1],(y=c[v])?(y.markedForSync=b.markedForSync,b.deleted=y.deleted,y.generatedGlobalId=b.generatedGlobalId):c[v]=f({},b);return[4,g.$syncState.put(c,"schema")];case 6:h.sent(),Object.assign(i,c),h.label=7;case 7:return[2,null==a?void 0:a.initiallySynced]}}))}))}))];case 4:return(k=x.sent())&&g.setInitiallySynced(!0),function(t){for(var n,r,i=0,o=t.tables;i<o.length;i++){var s=o[i];if(null===(r=null===(n=t.cloud.schema)||void 0===n?void 0:n[s.name])||void 0===r?void 0:r.markedForSync){if(s.schema.primKey.auto)throw new e.SchemaError("Table "+s.name+" is both autoIncremented and synced. Use db.cloud.configure({unsyncedTables: ["+JSON.stringify(s.name)+"]}) to blacklist it from sync");if(!s.schema.primKey.keyPath)throw new e.SchemaError("Table "+s.name+" cannot be both synced and outbound. Use db.cloud.configure({unsyncedTables: ["+JSON.stringify(s.name)+"]}) to blacklist it from sync")}}}(g),!(null===(u=g.cloud.options)||void 0===u?void 0:u.databaseUrl)||k?[3,6]:[4,Cn(g,g.cloud.options,g.cloud.schema)];case 5:x.sent(),g.setInitiallySynced(!0),x.label=6;case 6:return y(),ht||(l.push(t((function(){return g.getCurrentUser()})).subscribe(c)),l.push(t((function(){return g.getPersistedSyncState()})).subscribe(g.cloud.persistedSyncState))),(null===(a=g.cloud.options)||void 0===a?void 0:a.requireAuth)?[4,Qe(g)]:[3,8];case 7:x.sent(),x.label=8;case 8:return p&&p.stop(),p=null,y(),g.cloud.usingServiceWorker&&(null===(v=g.cloud.options)||void 0===v?void 0:v.databaseUrl)?(Nt(g).catch((function(){})),function(e){return d(this,void 0,void 0,(function(){var t,n,r,i;return h(this,(function(o){switch(o.label){case 0:return o.trys.push([0,8,,9]),[4,navigator.serviceWorker.ready];case 1:if(!(n=o.sent().periodicSync))return[3,6];o.label=2;case 2:return o.trys.push([2,4,,5]),[4,n.register("dexie-cloud:"+e.name,null===(t=e.cloud.options)||void 0===t?void 0:t.periodicSync)];case 3:return o.sent(),console.debug("Dexie Cloud: Successfully registered periodicsync event for "+e.name),[3,5];case 4:return r=o.sent(),console.debug("Dexie Cloud: Failed to register periodic sync. Your PWA must be installed to allow background sync.",r),[3,5];case 5:return[3,7];case 6:console.debug("Dexie Cloud: periodicSync not supported."),o.label=7;case 7:return[3,9];case 8:return i=o.sent(),console.debug("Dexie Cloud: Could not register periodicSync for "+e.name,i),[3,9];case 9:return[2]}}))}))}(g).catch((function(){}))):(null===(m=g.cloud.options)||void 0===m?void 0:m.databaseUrl)&&g.cloud.schema&&!ht&&(p=Wn(g,g.cloud.options,g.cloud.schema)).start(),y(),ht||l.push(r(self,"online").subscribe((function(){console.debug("online!"),g.syncStateChangedEvent.next({phase:"not-in-sync"}),$n(g)})),r(self,"offline").subscribe((function(){console.debug("offline!"),g.syncStateChangedEvent.next({phase:"offline"})}))),"undefined"!=typeof window&&!ht&&(null===(_=g.cloud.options)||void 0===_?void 0:_.databaseUrl)&&l.push(function(e){var t,n=this;if(!(null===(t=e.cloud.options)||void 0===t?void 0:t.databaseUrl))throw new Error("No database URL to connect WebSocket to");return function t(){return An.pipe(we((function(e){return e})),Te((function(){return e.cloud.currentUser})),we((function(){var t,n;return null===(n=null===(t=e.cloud.persistedSyncState)||void 0===t?void 0:t.value)||void 0===n?void 0:n.serverRevision})),Te((function(t){var n,r;return new jn(e.cloud.options.databaseUrl,null===(r=null===(n=e.cloud.persistedSyncState)||void 0===n?void 0:n.value)||void 0===r?void 0:r.serverRevision,t.accessToken,t.accessTokenExpiration)})),te((function(n){return s(function(t){return d(this,void 0,void 0,(function(){var n,r;return h(this,(function(i){switch(i.label){case 0:return"TokenExpiredError"!==(null==t?void 0:t.name)?[3,3]:(console.debug("WebSocket observable: Token expired. Refreshing token..."),n=e.cloud.currentUser.value,[4,qe(e.cloud.options.databaseUrl,n)]);case 1:return r=i.sent(),[4,e.table("$logins").update(n.userId,{accessToken:r.accessToken,accessTokenExpiration:r.accessTokenExpiration})];case 2:return i.sent(),[3,4];case 3:throw console.error("WebSocket observable:",t),t;case 4:return[2]}}))}))}(n)).pipe(Te((function(){return t()})),te((function(e){return console.error("WebSocket observable: error but revive when user does some active thing...",e),i(!0).pipe(be(3e3),Te((function(){return Dn})),Ee(1),Te((function(){return t()})))})))})))}().subscribe((function(t){return d(n,void 0,void 0,(function(){var n,r,i;return h(this,(function(o){switch(o.label){case 0:return[4,e.getPersistedSyncState()];case 1:switch(i=o.sent(),t.type){case"rev":(!(null==i?void 0:i.serverRevision)||hn.compare(i.serverRevision,"undefined"==typeof BigInt?new hn(t.rev):BigInt(t.rev))<0)&&$n(e);break;case"realm-added":(null===(n=null==i?void 0:i.realms)||void 0===n?void 0:n.includes(t.realm))||$n(e);break;case"realm-removed":(null===(r=null==i?void 0:i.realms)||void 0===r?void 0:r.includes(t.realm))&&$n(e)}return[2]}}))}))}))}(g)),[2]}}))}))}!function(e,t){e.on.close.subscribe(t);var n=e.close;e.close=function(){n.call(this),t()}}(o,(function(){l.forEach((function(e){return e.unsubscribe()})),b=!0,p&&p.stop(),p=null,c.next(et)})),o.cloud={version:"1.0.0-beta.6",options:null,schema:null,serverState:null,get currentUserId(){return c.value.userId||et.userId},currentUser:c,syncState:new n({phase:"initial"}),persistedSyncState:new n(void 0),userInteraction:new n(void 0),login:function(e){return d(this,void 0,void 0,(function(){var t;return h(this,(function(n){switch(n.label){case 0:return[4,(t=at(o)).cloud.sync()];case 1:return n.sent(),[4,Qe(t,e)];case 2:return n.sent(),[2]}}))}))},configure:function(e){var t,n;o.cloud.options=e,e.databaseUrl&&(o.name=a+"-"+(t=e.databaseUrl,"/"===(n=new URL(t)).pathname?n.hostname.split(".")[0]:n.pathname.split("/")[1]),at(o).reconfigure()),Fn(o.cloud.schema,o.cloud.options)},sync:function(e){var n=void 0===e?{wait:!0,force:!1}:e,r=n.wait,i=n.force;return d(this,void 0,void 0,(function(){var e,n,u,a,c=this;return h(this,(function(l){switch(l.label){case 0:return void 0===r&&(r=!0),e=at(o),i?(n=e.cloud.persistedSyncState.value,$n(e),r?[4,e.cloud.persistedSyncState.pipe(we((function(e){return null!=(null==e?void 0:e.timestamp)&&(!n||e.timestamp>n.timestamp)})),Ee(1)).toPromise()]:[3,2]):[3,3];case 1:if(null==(u=l.sent())?void 0:u.error)throw new Error("Sync error: "+u.error);l.label=2;case 2:return[3,6];case 3:return[4,Bn(e)];case 4:return l.sent()?(a=e.cloud.persistedSyncState.value,$n(e),r?(console.debug("db.cloud.login() is waiting for sync completion..."),[4,s(t((function(){return d(c,void 0,void 0,(function(){var t,n;return h(this,(function(r){switch(r.label){case 0:return[4,Bn(e)];case 1:return t=r.sent(),[4,e.getPersistedSyncState()];case 2:if((null==(n=r.sent())?void 0:n.timestamp)!==(null==a?void 0:a.timestamp)&&(null==n?void 0:n.error))throw new Error("Sync error: "+n.error);return[2,t]}}))}))}))).pipe(we((function(e){return!e})),Ee(1)).toPromise()]):[3,6]):[3,6];case 5:l.sent(),console.debug("Done waiting for sync completion because we have nothing to push anymore"),l.label=6;case 6:return[2]}}))}))}},o.Version.prototype._parseStoresSpec=e.override(o.Version.prototype._parseStoresSpec,(function(e){return Rt(e,o)})),o.use(Lt({currentUserObservable:o.cloud.currentUser,db:at(o)})),o.use((v=at(o),{stack:"dbcore",name:"implicitPropSetterMiddleware",level:1,create:function(e){return f(f({},e),{table:function(t){var n=e.table(t);return f(f({},n),{mutate:function(e){var r,i,o,s=e.trans;if((null===(i=null===(r=v.cloud.schema)||void 0===r?void 0:r[t])||void 0===i?void 0:i.markedForSync)&&(null===(o=s.currentUser)||void 0===o?void 0:o.isLoggedIn)&&("add"===e.type||"put"===e.type))for(var u=0,a=e.values;u<a.length;u++){var c=a[u];"owner"in c||(c.owner=s.currentUser.userId),"realmId"in c||(c.realmId=s.currentUser.userId)}return n.mutate(e)}})}})}})),o.use(Tt(at(o)))}Mr.version="1.0.0-beta.6",e.Cloud=Mr;export default Mr;export{Mr as dexieCloud};